<html lang='en'>
<head><meta charset='utf-8'>
<title>mods CE</title>
<link rel="icon" href="https://modsproject.org/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="https://modsproject.org/style.css" />
</head>
<body>
<script>
//
// mods.js
//
// Neil Gershenfeld
// (c) Massachusetts Institute of Technology 2018
// Modified by: Francisco Sanchez at The Beach Lab 2023
//            : xytaz                          Mar-2020
//
// This work may be reproduced, modified, distributed, performed, and
// displayed for any purpose, but must acknowledge the mods
// project. Copyright is retained and must be preserved. The work is
// provided as is; no warranty is provided, and users accept all
// liability.
//
// closure
//
(function() {
    //
    // globals
    //
    var mods = {}
    mods.theme = {}
    mods.mod = {}
    mods.globals = {}
    mods.ui = {
        source: null,
        progname: '',
        border: 0,
        borderRadius: '0px',
        padding: 7,
        bezier: 100,
        canvas: 250,
        rows: 5,
        cols: 20,
        link_color: 'rgb(43, 202, 255)',
        link_highlight: 'rgb(255,0,0)',
        link_stroke_with: 5,
        selected_link: null,
        header: 50,
        selected: {},
        mousedown: null,
        menu: null,
        top: null,
        left: null,
        xstart: null,
        ystart: null,
        xtrans: null,
        ytrans: null,
        maxzoom: 2.5, // sets how much you can zoom in
        minzoom: 0.3,  // sets how much you can zoom out
    }
    mods.darktheme = {
        status: "dark",
        background: "rgb(51, 51, 51)",
        text: "white",
        link: "white",
        alink: "white",
        vlink: "white",
        logodot: "white",
        logorect: "white"
    }
    mods.lighttheme = {
        status: "light",
        background: "rgb(255, 255, 255)",
        //backgroundImage: "url('./plus.svg')", // texture background
        text: "black",
        link: "black",
        alink: "black",
        vlink: "black",
        logodot: "red",
        logorect: "blue"
    }
    //
    // set theme
    //
    mods.theme = mods.lighttheme
    //
    // check version function
    //
    function check_version() {
	// is the online version?
        var thisUrl = window.location.href
        console.log(thisUrl.slice(0,23))
        if (thisUrl.slice(0, 23) == 'https://modsproject.org') {
            console.log('running mods online')
            set_version('')
        } else {
            console.log('running local mods')
            // we check the local version
	    var localVersion
	    var onlineVersion  
            fetch('./version', {
	    	cache: "no-store",
	    })
                .then(function(response) {
                    response.text().then(function(text) {
                        localVersion = text;
                        console.log('local version: ' + localVersion)
            // now we check the online version.
	    fetch('https://modsproject.org/version', {
		    cache: "no-store",
                             })
                             .then(function(response) {
				     response.text()
				     .then(function(text) {
                                        onlineVersion = text;
                                        console.log('online version: ' + onlineVersion)
                                        // now we compare both
                                        if (parseInt(localVersion) < parseInt(onlineVersion)) {
                                            set_version('outdated local mods, please git pull.')
                                        } else console.log('mods up to date')
                                    });
                            })
                            .catch(function() {
                                console.log('error getting the online version')
                            })
                    });
                });

        } // end else
    } // end check_version

    //
    // Oscillator for beeps
    //
    function beep(duration, frequency, volume, type, callback) {
        // Init audio for beeps
        var audioCtx = new (window.AudioContext || window.webkitAudioContext || window.audioContext);
        //All arguments are optional:
        //duration of the tone in milliseconds. Default is 500
        //frequency of the tone in hertz. default is 440
        //volume of the tone. Default is 1, off is 0.
        //type of tone. Possible values are sine, square, sawtooth, triangle, and custom. Default is sine.
        //callback to use on end of tone
        var oscillator = audioCtx.createOscillator();
        var gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        if (volume){gainNode.gain.value = volume;}
        if (frequency){oscillator.frequency.value = frequency;}
        if (type){oscillator.type = type;}
        if (callback){oscillator.onended = callback;}
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + ((duration || 500) / 1000));
    };


    //
    // Global key listeners
    //
    window.addEventListener('keydown', function(e) {
        //
        // Home 'Ctrl+h'
        //
        if (e.key == 'h' && e.ctrlKey) { 
            home()
        }
        //
        // Home 'Ctrl+a'
        //
        if (e.key == 'a' && e.ctrlKey) { 
            select_all()
        }
        //
        // Zoom Extents 'Ctrl+e'
        //
        if (e.key == 'e' && e.ctrlKey) { 
            zoom_extents()
        }
        //
        // Toggle Dark Mode 'Ctrl+d'
        //
        if (e.key == 'd' && e.ctrlKey) { //  tofix why evt.altKey is not detected in option key macOS?
            if (mods.theme == mods.lighttheme) {
                mods.theme = mods.darktheme
            } else if (mods.theme == mods.darktheme) {
                mods.theme = mods.lighttheme
            }
            // change body colors
            document.body.style.backgroundColor = mods.theme.background
            document.body.aLink = mods.theme.alink
            document.body.link = mods.theme.link
            document.body.vLink = mods.theme.vlink
            // change the color of the prompt
            var div = document.getElementById('prompt')
            div.style.color = mods.theme.text
            // change the color of the links
            var svg = document.getElementById('svg')
            var links = svg.getElementById('links') // an array of links
            for (var l = 0; l < links.childNodes.length; ++l) {
                var link = links.childNodes[l] // for every link
                var path = link.childNodes[0] // get the bottom path
                // change the color of the bottom path
                path.setAttribute('stroke', mods.theme.background)
            }
    
        }
        //
        // listen for ESC key to cancel link creation or unselect a selected link
        //
        if (e.key == 'Escape') {
            if (mods.ui.source != null) { // we are creating a link
                // clear source and exit
                delete_temp_link()
                mods.ui.source = null
                set_prompt('add link canceled')
            }
            if (mods.ui.selected_link != null) { // a link is selected
                // get the link
                var link = mods.ui.selected_link
                // redraw it solid and flag unselected link
                draw_link(link, mods.ui.link_color)
                mods.ui.selected_link = null
                set_prompt('')
            }
    
        }
        //
        // listen for DEL key to delete a selected link
        //
        if (e.key === "Backspace" || e.key === "Delete") {
            if (mods.ui.selected_link != null) { // a link is selected
                // get the link
                var link = mods.ui.selected_link
                // delete it solid (the delete function clears flags selected_link)
                delete_link(link)
                set_prompt('Link deleted')
            }
    
        }
    })

    //
    // Initial UI Theme
    //
    document.body.style.backgroundColor = mods.theme.background
    document.body.aLink = mods.theme.alink
    document.body.link = mods.theme.link
    document.body.vLink = mods.theme.vlink

    //
    // Select all modules function
    //
    function select_all() {
        var modules = document.getElementById('modules')
        mods.ui.selected = {}
        for (var module in modules.childNodes) {
            var container = modules.childNodes[module]
            var id = container.id
            if (id != undefined) {
                var name = container.firstChild
                name.style.fontWeight = "bold"
                mods.ui.selected[id] = true
            }
        }
    }

    //
    // Move to origin and zoom to extents function (overengineered?)
    //
    function zoom_extents() {
        document.body.style.transform = 'scale(1) translate(0px,-'+mods.ui.header+'px)'
        document.body.style.transformOrigin = '0px 0px'
        // reset selection
        mods.ui.selected = {}
        // reset bounding box coordinates
        var north = null
        var south = null
        var east = null
        var west = null
        // Get the modules
        var modules = document.getElementById('modules')
        // iterate through the modules to find the bounding box coordinates
        for (var module in modules.childNodes) {
            var container = modules.childNodes[module]
            var id = container.id
            if (id != undefined) {
                if (north == null) { north = parseFloat(container.childNodes[0].getBoundingClientRect().top)} // childnodes: divname, divctrl, divint, divin, divout
                else {north = Math.min(parseFloat(container.childNodes[0].getBoundingClientRect().top),north)}
                if (east == null) { east = parseFloat(container.childNodes[3].getBoundingClientRect().left)}
                else {east = Math.min(parseFloat(container.childNodes[3].getBoundingClientRect().left),east)}
                if (west == null) { west = parseFloat(container.childNodes[4].getBoundingClientRect().right)}
                else {west = Math.max(parseFloat(container.childNodes[4].getBoundingClientRect().right),west)}
                if (south == null) { south = parseFloat(container.childNodes[4].getBoundingClientRect().bottom)}
                else {south = Math.max(parseFloat(container.childNodes[4].getBoundingClientRect().bottom),south)}
                // mark the module as selected to move it later
                mods.ui.selected[id] = true
            }
        }
        //
        // calculate the transform
        //
        // get the size of the bounding box
        var w = west - east
        var h = south - north
        // get the available space
        var page_w = window.innerWidth
        var page_h = window.innerHeight
        // calculate the scale that fits all the modules
        var scale_h = page_w / w
        var scale_v = page_h / h
        var scale = Math.min(scale_h,scale_v)
        // calculate dx, dy to move all modules to origin
        var t = mods_transform()
        var dx =  - east / t.s
        var dy =  - north / t.s
        // move the modules to origin
        for (var id in mods.ui.selected) {  // move the modules marked as selected 
            var div = document.getElementById(id)
            var newleft = parseFloat(div.dataset.left) + dx
            var newtop = parseFloat(div.dataset.top) + dy
            // here is the actual move, setting the left and top of the div
            div.style.left = newleft + 'px'
            div.style.top = newtop + 'px'
            // set the changes in the div dataset //todo: why do we have to manually store the position?
            div.dataset.left = newleft
            div.dataset.top = newtop
            draw_links(id, mods.ui.link_color)
        }
        // scale to fit
        document.body.style.transform = 'scale(' + scale + ',' + scale + ') translate(0px,0px)'
        // deselect all
        mods.ui.selected = {}
    }

    function mods_transform() { // returns the current transform parameters, scale, translation, origin
        var transform = document.body.style.transform
        var m = new DOMMatrix(getComputedStyle(document.body).transform)
        var s = m.m11
        var tx = m.m41 / s
        var ty = m.m42 / s
        var origin = document.body.style.transformOrigin
        var pxx = origin.indexOf('px')
        var ox = parseFloat(origin.slice(0, pxx))
        var pxy = origin.indexOf('px', pxx + 2)
        var oy = parseFloat(origin.slice(pxx + 2, pxy))
        return ({
            s: s,
            tx: tx,
            ty: ty,
            ox: ox,
            oy: oy
        })
    }
    //
    // Set initial transformation
    //
    function home() {
        document.body.style.transform = 'scale(1) translate(0px,0px)'
        document.body.style.transformOrigin = '0px 0px'
    }
    home()
    //
    // scroll wheel event
    //
    window.addEventListener('wheel', function(evt) {
        /*
        (xw+tx-ox)*s+ox = xs
        xw = ox-tx+(xs-ox)/s
        (xw+tx0-ox0)*s+ox0  = (xw+tx1-ox1)*s+ox1
        (tx0-ox0)*s+ox0  = (tx1-ox1)*s+ox1
        tx0+(ox1-ox0)+(ox0-ox1)/s  = tx1
        tx0+(ox1-ox0)*(1-1/s)  = tx1
        */
        var elem = document.elementFromPoint(evt.pageX, evt.pageY) // store where you are using the wheel
        //if ((el.tagName == "HTML") || (el.tagName == "BODY")) { // scroll works in the white area
        if (!([...document.querySelectorAll('.context-menu')].some(el => el == elem || el.contains(elem)))) { // scroll works unless in the context menu
            set_prompt('scroll to zoom')
            //evt.preventDefault() //
            evt.stopPropagation() // prevents default scroll action
            var t = mods_transform()
            if (evt.deltaY > 0) {
                // scrolling down
                if (evt.deltaY > 100) {
                    // console.log("Scrolling down with mouse");
                    if (t.s < mods.ui.maxzoom)
                    var scale = t.s * 1.1 // sets how fast scales for mouse
                  } else {
                    // console.log("Scrolling down with trackpad");
                    if (t.s < mods.ui.maxzoom)
                    var scale = t.s * 1.02 // sets how fast scales for trackpad
                  }
            } else {
                // scrolling up
                if (evt.deltaY < -100) {
                    // console.log("Scrolling up with mouse");
                    if (t.s > mods.ui.minzoom)
                    var scale = t.s * 0.9 // sets how fast scales for mouse
                  } else {
                    // console.log("Scrolling with up trackpad");
                    if (t.s > mods.ui.minzoom)
                    var scale = t.s * 0.98 // sets how fast scales for trackpad
                  }
            }
            var tx = t.tx + (evt.pageX - t.ox) * (1 - 1 / t.s)
            var ty = t.ty + (evt.pageY - t.oy) * (1 - 1 / t.s)
            document.body.style.transform = `scale(${scale}) translate(${tx}px,${ty}px)`
            document.body.style.transformOrigin = `${evt.pageX}px ${evt.pageY}px`
        }
    })
    //
    // body mouse events
    //
    window.addEventListener('mousedown', function(evt) {
        //
        // get element mouse is over
        //
        var el = document.elementFromPoint(evt.pageX, evt.pageY)
        //
        // check if on body
        //
        if ((el.tagName == "HTML") || (el.tagName == "BODY")) { 
        //if ((el.tagName == "HTML") || (el.tagName == "BODY") || (el.tagName == "svg")) { // pan from svg canvas also
            //
            // remember button
            //
            mods.ui.mousedown = evt.button
            if (mods.ui.mousedown == 0) {
                set_prompt('left-drag to pan, middle-drag to select, Ctrl+d to toggle dark mode')
                if (mods.ui.menu != null) {
                    document.body.removeChild(mods.ui.menu)
                    mods.ui.menu = null
                }
            } else if (mods.ui.mousedown == 2) {
                set_prompt('menu; left-drag to pan, middle-drag to select')
            }
            //
            // remember position
            //
            var t = mods_transform()
            mods.ui.xstart = evt.pageX
            mods.ui.ystart = evt.pageY
            mods.ui.xtrans = t.tx
            mods.ui.ytrans = t.ty
        }
    })
    window.addEventListener('mousemove', function(evt) {
        //
        // mouse move
        //
        if (mods.ui.mousedown != null) {
            evt.preventDefault()
            evt.stopPropagation()
            var t = mods_transform()
            if (mods.ui.mousedown == 0) {
                //
                // pan on left drag
                //
                xtrans = mods.ui.xtrans + (evt.pageX - mods.ui.xstart) / t.s
                ytrans = mods.ui.ytrans + (evt.pageY - mods.ui.ystart) / t.s
                document.body.style.transform = `scale(${t.s}) translate(${xtrans}px,${ytrans}px)`
            } else if (mods.ui.mousedown == 1) {
                //
                // select on middle drag
                //
                var rect = document.getElementById('svgrect')
                if (rect == undefined) {
                    //
                    // start dragging
                    //
                    if (mods.ui.menu != null) {
                        document.body.removeChild(mods.ui.menu)
                        mods.ui.menu = null
                    }
                    set_prompt('middle-drag to select')
                    var t = mods_transform()
                    var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect')
                    rect.setAttribute('id', 'svgrect')
                    rect.setAttribute('x', t.ox - t.tx + (evt.pageX - t.ox) / t.s)
                    rect.setAttribute('y', t.oy - t.ty + (evt.pageY - t.oy) / t.s - mods.ui.header)
                    rect.setAttribute('width', 0)
                    rect.setAttribute('height', 0)
                    rect.setAttribute('fill', 'rgb(200,200,200)')
                    rect.setAttribute('stroke', 'none')
                    var svg = document.getElementById('svg')
                    svg.insertBefore(rect, svg.firstChild)
                } else {
                    //
                    // continue dragging
                    //
                    var rect = document.getElementById('svgrect')
                    var xp = t.ox - t.tx + (mods.ui.xstart - t.ox) / t.s
                    var yp = t.oy - t.ty + (mods.ui.ystart - t.oy) / t.s - mods.ui.header
                    var xw = t.ox - t.tx + (evt.pageX - t.ox) / t.s
                    var yw = t.oy - t.ty + (evt.pageY - t.oy) / t.s - mods.ui.header
                    if (xw < xp) {
                        rect.setAttribute('x', xw)
                        rect.setAttribute('width', xp - xw)
                    } else
                        rect.setAttribute('width', xw - xp)
                    if (yw < yp) {
                        rect.setAttribute('y', yw)
                        rect.setAttribute('height', yp - yw)
                    } else
                        rect.setAttribute('height', yw - yp)
                }
            }
        }
    })
    window.addEventListener('mouseup', function(evt) {
        //
        // mouse up
        //
        mods.ui.mousedown = null
        //
        // check for selection rectangle
        //
        var rect = document.getElementById('svgrect')
        if (rect != null) {
            //
            // rectangle exists, selecting modules
            //
            var x = parseFloat(rect.getAttribute('x'))
            var y = parseFloat(rect.getAttribute('y'))
            var width = parseFloat(rect.getAttribute('width'))
            var height = parseFloat(rect.getAttribute('height'))
            svg.removeChild(rect)
            var modules = document.getElementById('modules')
            //
            // loop to find selected modules
            //
            mods.ui.selected = {}
            for (var module in modules.childNodes) {
                var container = modules.childNodes[module]
                var id = container.id
                if (id != undefined) {
                    var name = container.firstChild // 5 childs divname,divctrl,divint,divin,divout
                    var left = parseFloat(container.dataset.left)
                    var top = parseFloat(container.dataset.top)
                    if ((x <= left) && (left <= x + width) && (y <= top) && (top <= y + height)) {
                        //
                        // module is in selection rectangle
                        //
                        name.style.fontWeight = "bold"
                        mods.ui.selected[id] = true
                    } else {
                        //
                        // module is not in selection rectangle
                        //
                        name.style.fontWeight = "normal"
                    }
                }
            }
        }
    })
    //
    // context menu
    //
    window.addEventListener('contextmenu', contextmenu)
    window.addEventListener('touchstart', function (e) {
        if (e.touches.length > 2) {
            contextmenu(e)
        }
    })
    
    function contextmenu(evt) {
        //var el = document.elementFromPoint(evt.pageX,evt.pageY)
        //if ((el.tagName == "HTML") || (el.tagName == "BODY")) { // context menu in white area
        if (true) { // context menu everywhere
            evt.stopPropagation()
            evt.preventDefault()
            if (mods.ui.menu != null) {
                document.body.removeChild(mods.ui.menu)
                mods.ui.menu = null
            }
            var div = document.createElement('div')
            make_menu(div)
            add_menu(div, 'modules', modules)
            add_menu(div, 'programs', programs)
            add_menu(div, 'edit', edit)
            add_menu(div, 'options', options)
            document.body.appendChild(div)

            function make_menu(div) {
                div.className = "context-menu"
                mods.ui.menu = div
                div.style.position = "absolute"
                var t = mods_transform()
                div.style.top = t.oy - t.ty + (evt.pageY - t.oy) / t.s
                div.style.left = t.ox - t.tx + (evt.pageX - t.ox) / t.s
                div.style.zIndex = 0
                div.style.cursor = 'default'
                div.style.backgroundColor = "rgb(69, 212, 255)"
                div.style.padding = 1.5 * mods.ui.padding
                div.style.textAlign = 'left'
                div.style.border = mods.ui.border + 'px solid'
                div.style.borderRadius = mods.ui.borderRadius
            }

            function add_menu(div, text, click) {
                var textdiv = document.createElement('div')
                textdiv.appendChild(document.createTextNode(text))
                textdiv.appendChild(document.createElement('br'))
                textdiv.addEventListener('mouseover', function(evt) {
                    evt.target.style.fontWeight = 'bold'
                })
                textdiv.addEventListener('mouseout', function(evt) {
                    evt.target.style.fontWeight = 'normal'
                })
                textdiv.addEventListener('mousedown', click)
                textdiv.addEventListener('touchend', click)
                div.appendChild(textdiv)
            }
            //
            // modules menu
            //
            function modules(evt) {
                evt.preventDefault()
                evt.stopPropagation()
                document.body.removeChild(evt.target.parentNode)
                var div = document.createElement('div')
                make_menu(div)
                set_prompt('modules')
                //
                // open module
                //
                add_menu(div, 'add module', function(evt) {
                    function module_label(label) {
                        var div = document.createElement('div')
                        var b = document.createElement('b')
                        b.appendChild(document.createTextNode(label))
                        div.appendChild(b)
                        div.appendChild(document.createElement('br'))
                        menu.appendChild(div)
                    }

                    function module_menu(label, module) {
                        var div = document.createElement('div')
                        div.appendChild(
                            document.createTextNode('\u00A0\u00A0\u00A0' + label))
                        div.addEventListener('mouseover', function(evt) {
                            evt.target.style.backgroundColor = 'yellow'
                        })
                        div.addEventListener('mouseout', function(evt) {
                            evt.target.style.backgroundColor = 'transparent'
                        })
                        div.addEventListener('mousedown', function(evt) {
                            evt.preventDefault()
                            evt.stopPropagation()
                            document.body.removeChild(evt.target.parentNode)
                            mods.ui.menu = null
                            var t = mods_transform()
                            mod_message_handler(module,
                                t.oy - t.ty + (evt.pageY - t.oy) / t.s,
                                t.ox - t.tx + (evt.pageX - t.ox) / t.s)
                        })
                        div.appendChild(document.createElement('br'))
                        menu.appendChild(div)
                    }
                    document.body.removeChild(evt.target.parentNode)
                    var menu = document.createElement('div')
                    make_menu(menu)
                    document.body.appendChild(menu)
                    menu.style.width = mods.ui.canvas
                    menu.style.height = 1.5*mods.ui.canvas // bigger menu, less scroll
                    // Full height menu
                    // Math.max( document.body.scrollHeight, document.body.offsetHeight, 
                    //     document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight );
                    // menu.style.top = ??
                    menu.style.overflow = 'auto'
                    var req = new XMLHttpRequest()
                    req.responseType = 'text'
                    req.onreadystatechange = function() {
                        if (req.readyState == XMLHttpRequest.DONE) {
                            var str = req.response
                            eval(str)
                        }
                    }
                    req.open('GET', 'modules/index.js' + '?rnd=' + Math.random())
                    req.send()
                })
                //
                // open local module
                //
                add_menu(div, 'add module from file', function(evt) {
                    var t = mods_transform()
                    mods.ui.top = t.oy - t.ty + (evt.pageY - t.oy) / t.s
                    mods.ui.left = t.ox - t.tx + (evt.pageX - t.ox) / t.s
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    var file = document.getElementById('mod_input')
                    file.value = null
                    file.click()
                })
                //
                // open remote module
                //
                //         add_menu(div, 'open remote module', function (evt) {
                //            document.body.removeChild(evt.target.parentNode)
                //            mods.ui.menu = null
                //            set_prompt('remotes not yet implemented')
                //         })
                document.body.appendChild(div)
            }
            //
            // programs menu
            //
            function programs(evt) {
                evt.preventDefault()
                evt.stopPropagation()
                document.body.removeChild(evt.target.parentNode)
                var div = document.createElement('div')
                make_menu(div)
                set_prompt('programs')
                //
                // open local program
                //
                add_menu(div, 'open program from file', function(evt) {
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    var file = document.getElementById('prog_input')
                    file.value = null
                    file.click()
                })
                //
                // open server program
                //
                add_menu(div, 'open program', function(evt) {
                    function program_label(label) {
                        var div = document.createElement('div')
                        var i = document.createElement('b')
                        i.appendChild(document.createTextNode(label))
                        div.appendChild(i)
                        div.appendChild(document.createElement('br'))
                        menu.appendChild(div)
                    }

                    function program_menu(label, program) {
                        var div = document.createElement('div')
                        div.appendChild(
                            document.createTextNode('\u00A0\u00A0\u00A0' + label))
                        div.addEventListener('mouseover', function(evt) {
                            evt.target.style.backgroundColor = 'yellow'
                        })
                        div.addEventListener('mouseout', function(evt) {
                            evt.target.style.backgroundColor = 'transparent'
                        })
                        div.addEventListener('mousedown', function(evt) {
                            evt.preventDefault()
                            evt.stopPropagation()
                            if (location.port == 443)
                                var uri = 'https://' + location.hostname +
                                    '?program=' + program
                            else
                                var uri = 'http://' + location.hostname + ':' +
                                    location.port + '?program=' + program
                            set_prompt('<a href=' + uri + '>program link</a>')
                            prog_message_handler(program)
                            document.body.removeChild(evt.target.parentNode)
                            mods.ui.menu = null
                        })
                        div.appendChild(document.createElement('br'))
                        menu.appendChild(div)
                    }
                    document.body.removeChild(evt.target.parentNode)
                    var menu = document.createElement('div')
                    make_menu(menu)
                    document.body.appendChild(menu)
                    menu.style.width = mods.ui.canvas
                    menu.style.height = 1.5*mods.ui.canvas // bigger menu, less scroll
                    menu.style.overflow = 'auto'
                    var req = new XMLHttpRequest()
                    req.responseType = 'text'
                    req.onreadystatechange = function() {
                        if (req.readyState == XMLHttpRequest.DONE) {
                            var str = req.response
                            eval(str)
                        }
                    }
                    req.open('GET', 'programs/index.js' + '?rnd=' + Math.random())
                    req.send()
                })
                //
                // open remote program
                //
                //         add_menu(div, 'open remote program', function (evt) {
                //            document.body.removeChild(evt.target.parentNode)
                //            mods.ui.menu = null
                //            set_prompt('remotes not yet implemented')
                //         })
                //
                // save local program
                //
                add_menu(div, 'save program to file', function(evt) {
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    save_program()
                })
                //
                // save local page
                //
                add_menu(div, 'save html page', function(evt) {
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    save_page()
                })
                document.body.appendChild(div)
            }
            //
            // edit menu
            //
            function edit(evt) {
                evt.preventDefault()
                evt.stopPropagation()
                document.body.removeChild(evt.target.parentNode)
                var div = document.createElement('div')
                make_menu(div)
                set_prompt('edit')
                //
                // cut
                //
                add_menu(div, 'cut', function(evt) {
                    evt.preventDefault()
                    evt.stopPropagation()
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    if ((Object.keys(mods.ui.selected).length) == 0) {
                        set_prompt("nothing selected")
                    } else {
                        for (var id in mods.ui.selected) {
                            var div = document.getElementById(id)
                            delete_module(id)
                            mods.ui.selected = {}
                        }
                    }
                })
                //
                // copy
                //
                add_menu(div, 'copy', function(evt) {
                    evt.preventDefault()
                    evt.stopPropagation()
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    set_prompt('copy not yet implemented')
                })
                //
                // paste
                //
                add_menu(div, 'paste', function(evt) {
                    evt.preventDefault()
                    evt.stopPropagation()
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    set_prompt('paste not yet implemented')
                })
                document.body.appendChild(div)
            }
            //
            // options menu
            //
            function options(evt) {
                evt.preventDefault()
                evt.stopPropagation()
                document.body.removeChild(evt.target.parentNode)
                mods.ui.menu = null
                var div = document.createElement('div')
                make_menu(div)
                set_prompt('options')
                //
                // view files
                //
                add_menu(div, 'view local files', function(evt) {
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    var win = window.open('files.html')
                })
                document.body.appendChild(div)
                //
                // view original project
                //
                add_menu(div, 'view mods CBA project', function(evt) {
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    var win = window.open('https://gitlab.cba.mit.edu/pub/mods')
                })
                document.body.appendChild(div)
                //
                // view forked project
                //
                add_menu(div, 'view mods CE project', function(evt) {
                    document.body.removeChild(evt.target.parentNode)
                    mods.ui.menu = null
                    var win = window.open('https://gitlab.fabcloud.org/pub/project/mods')
                })
                document.body.appendChild(div)
            }
        }
    }
    //
    // prompt (TODO Move to header or footer, where always visible)
    //
    //spacer
    document.body.appendChild(document.createTextNode(' '))
    // logo span
    var span = document.createElement('span')
    span.setAttribute('id', 'logo')
    span.style.display = 'inline-block'
    span.style.verticalAlign = 'middle'
    span.style.width = 20
    span.style.height = 20
    span.style.padding = mods.ui.padding
    span.appendChild(logo(1))
    document.body.appendChild(span)
    // spacer
    document.body.appendChild(document.createTextNode(' '))
    // version span
    var span = document.createElement('span')
    span.setAttribute('id', 'version')
    span.style.display = 'inline-block'
    span.style.verticalAlign = 'middle'
    var innerspan = document.createElement('span')
    span.appendChild(innerspan)
    document.body.appendChild(span)
    // spacer
    document.body.appendChild(document.createTextNode(' '))
    // prompt span
    var span = document.createElement('span')
    span.setAttribute('id', 'prompt')
    span.style.display = 'inline-block'
    span.style.verticalAlign = 'middle'
    var innerspan = document.createElement('span')
    span.appendChild(innerspan)
    document.body.appendChild(span)
    //
    // Logo (Neil's style of making a logo)
    //
    function logo(size) {
        var x = 0
        var y = 2.8 * size / 3.8
        var svgNS = "http://www.w3.org/2000/svg"
        var logo = document.createElementNS(svgNS, "svg")
        logo.setAttributeNS("http://www.w3.org/2000/xmlns/",
            "xmlns:xlink", "http://www.w3.org/1999/xlink")
        logo.setAttributeNS(null, 'viewBox', "0 0 " + size + " " + size)
        var new_rect = document.createElementNS(svgNS, "rect");
        new_rect.setAttribute("width", size / 3.8)
        new_rect.setAttribute("height", size / 3.8)
        new_rect.setAttribute("x", x)
        new_rect.setAttribute("y", y)
        new_rect.setAttribute("fill", mods.theme.logorect)
        logo.appendChild(new_rect)
        var new_rect = document.createElementNS(svgNS, "rect");
        new_rect.setAttribute("width", size / 3.8)
        new_rect.setAttribute("height", size / 3.8)
        new_rect.setAttribute("x", x + 1.4 * size / 3.8)
        new_rect.setAttribute("y", y)
        new_rect.setAttribute("fill", "blue")
        logo.appendChild(new_rect)
        var new_rect = document.createElementNS(svgNS, "rect");
        new_rect.setAttribute("width", size / 3.8)
        new_rect.setAttribute("height", size / 3.8)
        new_rect.setAttribute("x", x + 2.8 * size / 3.8)
        new_rect.setAttribute("y", y)
        new_rect.setAttribute("fill", "blue")
        logo.appendChild(new_rect)
        var new_rect = document.createElementNS(svgNS, "rect");
        new_rect.setAttribute("width", size / 3.8)
        new_rect.setAttribute("height", size / 3.8)
        new_rect.setAttribute("x", x)
        new_rect.setAttribute("y", y - 1.4 * size / 3.8)
        new_rect.setAttribute("fill", "blue")
        logo.appendChild(new_rect)
        var new_rect = document.createElementNS(svgNS, "rect");
        new_rect.setAttribute("width", size / 3.8)
        new_rect.setAttribute("height", size / 3.8)
        new_rect.setAttribute("x", x + 2.8 * size / 3.8)
        new_rect.setAttribute("y", y - 1.4 * size / 3.8)
        new_rect.setAttribute("fill", "blue")
        logo.appendChild(new_rect)
        var new_rect = document.createElementNS(svgNS, "rect");
        new_rect.setAttribute("width", size / 3.8)
        new_rect.setAttribute("height", size / 3.8)
        new_rect.setAttribute("x", x + 1.4 * size / 3.8)
        new_rect.setAttribute("y", y - 2.8 * size / 3.8)
        new_rect.setAttribute("fill", "blue")
        logo.appendChild(new_rect)
        var new_rect = document.createElementNS(svgNS, "rect");
        new_rect.setAttribute("width", size / 3.8)
        new_rect.setAttribute("height", size / 3.8)
        new_rect.setAttribute("x", x + 2.8 * size / 3.8)
        new_rect.setAttribute("y", y - 2.8 * size / 3.8)
        new_rect.setAttribute("fill", "blue")
        logo.appendChild(new_rect)
        var new_circ = document.createElementNS(svgNS, "circle");
        new_circ.setAttribute("r", size / (2 * 3.8))
        new_circ.setAttribute("cx", x + size / (2 * 3.8))
        new_circ.setAttribute("cy", y + size / (2 * 3.8) - 2.8 * size / 3.8)
        new_circ.setAttribute("fill", "red")
        logo.appendChild(new_circ)
        var new_circ = document.createElementNS(svgNS, "circle");
        new_circ.setAttribute("r", size / (2 * 3.8))
        new_circ.setAttribute("cx", x + size / (2 * 3.8) + 1.4 * size / 3.8)
        new_circ.setAttribute("cy", y + size / (2 * 3.8) - 1.4 * size / 3.8)
        new_circ.setAttribute("fill", "red")
        logo.appendChild(new_circ)
        return logo
    }
    //
    // Set the initial prompt
    //
    set_prompt('right click / three finger / long press for menu; scroll for zoom, drag for pan')
    //
    // Check local version
    //
    check_version()
    //
    // SVG canvas for drawing
    //
    var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg")
    svg.style.position = 'absolute'
    svg.style.backgroundColor = 'rgba(200,200,200,0)' // debug for offset check
    //svg.style.backgroundImage = mods.lighttheme.backgroundImage // background texture for canvas
    svg.style.top = mods.ui.header
    svg.style.left = 0
    svg.style.zIndex = 0 // Original is 0
    svg.style.overflow = 'visible'
    svg.setAttribute('width', 40)
    svg.setAttribute('height', 40)
    svg.setAttribute('id', 'svg')
    svg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink")
    document.body.appendChild(svg)
    //
    // link container (a group of svg paths)
    //
    var svg = document.getElementById('svg')
    var g = document.createElementNS('http://www.w3.org/2000/svg', 'g')
    g.style.zIndex = 0 // Original is 0, set 2 for debugging links on top
    g.setAttribute('id', 'links')
    svg.appendChild(g)
    //
    // file reading controls
    //
    var file = document.createElement('input')
    file.setAttribute('type', 'file')
    file.setAttribute('id', 'mod_input')
    file.style.position = 'absolute'
    file.style.left = 0
    file.style.top = 0
    file.style.width = 0
    file.style.height = 0
    file.style.opacity = 0
    file.addEventListener('change', function() {
        mod_read_handler()
    })
    document.body.appendChild(file)
    var file = document.createElement('input')
    file.setAttribute('type', 'file')
    file.setAttribute('id', 'prog_input')
    file.style.position = 'absolute'
    file.style.left = 0
    file.style.top = 0
    file.style.width = 0
    file.style.height = 0
    file.style.opacity = 0
    file.addEventListener('change', function() {
        prog_read_handler()
    })
    document.body.appendChild(file)
    //
    // module container
    //
    var div = document.createElement('div')
    div.setAttribute('id', 'modules')
    document.body.appendChild(div)
    //
    // check for program load query
    //
    if (location.search.length > 0) {
        var args = location.search.slice(1).split('&')
        for (var a in args) {
            var arg = args[a].split('=')
            if (arg[0] == 'program')
                prog_message_handler(arg[1])
        }
    }
    //
    // program routines
    //
    function prog_read_handler(event) {
        var file = document.getElementById('prog_input')
        var file_reader = new FileReader()
        file_reader.onload = prog_load_handler
        file_reader.readAsText(file.files[0])
        mods.ui.progname = file.files[0].name
    }

    function prog_message_handler(filename) {
        var req = new XMLHttpRequest()
        req.responseType = 'text'
        req.onreadystatechange = function() {
            if (req.readyState == XMLHttpRequest.DONE) {
                prog = JSON.parse(req.response)
                prog_load(prog)
            }
        }
        var index = filename.lastIndexOf('/')
        if (index != -1) {
            mods.ui.progname = filename.slice(index + 1)
        } else
            mods.ui.progname = filename
        //
        // send request, with random query to prevent caching
        //
        req.open('GET', filename + '?rnd=' + Math.random())
        req.send()
    }

    function prog_load_handler(event) {
        prog = JSON.parse(event.target.result)
        prog_load(prog)
    }

    function prog_load(prog) {
        //
        // load modules
        //
        for (var idnumber in prog.modules) {
            var module = prog.modules[idnumber]
            var str = module.definition
            try {
                eval('var args = ' + str)
            } catch (err) {
                console.log(err.message)
                return
            }
            args.definition = str
            args.id = idnumber
            var t = mods_transform()
            var xw = t.ox - t.tx + (mods.ui.xstart - t.ox) / t.s
            var yw = t.oy - t.ty + (mods.ui.ystart - t.oy) / t.s - mods.ui.header
            args.top = parseFloat(module.top) + yw
            args.left = parseFloat(module.left) + xw
            args.filename = module.filename
            add_module(args)
        }
        //
        // load links
        //
        for (var linkid in prog.links) {
            var str = prog.links[linkid]
            eval('var link = ' + str)
            eval('var linksrc = ' + link.source)
            eval('var linkdst = ' + link.dest)
            var src = document.getElementById(
                JSON.stringify({
                    id: linksrc.id,
                    type: linksrc.type,
                    name: linksrc.name
                }))
            var dst = document.getElementById(
                JSON.stringify({
                    id: linkdst.id,
                    type: linkdst.type,
                    name: linkdst.name
                }))
            add_link(src, dst)
        }
        // zoom to fit
        zoom_extents()
    }

    function save_program() {
        var filename = prompt('program name?', mods.ui.progname.replaceAll("%20","\ "))
        if (filename == null | filename == "") {} else {
            mods.ui.progname = filename
            var prog = {
                modules: {},
                links: []
            }
            var modules = document.getElementById('modules')
            //
            // save modules
            //
            for (var c = 0; c < modules.childNodes.length; ++c) {
                var module = modules.childNodes[c]
                var idnumber = module.id
                prog.modules[idnumber] = {
                    definition: update_module_definition(
                        idnumber, module.dataset.definition),
                    top: module.dataset.top,
                    left: module.dataset.left,
                    filename: module.dataset.filename,
                    inputs: {},
                    outputs: {}
                }
            }
            //
            // save links
            //
            var svg = document.getElementById('svg')
            var links = svg.getElementById('links')
            for (var l = 0; l < links.childNodes.length; ++l) {
                var link = links.childNodes[l]
                var linkid = link.id
                prog.links.push(linkid)
            }
            //
            // download
            //
            var text = JSON.stringify(prog)
            var a = document.createElement('a')
            a.setAttribute('href', 'data:text/plain;charset=utf-8,' +
                encodeURIComponent(text))
            a.setAttribute('download', filename)
            a.style.display = 'none'
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
        }
    }

    function save_page() {
        var filename = prompt('page name?', mods.ui.progname + ".html")
        if (filename == null | filename == "") {} else {
            mods.ui.progname = filename
            var prog = {
                modules: {},
                links: []
            }
            var modules = document.getElementById('modules')
            //
            // save modules
            //
            for (var c = 0; c < modules.childNodes.length; ++c) {
                var module = modules.childNodes[c]
                var idnumber = module.id
                prog.modules[idnumber] = {
                    definition: update_module_definition(
                        idnumber, module.dataset.definition),
                    top: module.dataset.top,
                    left: module.dataset.left,
                    filename: module.dataset.filename,
                    inputs: {},
                    outputs: {}
                }
            }
            //
            // save links
            //
            var svg = document.getElementById('svg')
            var links = svg.getElementById('links')
            for (var l = 0; l < links.childNodes.length; ++l) {
                var link = links.childNodes[l]
                var linkid = link.id
                prog.links.push(linkid)
            }
            //
            // read mods.js
            //
            var req = new XMLHttpRequest()
            req.responseType = 'text'
            req.onreadystatechange = function() {
                if (req.readyState == XMLHttpRequest.DONE) {
                    //
                    // construct page
                    //
                    var str = req.response
                    var text = "<html lang='en'>\n"
                    text += "<head><meta charset='utf-8'>\n"
                    text += "<title>mods CE</title>\n"
                    text += '<link rel="icon" href="https://modsproject.org/favicon.ico" type="image/x-icon" />\n'
                    text += '<link rel="stylesheet" type="text/css" href="https://modsproject.org/style.css" />\n'
                    text += "</head>\n"
                    text += "<body>\n"
                    text += "<" + "script" + ">\n"
                    text += str
                    text += "var prog = JSON.parse(JSON.stringify(" + JSON.stringify(prog) + "))\n"
                    text += "window.mods_prog_load(prog)\n"
                    text += "</" + "script" + ">\n"
                    text += "</body>\n"
                    text += "</html>\n"
                    //
                    // download page
                    //
                    var a = document.createElement('a')
                    a.setAttribute('href', 'data:text/plain;charset=utf-8,' +
                        encodeURIComponent(text))
                    a.setAttribute('download', filename)
                    a.style.display = 'none'
                    document.body.appendChild(a)
                    a.click()
                    document.body.removeChild(a)
                }
            }
            //
            // send request, with random query to prevent caching
            //
            req.open('GET', 'js/mods.js' + '?rnd=' + Math.random())
            req.send()
        }
    }
    //
    // add program load to window
    //
    window.mods_prog_load = function(prog) {
        prog_load(prog)
    }
    //
    // module routines
    //
    function mod_read_handler(event) {
        var file = document.getElementById('mod_input')
        var file_reader = new FileReader()
        file_reader.onload = mod_load_handler
        file_reader.readAsText(file.files[0])
    }

    function mod_message_handler(filename, top, left) {
        var req = new XMLHttpRequest()
        req.responseType = 'text'
        req.onreadystatechange = function() {
            if (req.readyState == XMLHttpRequest.DONE) {
                var str = req.response
                try {
                    eval('var args = ' + str)
                } catch (err) {
                    console.log(err.message)
                    return
                }
                args.definition = str
                args.id = String(Math.random())
                args.top = top
                args.left = left
                args.filename = filename
                add_module(args)
            }
        }
        //
        // send request, with random query to prevent caching
        //
        req.open('GET', filename + '?rnd=' + Math.random())
        req.send()
    }

    function mod_load_handler(event) {
        str = event.target.result
        try {
            eval('var args = ' + str)
        } catch (err) {
            console.log(err.message)
            return
        }
        args.definition = str
        args.id = String(Math.random())
        args.top = mods.ui.top
        args.left = mods.ui.left
        args.filename = ""
        var div = add_module(args)
        return (div)
    }

    function add_module(args) {
        var idnumber = args.id
        mods.mod[idnumber] = args.mod
        var modules = document.getElementById('modules')
        //
        // container
        //
        var container = document.createElement('div')
        container.setAttribute("id", idnumber)
        container.style.position = "absolute"
        container.style.top = args.top
        container.style.left = args.left
        container.dataset.top = args.top
        container.dataset.left = args.left
        container.dataset.filename = args.filename
        container.dataset.name = args.name
        container.style.zIndex = 0
        container.style.width = window.innerWidth
        container.dataset.definition = args.definition
        modules.appendChild(container)
        //
        // name
        //
        var divname = document.createElement('div')
        divname.appendChild(document.createTextNode(args.name))
        divname.addEventListener('mouseover', name_over)
        divname.addEventListener('mouseout', name_out)
        divname.addEventListener('mousedown', name_mousedown)
        divname.addEventListener('touchstart', name_touchdown)
        divname.style.backgroundColor = "rgb(255, 89, 191)"
        divname.style.padding = 1.5 * mods.ui.padding
        divname.style.position = "absolute"
        divname.style.cursor = 'move'
        divname.style.top = 0
        divname.style.left = 0
        divname.style.textAlign = 'center'
        divname.style.border = mods.ui.border + 'px solid'
        divname.style.borderRadius = mods.ui.borderRadius
        container.appendChild(divname)
        //
        // controls
        //
        var divctrl = document.createElement('div')
        var editspan = document.createElement('span')
        editspan.innerHTML = 'edit'
        editspan.style.fontWeight = 'normal'
        editspan.addEventListener('mouseover', function(event) {
            set_prompt('click to edit')
            editspan.style.fontWeight = 'bold'
        })
        editspan.addEventListener('mouseout', function(event) {
            set_prompt('')
            editspan.style.fontWeight = 'normal'
        })
        editspan.addEventListener('mousedown', edit_module)
        divctrl.appendChild(editspan)
        var delspan = document.createElement('span')
        delspan.innerHTML = ' delete '
        delspan.addEventListener('mouseover', function(event) {
            set_prompt('click to delete')
            delspan.style.fontWeight = 'bold'
        })
        delspan.addEventListener('mouseout', function(event) {
            set_prompt('')
            delspan.style.fontWeight = 'normal'
        })
        delspan.addEventListener('mousedown', function(event) {
            delete_module(event.target.parentNode.parentNode.id)
            // if we are deleting our module, delete also the temporary link 
            if (1) { // tofix condition: do not delete the link if we are deleting another module
                delete_temp_link()
            }
        })
        divctrl.appendChild(delspan)
        divctrl.style.backgroundColor = "rgb(200, 200, 200)"
        divctrl.style.padding = mods.ui.padding
        divctrl.style.position = "absolute"
        divctrl.style.cursor = 'default'
        divctrl.style.top = divname.clientHeight + mods.ui.border
        divctrl.style.left = 0
        divctrl.style.textAlign = 'center'
        divctrl.style.border = mods.ui.border + 'px solid'
        divctrl.style.borderRadius = mods.ui.borderRadius
        container.appendChild(divctrl)
        divctrl.style.left = divname.clientWidth / 2 - divctrl.clientWidth / 2 // center align with divname
        //
        // interface
        //
        var divint = document.createElement('div')
        // no thinner than divctrl
        divint.style.minWidth = divctrl.offsetWidth
        divint.style.backgroundColor = "rgb(240,240,240)" 
        divint.style.padding = mods.ui.padding
        divint.style.position = "absolute"
        divint.style.top = divname.clientHeight + divctrl.clientHeight + mods.ui.border
        divint.style.textAlign = 'center'
        // divint.style.border = '2px solid'
        divint.style.borderColor = "rgb(200, 200, 200)"
        divint.style.borderRadius = mods.ui.borderRadius
        divint.style.boxSizing = 'border-box'
        divint.setAttribute('id', JSON.stringify({
            id: idnumber,
            type: 'interface'
        }))
        divint.dataset.id = idnumber
        divint.dataset.divNameSize = divname.clientWidth
        args.interface(divint)
        container.appendChild(divint)
        divint.style.left = divname.clientWidth / 2 - divint.clientWidth / 2 // center align with divname 
        //
        // inputs
        //
        var divin = document.createElement('div')
        divin.setAttribute('id', JSON.stringify({
            id: idnumber,
            type: 'inputs'
        }))
        divin.style.backgroundColor = "rgb(255, 225, 54)"
        divin.style.padding = mods.ui.padding
        divin.style.paddingLeft = '4px'
        divin.style.position = "absolute"
        divin.style.top = divname.clientHeight + divctrl.clientHeight + mods.ui.border
        divin.style.border = mods.ui.border + 'px solid'
        divin.style.borderRadius = mods.ui.borderRadius
        divin.style.cursor = 'default'
        // todo: are the listeners below necessary?
        divin.addEventListener('mousedown', nothing)
        divin.addEventListener('touchstart', nothing)
        divin.addEventListener('mouseup', nothing)
        divin.addEventListener('touchend', nothing)
        // populate divin
        var div = document.createElement('div')
        var b = document.createElement('b')
        b.appendChild(document.createTextNode('inputs'))
        div.appendChild(b)
        div.style.paddingBottom = '7px'
        div.style.textAlign= "right"
        divin.appendChild(div)
        for (var v in args.inputs) {
            var div = document.createElement('div')
            // div.style.borderTop = 'dotted red 2px'
            // label
            div.innerHTML += '> '
            if (args.inputs[v].label != undefined)
            div.innerHTML += args.inputs[v].label
            else
            div.innerHTML += v
            // (type)
            if (args.inputs[v].type != '')
                div.innerHTML += ' (' + args.inputs[v].type + ')'
            div.setAttribute('id', JSON.stringify({
                id: idnumber,
                type: 'inputs',
                name: v
            }))
            div.addEventListener('mouseover', input_over)
            div.addEventListener('mouseout', input_out)
            div.addEventListener('mousedown', input_mousedown)
            div.addEventListener('touchstart', input_touchdown)
            div.dataset.links = JSON.stringify([])
            div.dataset.name = v
            divin.appendChild(div)
            div.dataset.id = JSON.stringify({
                id: idnumber,
                type: 'input',
                name: v,
                rnd: Math.random()
            }) // randomize for unique events
            window.addEventListener(div.dataset.id, args.inputs[v].event)
        }
        // hide if there are no inputs
        if ((Object.keys(args.inputs).length) == 0) 
            divin.style.visibility = 'hidden'
        // align left of divint
        divin.style.left = divname.clientWidth / 2 - divint.clientWidth / 2 - divin.clientWidth 
        for (var i = 1; i < divin.childNodes.length; ++i) {
            divin.childNodes[i].dataset.dx = divin.offsetLeft +
                divin.childNodes[i].offsetLeft
            divin.childNodes[i].dataset.dy = divin.offsetTop +
                divin.childNodes[i].offsetTop +
                divin.childNodes[i].offsetHeight / 2
        }
        // add divin to module container
        container.appendChild(divin)
        //
        // outputs
        //
        var divout = document.createElement('div')
        divout.setAttribute('id', JSON.stringify({
            id: idnumber,
            type: 'outputs'
        }))
        divout.style.backgroundColor = "rgb(255, 163, 25)"
        divout.style.padding = mods.ui.padding
        divout.style.paddingRight = '4px'
        divout.style.position = "absolute"
        divout.style.top = divname.clientHeight + divctrl.clientHeight + mods.ui.border
        divout.style.border = mods.ui.border + 'px solid'
        divout.style.borderRadius = mods.ui.borderRadius
        divout.style.cursor = 'default'
        // todo: are the listeners below necessary?
        divout.addEventListener('mousedown', nothing)
        divout.addEventListener('touchstart', nothing)
        divout.addEventListener('mouseup', nothing)
        divout.addEventListener('touchend', nothing)
        // populate divout
        var div = document.createElement('div')
        var b = document.createElement('b')
        b.appendChild(document.createTextNode('outputs'))
        div.appendChild(b)
        div.style.paddingBottom = '7px'
        divout.appendChild(div)
        for (var v in args.outputs) {
            var div = document.createElement('div')
            if (args.outputs[v].label != undefined)
                div.innerHTML += args.outputs[v].label
            else
                div.innerHTML += v
            if (args.outputs[v].type != '')
                div.innerHTML += ' (' + args.outputs[v].type + ')'
            div.innerHTML += ' >'
            div.setAttribute('id', JSON.stringify({
                id: idnumber,
                type: 'outputs',
                name: v
            }))
            div.style.textAlign= "right"
            div.addEventListener('mouseover', output_over)
            div.addEventListener('mouseout', output_out)
            div.addEventListener('mousedown', output_mousedown)
            div.addEventListener('touchstart', output_touchdown)
            div.dataset.links = JSON.stringify([])
            div.dataset.name = v
            divout.appendChild(div)
            div.dataset.id = JSON.stringify({
                id: idnumber,
                type: 'output',
                name: v,
                rnd: Math.random()
            }) // randomize for unique events
            window.addEventListener(div.dataset.id, args.outputs[v].event)
        }
        // hide if there are no outputs
        if ((Object.keys(args.outputs).length) == 0)
        divout.style.visibility = 'hidden'
        // align right of divint
        divout.style.left = divname.clientWidth / 2 + divint.clientWidth / 2 
        for (var i = 1; i < divout.childNodes.length; ++i) {
            divout.childNodes[i].dataset.dx = divout.offsetLeft +
            divout.childNodes[i].offsetLeft +
            divout.childNodes[i].offsetWidth
            divout.childNodes[i].dataset.dy = divout.offsetTop +
            divout.childNodes[i].offsetTop +
            divout.childNodes[i].offsetHeight / 2
        }
        // add divout to module container
        container.appendChild(divout)
        //
        // adjust divint height no shorter than divin or divout
        divint.style.minHeight = Math.max(divin.offsetHeight, divout.offsetHeight) 

        //
        // initialization
        //
        args.init()
        //
        // resize to contents
        //
        container.style.width = divint.clientWidth + divin.clientWidth + divout.clientWidth
        mods.fit(divint)
        //
        // return container
        //
        return (container)
    }

    function delete_module(idnumber) {
        //
        // delete links
        //
        var ins = document.getElementById(
            JSON.stringify({
                id: idnumber,
                type: 'inputs'
            }))
        var outs = document.getElementById(
            JSON.stringify({
                id: idnumber,
                type: 'outputs'
            }))
        for (var i = 1; i < ins.childNodes.length; ++i) {
            var links = JSON.parse(ins.childNodes[i].dataset.links)
            for (var l in links)
                delete_link(links[l])
        }
        for (var i = 1; i < outs.childNodes.length; ++i) {
            var links = JSON.parse(outs.childNodes[i].dataset.links)
            for (var l in links)
                delete_link(links[l])
        }
        //
        // delete container
        //
        var modules = document.getElementById('modules')
        var container = document.getElementById(idnumber)
        modules.removeChild(container)
        //
        // clear prompt
        //
        set_prompt('')
    }

    function update_module_definition(id) {
        //
        // get definition
        //
        var module = document.getElementById(id)
        var def = module.dataset.definition
        //
        // check for mod
        //
        if (mods.mod[id] == undefined)
            return def
        //
        // split definition
        //
        var lines = def.split('\n')
        //
        // find init function
        //
        var line = 0
        while (line < lines.length) {
            if (lines[line].indexOf("var init") == 0)
                break
            line += 1
        }
        //
        // read initializations up to inputs function
        //
        while (line < lines.length) {
            if (lines[line].indexOf(".value =") != -1) {
                var start = 4 + lines[line].indexOf("mod.")
                var end = lines[line].indexOf(".value =")
                var key = lines[line].slice(start, end)
                var value = mods.mod[id][key]['value']
                if (String(value + '\n').indexOf('\n') != -1)
                    value = String(value).replace(/\n/g, "\\n")
                lines[line] = "   mod." + key + ".value = '" + value + "'"
            } else if (lines[line].indexOf(".checked =") != -1) {
                var start = 4 + lines[line].indexOf("mod.")
                var end = lines[line].indexOf(".checked")
                var key = lines[line].slice(start, end)
                var value = mods.mod[id][key]['checked']
                lines[line] = "   mod." + key + ".checked = " + value
            }
            if (lines[line].indexOf("var inputs") == 0)
                break
            line += 1
        }
        return (lines.join('\n'))
    }

    function edit_module(evt) {
        var mod = evt.target.parentNode.parentNode
        var idnumber = mod.id
        var def = update_module_definition(idnumber)
        //
        // open edit window
        //
        var top = mod.dataset.top
        var left = mod.dataset.left
        var name = mod.dataset.name
        var filename = mod.dataset.filename
        var fontsize = 130
        var win = window.open('')
        var file = document.createElement('input')
        file.setAttribute('type', 'file')
        file.setAttribute('id', 'edit_module_file')
        file.style.position = 'absolute'
        file.style.left = 0
        file.style.top = 0
        file.style.width = 0
        file.style.height = 0
        file.style.opacity = 0
        file.addEventListener('change', function() {
            edit_module_read_handler()
        })
        win.document.title = name + " editor"
        win.document.body.appendChild(file)

        function edit_module_read_handler() {
            var file = win.document.getElementById('edit_module_file')
            var file_reader = new FileReader()
            file_reader.onload = edit_module_load_handler
            file_reader.readAsText(file.files[0])
        }

        function edit_module_load_handler(event) {
            str = event.target.result
            var text = win.document.getElementById('edit_module_text')
            text.value = str
            update_module(idnumber)
            win.close()
        }
        if (filename != "undefined" && filename != "") {
            var btn = document.createElement('button')
            btn.appendChild(document.createTextNode('reload from server'))
            btn.style.padding = mods.ui.padding
            btn.style.margin = 1
            btn.addEventListener('click', function() {
                var req = new XMLHttpRequest()
                req.responseType = 'text'
                req.onreadystatechange = function() {
                    if (req.readyState == XMLHttpRequest.DONE) {
                        if (req.status == 200) {
                            text.value = req.response
                            update_module(idnumber)
                            win.close()
                        } else {
                            win.alert("The location of this module has changed. Use load from file instead")
                        }
                    }
                }
                req.open('GET', filename + '?rnd=' + Math.random())
                req.send()
            })
            win.document.body.appendChild(btn)
        }
        var btn = document.createElement('button')
        btn.appendChild(document.createTextNode('load from file'))
        btn.style.padding = mods.ui.padding
        btn.style.margin = 1
        btn.addEventListener('click', function() {
            var file = win.document.getElementById('edit_module_file')
            file.value = null
            file.click()
        })
        win.document.body.appendChild(btn)
        var btn = document.createElement('button')
        btn.appendChild(document.createTextNode('update and close'))
        btn.style.padding = mods.ui.padding
        btn.style.margin = 1
        btn.addEventListener('click', function() {
            update_module(idnumber)
            win.close()
        })
        win.document.body.appendChild(btn)
        var btn = document.createElement('button')
        btn.appendChild(document.createTextNode('update'))
        btn.style.padding = mods.ui.padding
        btn.style.margin = 1
        btn.addEventListener('click', function() {
            update_module(idnumber)
        })
        win.document.body.appendChild(btn)
        var btn = document.createElement('button')
        btn.appendChild(document.createTextNode('close'))
        btn.style.padding = mods.ui.padding
        btn.style.margin = 1
        btn.addEventListener('click', function() {
            win.close()
        })
        win.document.body.appendChild(btn)
        var btn = document.createElement('button')
        btn.appendChild(document.createTextNode('save'))
        btn.style.padding = mods.ui.padding
        btn.style.margin = 1
        btn.addEventListener('click', function() {
            var a = document.createElement('a')
            a.setAttribute('href', 'data:text/plain;charset=utf-8,' +
                encodeURIComponent(text.value))
            a.setAttribute('download', name)
            a.style.display = 'none'
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
        })
        win.document.body.appendChild(btn)
        var btn = document.createElement('button')
        btn.appendChild(document.createTextNode('increase font'))
        btn.style.padding = mods.ui.padding
        btn.style.margin = 1
        btn.addEventListener('click', function() {
            fontsize *= 1.2
            text.style.fontSize = fontsize + '%'
        })
        win.document.body.appendChild(btn)
        var btn = document.createElement('button')
        btn.appendChild(document.createTextNode('decrease font'))
        btn.style.padding = mods.ui.padding
        btn.style.margin = 1
        btn.addEventListener('click', function() {
            fontsize /= 1.2
            text.style.fontSize = fontsize + '%'
        })
        win.document.body.appendChild(btn)
        win.document.body.appendChild(document.createElement('br'))
        var text = document.createElement('textarea')
        text.setAttribute('id', 'edit_module_text')
        text.setAttribute('spellcheck', 'false')
        text.style.width = '100%'
        text.style.height = '95%'
        text.style.resize = ' none'
        text.style.fontSize = fontsize + '%'
        text.style.backgroundColor = '#3C3C3C'
        text.style.color = '#78DB78'
        text.value = def
        win.document.body.appendChild(text)

        function reload_module(idnumber) {}

        function update_module(idnumber) {
            //
            // save links
            //
            var ins = document.getElementById(
                JSON.stringify({
                    id: idnumber,
                    type: 'inputs'
                }))
            var inlinks = []
            for (var i = 1; i < ins.childNodes.length; ++i) {
                var links = JSON.parse(ins.childNodes[i].dataset.links)
                for (var l in links)
                    inlinks.push(links[l])
            }
            var outs = document.getElementById(
                JSON.stringify({
                    id: idnumber,
                    type: 'outputs'
                }))
            var outlinks = []
            for (var i = 1; i < outs.childNodes.length; ++i) {
                var links = JSON.parse(outs.childNodes[i].dataset.links)
                for (var l in links)
                    outlinks.push(links[l])
            }
            //
            // delete module
            //
            delete_module(idnumber)
            //
            // add module
            //
            var def = text.value
            try {
                eval('var args = ' + def)
            } catch (err) {
                console.log(err.message)
                return
            }
            args.definition = def
            args.id = idnumber
            args.top = top
            args.left = left
            args.filename = filename
            add_module(args)
            //
            // add links
            //
            for (var l in inlinks) {
                eval('var link = ' + inlinks[l])
                eval('var linksrc = ' + link.source)
                eval('var linkdst = ' + link.dest)
                var src = document.getElementById(
                    JSON.stringify({
                        id: linksrc.id,
                        type: linksrc.type,
                        name: linksrc.name
                    }))
                var dst = document.getElementById(
                    JSON.stringify({
                        id: linkdst.id,
                        type: linkdst.type,
                        name: linkdst.name
                    }))
                add_link(src, dst)
            }
            for (var l in outlinks) {
                eval('var link = ' + outlinks[l])
                eval('var linksrc = ' + link.source)
                eval('var linkdst = ' + link.dest)
                var src = document.getElementById(
                    JSON.stringify({
                        id: linksrc.id,
                        type: linksrc.type,
                        name: linksrc.name
                    }))
                var dst = document.getElementById(
                    JSON.stringify({
                        id: linkdst.id,
                        type: linkdst.type,
                        name: linkdst.name
                    }))
                add_link(src, dst)
            }
        }
    }
    //
    // UI routines
    //
    function set_prompt(txt) {
        var span = document.getElementById('prompt')
        span.childNodes[0].innerHTML = ' ' + txt
    }

    function set_version(txt) {
        var span = document.getElementById('version')
        span.childNodes[0].innerHTML = ' ' + txt
        span.childNodes[0].style.fontWeight = 'bold'
    }

    function nothing(evt) {
        evt.preventDefault()
        evt.stopPropagation()
    }
    //
    // link routines
    //
    mods.add_link = function(src, dst) {
        add_link(src, dst)
    }

    function add_link(src, dst) {
        //
        // link order from out to in
        //
        if (src.id.indexOf('outputs') == -1) {
            var tmp = src
            src = dst
            dst = tmp
        }
        //
        // check if link exists
        //
        var id = JSON.stringify({
            source: src.id,
            dest: dst.id
        })
        var link = document.getElementById(id)
        if (link != null) {
            //
            // yes, remove it and return
            //
            delete_link(id)
            return
        }
        //
        // no, add link 
        //
        var links = JSON.parse(src.dataset.links)
        links.push(id)
        src.dataset.links = JSON.stringify(links)
        var links = JSON.parse(dst.dataset.links)
        links.push(id)
        dst.dataset.links = JSON.stringify(links)
        //
        // draw link 
        //
        xsrc = src.parentNode.parentNode.offsetLeft +
            parseFloat(src.dataset.dx)
        ysrc = src.parentNode.parentNode.offsetTop +
            parseFloat(src.dataset.dy) -
            mods.ui.header
        xdst = dst.parentNode.parentNode.offsetLeft +
            parseFloat(dst.dataset.dx)
        ydst = dst.parentNode.parentNode.offsetTop +
            parseFloat(dst.dataset.dy) -
            mods.ui.header
        var links = document.getElementById('links')
        // create a group for the link paths
        var g = document.createElementNS('http://www.w3.org/2000/svg', 'g')
        g.setAttribute('id', id)
        // add event listeners
        g.addEventListener('mouseover',link_over)
        g.addEventListener('mouseout',link_out)
        g.addEventListener('mousedown',link_mousedown)
        // add a white link line
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path')
        path.setAttribute('d', 'M' + xsrc + ',' + ysrc + ' C' + (xsrc + mods.ui.bezier) + ',' +
        ysrc + ' ' + (xdst - mods.ui.bezier) + ',' + ydst + ' ' + xdst + ',' + ydst)
        path.setAttribute('fill', 'none')
        path.setAttribute('stroke', mods.theme.background)
        path.setAttribute('stroke-width', mods.ui.link_stroke_with+4) 
        g.appendChild(path)
        // Add a thinner blue link line over it 
        var path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path')
        path2.setAttribute('d', 'M' + xsrc + ',' + ysrc + ' C' + (xsrc + mods.ui.bezier) + ',' +
        ysrc + ' ' + (xdst - mods.ui.bezier) + ',' + ydst + ' ' + xdst + ',' + ydst)
        path2.setAttribute('fill', 'none')
        path2.setAttribute('stroke', mods.ui.link_color)
        path2.setAttribute('stroke-width', mods.ui.link_stroke_with) 
        g.appendChild(path2)
        // var new_circ = document.createElementNS('http://www.w3.org/2000/svg', "polygon");
        // new_circ.setAttribute("points", [[xsrc+2, ysrc + mods.ui.link_stroke_with/2] , [xsrc+2, ysrc - mods.ui.link_stroke_with/2] , [xsrc+2 + 0.866*mods.ui.link_stroke_with , ysrc]] )
        // new_circ.setAttribute("fill", mods.theme.background)
        // g.appendChild(new_circ)
        // var new_circ = document.createElementNS('http://www.w3.org/2000/svg', "circle");
        // new_circ.setAttribute("r", mods.ui.link_stroke_with+2)
        // new_circ.setAttribute("cx", xdst)
        // new_circ.setAttribute("cy", ydst)
        // new_circ.setAttribute("fill", mods.ui.link_color)
        // g.appendChild(new_circ)
        // add the group to links container
        links.appendChild(g)
    
        /*
        //
        // don't trigger link
        //
        eval('var evtid = '+src.id)
        evtid.type = 'output'
        var evtstr = JSON.stringify(evtid)
        var evt = new CustomEvent(evtstr)
        window.dispatchEvent(evt)
        */
    }

    function add_temp_link(src,posx,posy) {
        //
        // draw link (in dinamic mode xdst and ydst are current mouse position)
        //
        var t = mods_transform()
        xsrc = src.parentNode.parentNode.offsetLeft +
            parseFloat(src.dataset.dx)
        ysrc = src.parentNode.parentNode.offsetTop +
            parseFloat(src.dataset.dy) -
            mods.ui.header
        // calculate xdst and ydst
        xdst = t.ox - t.tx + (posx-t.ox)/t.s       
        ydst = t.oy - t.ty + (posy-t.oy) / t.s - mods.ui.header
        // reverse bezier if starts from an input
        var sign = 1
        if (JSON.parse(mods.ui.source.dataset.id).type == 'input') {
            sign = -1
        }
        var links = document.getElementById('links')
        // add a temporary link path
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path')
        path.setAttribute('id', 'temp_link')
        path.setAttribute('d', 'M' + xsrc + ',' + ysrc + ' C' + (xsrc + sign*mods.ui.bezier) + ',' +
        ysrc + ' ' + (xdst - sign*mods.ui.bezier) + ',' + ydst + ' ' + xdst + ',' + ydst)
        path.setAttribute('fill', 'none')
        path.setAttribute('stroke-linecap', 'round') 
        path.setAttribute('stroke', 'rgb(0,230,0)')
        path.setAttribute('stroke-width', mods.ui.link_stroke_with) 
        path.setAttribute('stroke-dasharray', "5,10") 
        links.appendChild(path)
    }

    function redraw_temp_link(src,posx,posy) {
        //
        // redraws the temp link
        //
        var t = mods_transform()
        xsrc = src.parentNode.parentNode.offsetLeft + parseFloat(src.dataset.dx)
        ysrc = src.parentNode.parentNode.offsetTop + parseFloat(src.dataset.dy) - mods.ui.header
        // calculate xdst and ydst
        xdst = t.ox - t.tx + (posx-t.ox)/t.s       
        ydst = t.oy - t.ty + (posy-t.oy) / t.s - mods.ui.header
        // reverse bezier if starts from an input
        var sign = 1
        if (JSON.parse(mods.ui.source.dataset.id).type == 'input') {
            sign = -1
        }
        // get the temp link path
        var path = document.getElementById('temp_link')
        path.setAttribute('d', 'M' + xsrc + ',' + ysrc + ' C' + (xsrc + sign*mods.ui.bezier) + ',' +
        ysrc + ' ' + (xdst - sign*mods.ui.bezier) + ',' + ydst + ' ' + xdst + ',' + ydst)
    }



    function delete_link(linkid) {
        //
        // delete a link
        //
        // if we are deleting a selected link, set the flag to null
        if (mods.ui.selected_link == linkid) {
            mods.ui.selected_link = null
        }
        var links = document.getElementById('links') // get the links container
        links.removeChild(document.getElementById(linkid))
        link = JSON.parse(linkid)
        src = document.getElementById(link.source)
        dst = document.getElementById(link.dest)
        var links = JSON.parse(src.dataset.links)
        var index = links.indexOf(linkid)
        links.splice(index, 1)
        src.dataset.links = JSON.stringify(links)
        var links = JSON.parse(dst.dataset.links)
        var index = links.indexOf(linkid)
        links.splice(index, 1)
        dst.dataset.links = JSON.stringify(links)
    }

    function delete_temp_link() {
        //
        // delete a temporary link if exists
        //
        var links = document.getElementById('links') // get the links container
        var temp_link = document.getElementById('temp_link')
        if (typeof(temp_link) != 'undefined' && temp_link != null)
            {
            // Exists.
            links.removeChild(temp_link)
            mods.ui.source = null // possibly duplicated sometimes but its not done when you delete a module 
            // tofix because this can be triggered when deleting another module
            }
    }


    function draw_links(idnumber, color) {
        //
        // draw a module's links
        //
        var ins = document.getElementById(
            JSON.stringify({
                id: idnumber,
                type: 'inputs'
            }))
        var outs = document.getElementById(
            JSON.stringify({
                id: idnumber,
                type: 'outputs'
            }))
        for (var i = 1; i < ins.childNodes.length; ++i) {
            var links = JSON.parse(ins.childNodes[i].dataset.links)
            for (var l in links)
                draw_link(links[l], color)
        }
        for (var i = 1; i < outs.childNodes.length; ++i) {
            var links = JSON.parse(outs.childNodes[i].dataset.links)
            for (var l in links)
                draw_link(links[l], color)
        }
    }

    function draw_link(id, color) {
        //
        // actually redraws an existing link
        //
        var link = JSON.parse(id)
        src = document.getElementById(link.source)
        dst = document.getElementById(link.dest)
        xsrc = src.parentNode.parentNode.offsetLeft + parseFloat(src.dataset.dx)
        ysrc = src.parentNode.parentNode.offsetTop + parseFloat(src.dataset.dy) - mods.ui.header
        xdst = dst.parentNode.parentNode.offsetLeft + parseFloat(dst.dataset.dx)
        ydst = dst.parentNode.parentNode.offsetTop + parseFloat(dst.dataset.dy) - mods.ui.header
        // iterate through all paths of the link group
        var g = document.getElementById(id).childNodes // an array of childnodes
        for (var i = 0; i < g.length; ++i) {
            g[i].setAttribute('d', 'M' + xsrc + ',' + ysrc + ' C' + (xsrc + mods.ui.bezier) + ',' + ysrc + ' ' + (xdst - mods.ui.bezier) + ',' + ydst + ' ' + xdst + ',' + ydst)
        }
        // change the color of the top path
        g[1].setAttribute('stroke-linecap', 'butt')
        g[1].setAttribute('stroke-dasharray', "none") 
        g[1].setAttribute('stroke', color)
    }
    //
    // mods routines to be called from modules
    //
    mods.fit = function(div) {
        //
        // fit a module. Call this function to redraw the module when it's width changes
        //
        div.style.left = div.dataset.divNameSize / 2 - div.clientWidth / 2
        var divin = document.getElementById(
            JSON.stringify({
                id: div.dataset.id,
                type: 'inputs'
            }))
        divin.style.left = div.dataset.divNameSize / 2 - div.clientWidth / 2 - divin.clientWidth
        // recalculate dx,dy (bugfix issue #6)
        for (var i = 1; i < divin.childNodes.length; ++i) {
            divin.childNodes[i].dataset.dx = divin.offsetLeft +
                divin.childNodes[i].offsetLeft
            divin.childNodes[i].dataset.dy = divin.offsetTop +
                divin.childNodes[i].offsetTop +
                divin.childNodes[i].offsetHeight / 2
        }        
        var divout = document.getElementById(
            JSON.stringify({
                id: div.dataset.id,
                type: 'outputs'
            }))
        divout.style.left = div.dataset.divNameSize / 2 + div.clientWidth / 2
        // recalculate dx,dy (bugfix issue #6)
        for (var i = 1; i < divout.childNodes.length; ++i) {
            divout.childNodes[i].dataset.dx = divout.offsetLeft +
                divout.childNodes[i].offsetLeft +
                divout.childNodes[i].offsetWidth
            divout.childNodes[i].dataset.dy = divout.offsetTop +
                divout.childNodes[i].offsetTop +
                divout.childNodes[i].offsetHeight / 2
        }
        // redraw links (bugfix issue #6)
        // before redrawing, unselect any selected link
        if (mods.ui.selected_link != null) { // a link is selected
            // get the link
            var link = mods.ui.selected_link
            // redraw it solid and flag unselected link
            draw_link(link, mods.ui.link_color)
            mods.ui.selected_link = null
        }
	    draw_links(div.dataset.id, mods.ui.link_color)
    }
    mods.output = function(mod, varname, val) {
        //
        // send module outputs
        //
        var div = mod.div
        var key = JSON.parse(div.id)
        var idnumber = key.id
        var out = document.getElementById(
            JSON.stringify({
                id: idnumber,
                type: 'outputs',
                name: varname
            }))
        var links = JSON.parse(out.dataset.links)
        for (var l in links) {
            var link = JSON.parse(links[l])
            var dest = JSON.parse(link.dest)
            var divin = document.getElementById(JSON.stringify({
                id: dest.id,
                type: 'inputs',
                name: dest.name
            }))
            var evt = new CustomEvent(divin.dataset.id, {
                detail: val
            })
            window.dispatchEvent(evt)
        }
    }
    //
    // module modification calls
    //
    mods.module_create = function(args) {
        var event = {
            target: {
                result: args
            }
        }
        var div = mod_load_handler(event)
        return (div)
    }
    mods.module_delete = function(id) {
        delete_module(id)
    }
    mods.module_id = function(div) {
        return div.parentNode.id
    }
    mods.module_left = function(id) {
        var module = document.getElementById(id)
        return (parseInt(module.style.left))
    }
    mods.module_move = function(id, dx, dy) {
    // before moving, unselect any selected link
    if (mods.ui.selected_link != null) { // a link is selected
        // get the link
        var link = mods.ui.selected_link
        // redraw it solid and flag unselected link
        draw_link(link, mods.ui.link_color)
        mods.ui.selected_link = null
    }
    var module = document.getElementById(id)
        var top = parseInt(module.style.top)
        module.style.top = top + dy
        module.dataset.top = top + dy
        var left = parseInt(module.style.left)
        module.style.left = left + dx
        module.dataset.left = left + dx
        draw_links(id, mods.ui.link_color)
    }
    mods.module_inputs = function(id, index) {
        var module = document.getElementById(id)
        var inputs = document.getElementById(
            JSON.stringify({
                id: id,
                type: 'inputs'
            }))
        console.log(inputs.childNodes[index])
    }
    mods.module_outputs = function(id, index) {
        var module = document.getElementById(id)
        var outputs = document.getElementById(
            JSON.stringify({
                id: id,
                type: 'outputs'
            }))
        console.log(outputs.childNodes[index])
    }
    mods.module_position = function(id, x, y) {
        // before moving, unselect any selected link
        if (mods.ui.selected_link != null) { // a link is selected
            // get the link
            var link = mods.ui.selected_link
            // redraw it solid and flag unselected link
            draw_link(link, mods.ui.link_color)
            mods.ui.selected_link = null
        }
        var module = document.getElementById(id)
        var top = parseInt(module.style.top)
        module.style.top = y
        module.dataset.top = y
        var left = parseInt(module.style.left)
        module.style.left = x
        module.dataset.left = x
        draw_links(id, mods.ui.link_color)
    }
    mods.module_top = function(id) {
        var module = document.getElementById(id)
        return (parseInt(module.style.top))
    }
    mods.module_width = function(id) {
        var module = document.getElementById(id)
        return (parseInt(module.clientWidth))
    }

    // mods.module_height = function(id) { // todo: why is height not defined? proposal of definition
    //     var module = document.getElementById(id)
    //     return (parseInt(module.clientHeight))
    // }

    //
    // links event handlers (TODO)
    //
    function link_over(evt) {
        // get the link
        var link = evt.target.parentNode.id
        // highlight unless I am creating a link
        if (mods.ui.source == null) {
            // and if you are not hovering an already selected link
            if (mods.ui.selected_link == null || mods.ui.selected_link != link) {
                draw_link(link, mods.ui.link_highlight)
                set_prompt('click to select/deselect')
                }   
            }
        }
    function link_out(evt) {
        // get the link
        var link = evt.target.parentNode.id
        // only works when not in the process of creating a link
        if (mods.ui.source == null) {
            // if I am exiting in a non selected link draw link in normal color
            if (mods.ui.selected_link == null || mods.ui.selected_link != link) {
                draw_link(link, mods.ui.link_color)
                set_prompt('')
                }
            }
        }
    function link_mousedown(evt) {
        // get the link
        var link = evt.target.parentNode.id
        // only works when not in the process of creating a link
        if (mods.ui.source == null) {
            //
            // if no link was previously selected, select it
            //
            if (mods.ui.selected_link == null) {
                // store selected link
                mods.ui.selected_link = link
                // Format the link
                draw_link(link, mods.ui.link_highlight)
                // set extra formatting (todo: include optional formatting in main function)
                var path = evt.target.parentNode.childNodes[1]
                // console.log(path)
                path.setAttribute('stroke-linecap', 'round')
                path.setAttribute('stroke-dasharray', "5,10") 
                set_prompt('ESC or click to deselect. DEL to delete')
                }
            //
            // there is a link already selected, if the same one
            //
            else {
                if (mods.ui.selected_link == link) {
                    // unselect the already selected link and redraw it solid
                    mods.ui.selected_link = null
                    draw_link(link, mods.ui.link_highlight)
                    set_prompt('')
                }
                else {
                    //
                    // we have selected a new link
                    //
                    // redraw the old link
                    draw_link(mods.ui.selected_link, mods.ui.link_color)
                    // store the new link
                    mods.ui.selected_link = link
                    // Format the link
                    draw_link(link, mods.ui.link_highlight)
                    // set extra formatting (todo: include optional formatting in main function)
                    var path = evt.target.parentNode.childNodes[1]
                    // console.log(path)
                    path.setAttribute('stroke-linecap', 'round')
                    path.setAttribute('stroke-dasharray', "5,10") 
                    set_prompt('ESC or click to deselect. DEL to delete')
                }
            }
        }
    }
    //
    // input event handlers
    //
    function input_over(evt) {
        evt.target.style.fontWeight = 'bold'
        //evt.target.style.color = 'red'
        // var links = JSON.parse(evt.target.dataset.links)
        // for (var l in links)
        //     console.log(links[l])
        //     draw_link(links[l], mods.ui.link_highlight)
        if (mods.ui.source == null)
            set_prompt('click to link')
    }

    function input_out(evt) {
        evt.target.style.fontWeight = 'normal'
        //evt.target.style.color = 'black'
        // var links = JSON.parse(evt.target.dataset.links)
        // for (var l in links)
        //     draw_link(links[l], mods.ui.link_color)
        if (mods.ui.source == null)
            set_prompt('')
    }

    function input_mousedown(evt) {
        if (mods.ui.source == null) {
            // this is the first click, set the source
            mods.ui.source = evt.target
            set_prompt('output variable to link/unlink to? ESC to cancel')
            // draw a temporary link
            add_temp_link(mods.ui.source,evt.clientX,evt.clientY)
            window.addEventListener('mousemove', function(e) {
                if (mods.ui.source != null) {
                    redraw_temp_link(mods.ui.source,e.clientX,e.clientY)
                }
            })
        } else {
            // this is the second click
            // check that we are not clicking the same module
            if (JSON.parse(evt.target.dataset.id).id == JSON.parse(mods.ui.source.dataset.id).id) {
                // do not create the link
                set_prompt('choose a different module')
            }
            // check that the source and destination are of different type
            else if (JSON.parse(evt.target.dataset.id).type == JSON.parse(mods.ui.source.dataset.id).type) {
                // do not create the link
                set_prompt('choose an output')
            }
            else {
            // delete the temporary link and create the permanent one
            add_link(mods.ui.source, evt.target)
            delete_temp_link()
            // link created, clear prompt and source
            set_prompt('')
            mods.ui.source = null
        }
        }
    }

    function input_touchdown(evt) {
        if (mods.ui.source == null) {
            // this is the first click, set the source
            mods.ui.source = evt.target
            set_prompt('output variable to link/unlink to?')
        } else {
            // this is the second click
            // check that we are not clicking the same module
            if (JSON.parse(evt.target.dataset.id).id == JSON.parse(mods.ui.source.dataset.id).id) {
                // do not create the link
                set_prompt('choose a different module')
            }
            // check that the source and destination are of different type
            else if (JSON.parse(evt.target.dataset.id).type == JSON.parse(mods.ui.source.dataset.id).type) {
                // do not create the link
                set_prompt('choose an output')
            }
            else {
            add_link(mods.ui.source, evt.target)
            // link created, clear prompt and source
            set_prompt('')
            mods.ui.source = null
        }
        }
    }
    //
    // output event handlers
    //
    function output_over(evt) {
        evt.target.style.fontWeight = 'bold'
        //evt.target.style.Color = 'red'
        // var links = JSON.parse(evt.target.dataset.links)
        // for (var l in links)
        //     draw_link(links[l], mods.ui.link_highlight)
        if (mods.ui.source == null)
            set_prompt('click to link')
    }

    function output_out(evt) {
        evt.target.style.fontWeight = 'normal'
        //evt.target.style.color = 'black'
        // var links = JSON.parse(evt.target.dataset.links)
        // for (var l in links)
        //     draw_link(links[l], mods.ui.link_color)
        if (mods.ui.source == null)
            set_prompt('')
    }

    function output_mousedown(evt) {
        if (mods.ui.source == null) {
            // this is the first click, set the source
            mods.ui.source = evt.target
            set_prompt('input variable to link/unlink to? ESC to cancel')
            // draw a temporary link
            add_temp_link(mods.ui.source,evt.clientX,evt.clientY)
            window.addEventListener('mousemove', function(e) {
                if (mods.ui.source != null) {
                    // store the mouse position
                    mods.ui.xmouse = evt.clientX
                    mods.ui.ymouse = evt.clientY
                    redraw_temp_link(mods.ui.source,e.clientX,e.clientY)
                }
            })
        } else {
            // this is the second click
            // check that we are not clicking the same module
            if (JSON.parse(evt.target.dataset.id).id == JSON.parse(mods.ui.source.dataset.id).id) {
                // do not create the link
                set_prompt('choose a different module')
            }
            // check that the source and destination are of different type
            else if (JSON.parse(evt.target.dataset.id).type == JSON.parse(mods.ui.source.dataset.id).type) {
                // do not create the link
                set_prompt('choose an input')
            }
            else {
            // delete the temporary link and create the permanent one
            add_link(mods.ui.source, evt.target)
            delete_temp_link()
            // link created, clear prompt and source
            set_prompt('')
            mods.ui.source = null
        }
        }
    }

    function output_touchdown(evt) {
        if (mods.ui.source == null) {
            // this is the first click, set the source
            mods.ui.source = evt.target
            set_prompt('input variable to link/unlink to?')
        } else {
            // this is the second click
            // check that we are not clicking the same module
            if (JSON.parse(evt.target.dataset.id).id == JSON.parse(mods.ui.source.dataset.id).id) {
                // do not create the link
                set_prompt('choose a different module')
            }
            // check that the source and destination are of different type
            else if (JSON.parse(evt.target.dataset.id).type == JSON.parse(mods.ui.source.dataset.id).type) {
                // do not create the link
                set_prompt('choose an input')
            }
            else {
            add_link(mods.ui.source, evt.target)
            // link created, clear prompt and source
            set_prompt('')
            mods.ui.source = null
        }
        }
    }
    //
    // module name event handlers
    //
    function name_over(evt) {
        evt.target.style.fontWeight = 'bold'
        evt.target.style.backgroundColor = "rgb(255, 89, 191)"
        if (mods.ui.source == null)
            set_prompt('click and drag to move')
    }

    function name_out(evt) {
        evt.target.style.fontWeight = 'normal'
        evt.target.style.backgroundColor = "rgb(255, 89, 191)"
        if (mods.ui.source == null)
            set_prompt('')
    }

    function name_mousedown(evt) {
        // unselect any selected link
        if (mods.ui.selected_link != null) { // a link is selected
            // get the link
            var link = mods.ui.selected_link
            // redraw it solid and flag unselected link
            draw_link(link, mods.ui.link_color)
            mods.ui.selected_link = null
        }
        evt.preventDefault()
        evt.stopPropagation()
        var div = document.getElementById(evt.target.parentNode.id)
        div.style.zIndex = 1
        mods.ui.xstart = evt.clientX
        mods.ui.ystart = evt.clientY
        mods.ui.selected[evt.target.parentNode.id] = true
        window.addEventListener('mousemove', name_mousemove)
        window.addEventListener('mouseup', name_mouseup)
    }

    function name_mousemove(evt) {
        evt.preventDefault()
        evt.stopPropagation()
        var t = mods_transform()
        for (var id in mods.ui.selected) {  // move the modules marked as selected 
            var div = document.getElementById(id)
            var dx = (evt.clientX - mods.ui.xstart) / t.s
            var dy = (evt.clientY - mods.ui.ystart) / t.s
            var newleft = parseFloat(div.dataset.left) + dx
            var newtop = parseFloat(div.dataset.top) + dy
            div.style.left = newleft + 'px'
            div.style.top = newtop + 'px'
            draw_links(id, mods.ui.link_color)
        }
    }

    function name_mouseup(evt) {
        evt.preventDefault()
        evt.stopPropagation()
        var t = mods_transform()
        for (var id in mods.ui.selected) {
            var div = document.getElementById(id)
            div.style.zIndex = 0
            div.childNodes[0].style.fontWeight = 'normal'
            var dx = (evt.clientX - mods.ui.xstart) / t.s
            var dy = (evt.clientY - mods.ui.ystart) / t.s
            div.dataset.left = parseFloat(div.dataset.left) + dx
            div.dataset.top = parseFloat(div.dataset.top) + dy
            window.removeEventListener('mousemove', name_mousemove)
            window.removeEventListener('mouseup', name_mouseup)
        }
        mods.ui.selected = {}
    }

    function name_touchdown(evt) {
        // unselect any selected link
        if (mods.ui.selected_link != null) { // a link is selected
            // get the link
            var link = mods.ui.selected_link
            // redraw it solid and flag unselected link
            draw_link(link, mods.ui.link_color)
            mods.ui.selected_link = null
        }
        evt.preventDefault()
        evt.stopPropagation()
        var div = document.getElementById(evt.target.parentNode.id)
        div.style.zIndex = 1
        mods.ui.xstart = evt.changedTouches[0].pageX
        mods.ui.ystart = evt.changedTouches[0].pageY
        mods.ui.selected[evt.target.parentNode.id] = true
        window.addEventListener('touchmove', name_touchmove)
        window.addEventListener('touchend', name_touchup)
    }

    function name_touchmove(evt) {
        evt.preventDefault()
        evt.stopPropagation()
        var t = mods_transform()
        for (var id in mods.ui.selected) {
            var div = document.getElementById(id)
            var dx = (evt.changedTouches[0].pageX - mods.ui.xstart) / t.s
            var dy = (evt.changedTouches[0].pageY - mods.ui.ystart) / t.s
            var newleft = parseFloat(div.dataset.left) + dx
            var newtop = parseFloat(div.dataset.top) + dy
            div.style.left = newleft + 'px'
            div.style.top = newtop + 'px'
            draw_links(id, mods.ui.link_color)
        }
    }

    function name_touchup(evt) {
        evt.preventDefault()
        evt.stopPropagation()
        var t = mods_transform()
        for (var id in mods.ui.selected) {
            var div = document.getElementById(id)
            div.style.zIndex = 0
            var dx = (evt.changedTouches[0].pageX - mods.ui.xstart) / t.s
            var dy = (evt.changedTouches[0].pageY - mods.ui.ystart) / t.s
            div.dataset.left = parseFloat(div.dataset.left) + dx
            div.dataset.top = parseFloat(div.dataset.top) + dy
            window.removeEventListener('touchmove', name_touchmove)
            window.removeEventListener('touchend', name_touchup)
        }
        mods.ui.selected = {}
    }
})()
var prog = JSON.parse(JSON.stringify({"modules":{"0.47383876715576023":{"definition":"//\n// distance transform \n//    assumes thresholded image, with zero intensity exterior\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2015,6\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the fab modules \n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'distance transform'\n//\n// initialization\n//\nvar init = function() {\n   }\n//\n// inputs\n//\nvar inputs = {\n   image:{type:'RGBA',\n      event:function(evt){\n         mod.input = evt.detail\n         var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.width = mod.input.width\n         ctx.canvas.height = mod.input.height \n         ctx.putImageData(mod.input,0,0)\n         distance_transform()}}}\n//\n// outputs\n//\nvar outputs = {\n   distances:{type:'F32',\n      event:function(){\n         mod.distances.height = mod.input.height\n         mod.distances.width = mod.input.width\n         mods.output(mod,'distances',mod.distances)}}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // on-screen drawing canvas\n   //\n   var canvas = document.createElement('canvas')\n      canvas.width = mods.ui.canvas\n      canvas.height = mods.ui.canvas\n      canvas.style.backgroundColor = 'rgb(255,255,255)'\n      div.appendChild(canvas)\n      mod.canvas = canvas\n   div.appendChild(document.createElement('br'))\n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   //\n   // view button\n   //\n   div.appendChild(document.createElement('br'))\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         var canvas = document.createElement('canvas')\n            canvas.width = mod.img.width\n            canvas.height = mod.img.height\n            win.document.body.appendChild(canvas)\n         var ctx = canvas.getContext(\"2d\")\n            ctx.drawImage(mod.img,0,0)\n         })\n      div.appendChild(btn)\n   }\n//\n// local functions\n//\n// distance transform function\n//\nfunction distance_transform() {\n   var blob = new Blob(['('+worker.toString()+'())'])\n   var url = window.URL.createObjectURL(blob)\n   var webworker = new Worker(url)\n   webworker.addEventListener('message',function(evt) {\n      window.URL.revokeObjectURL(url)\n      var h = mod.img.height\n      var w = mod.img.width\n      mod.distances = new Float32Array(evt.data.buffer)\n      var imgbuf = new Uint8ClampedArray(h*w*4)\n      var dmax = -Number.MAX_VALUE\n      for (var y = 0; y < h; ++y) {\n         for (var x = 0; x < w; ++x) {\n            if (mod.distances[(h-1-y)*w+x] > dmax)\n               dmax = mod.distances[(h-1-y)*w+x]\n            }\n         }\n      var i\n      for (var y = 0; y < h; ++y) {\n         for (var x = 0; x < w; ++x) {\n            i = 255*mod.distances[(h-1-y)*w+x]/dmax\n            imgbuf[(h-1-y)*w*4+x*4+0] = i\n            imgbuf[(h-1-y)*w*4+x*4+1] = i\n            imgbuf[(h-1-y)*w*4+x*4+2] = i\n            imgbuf[(h-1-y)*w*4+x*4+3] = 255\n            }\n         }\n      var imgdata = new ImageData(imgbuf,w,h)\n      var ctx = mod.img.getContext(\"2d\")\n      ctx.putImageData(imgdata,0,0)\n      if (w > h) {\n         var x0 = 0\n         var y0 = mod.canvas.height*.5*(1-h/w)\n         var wd = mod.canvas.width\n         var hd = mod.canvas.width*h/w\n         }\n      else {\n         var x0 = mod.canvas.width*.5*(1-w/h)\n         var y0 = 0\n         var wd = mod.canvas.height*w/h\n         var hd = mod.canvas.height\n         }\n      var ctx = mod.canvas.getContext(\"2d\")\n      ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n      ctx.drawImage(mod.img,x0,y0,wd,hd)\n      webworker.terminate()\n      outputs.distances.event()\n      })\n   var ctx = mod.canvas.getContext(\"2d\")\n   ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n   var ctx = mod.img.getContext(\"2d\")\n   ctx.putImageData(mod.input,0,0)\n   var img = ctx.getImageData(0,0,mod.img.width,mod.img.height)\n   webworker.postMessage({\n      height:mod.input.height,width:mod.input.width,\n      buffer:img.data.buffer},\n      [img.data.buffer])\n   }\n//\n// distance transform worker\n//\nfunction worker() {\n   self.addEventListener('message',function(evt) {\n      var ny = evt.data.height\n      var nx = evt.data.width\n      var input = new Uint8ClampedArray(evt.data.buffer)\n      var output = new Float32Array(nx*ny)\n      function distance(g,x,y,i) {\n         return ((y-i)*(y-i)+g[i][x]*g[i][x])\n         }\n      function intersection(g,x,y0,y1) {\n         return ((g[y0][x]*g[y0][x]-g[y1][x]*g[y1][x]+y0*y0-y1*y1)/(2.0*(y0-y1)))\n         }\n      //\n      // allocate arrays\n      //\n      var g = []\n      for (var y = 0; y < ny; ++y)\n         g[y] = new Uint32Array(nx)\n      var h = []\n      for (var y = 0; y < ny; ++y)\n         h[y] = new Uint32Array(nx)\n      var distances = []\n      for (var y = 0; y < ny; ++y)\n         distances[y] = new Uint32Array(nx)\n      var starts = new Uint32Array(ny)\n      var minimums = new Uint32Array(ny)\n      var d\n      //\n      // column scan\n      //  \n      for (var y = 0; y < ny; ++y) {\n         //\n         // right pass\n         //\n         var closest = -nx\n         for (var x = 0; x < nx; ++x) {\n            if (input[(ny-1-y)*nx*4+x*4+0] != 0) {\n               g[y][x] = 0\n               closest = x\n               }\n            else\n               g[y][x] = (x-closest)\n            }\n         //\n         // left pass\n         //\n         closest = 2*nx\n         for (var x = (nx-1); x >= 0; --x) {\n            if (input[(ny-1-y)*nx*4+x*4+0] != 0)\n               closest = x\n            else {\n               d = (closest-x)\n               if (d < g[y][x])\n                  g[y][x] = d\n               }\n            }\n         }\n      //\n      // row scan\n      //\n      for (var x = 0; x < nx; ++x) {\n         var segment = 0\n         starts[0] = 0\n         minimums[0] = 0\n         //\n         // down \n         //\n         for (var y = 1; y < ny; ++y) {\n            while ((segment >= 0) &&\n               (distance(g,x,starts[segment],minimums[segment]) > distance(g,x,starts[segment],y)))\n               segment -= 1\n            if (segment < 0) {\n               segment = 0\n               minimums[0] = y\n               }\n            else {\n               newstart = 1+intersection(g,x,minimums[segment],y)\n               if (newstart < ny) {\n                  segment += 1\n                  minimums[segment] = y\n                  starts[segment] = newstart\n                  }\n               }\n            }\n         //\n         // up \n         //\n         for (var y = (ny-1); y >= 0; --y) {\n            d = Math.sqrt(distance(g,x,y,minimums[segment]))\n            output[(ny-1-y)*nx+x] = d\n            if (y == starts[segment])\n               segment -= 1\n            }\n         }\n      self.postMessage({buffer:output.buffer},[output.buffer])\n      })\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"185.74448592296858","left":"2033.442778381016","filename":"undefined","inputs":{},"outputs":{}},"0.07944144280928633":{"definition":"//\n// edge detect\n//    green = interior, blue = exterior, red = boundary\n//    assumes input is thresholded\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2015,6\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the fab modules \n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'edge detect'\n//\n// initialization\n//\nvar init = function() {\n   }\n//\n// inputs\n//\nvar inputs = {\n   image:{type:'RGBA',\n      event:function(evt){\n         mod.input = evt.detail\n         var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.width = mod.input.width\n         ctx.canvas.height = mod.input.height \n         ctx.putImageData(mod.input,0,0)\n         edge_detect()}}}\n//\n// outputs\n//\nvar outputs = {\n   image:{type:'RGBA',\n      event:function(){\n         var ctx = mod.img.getContext(\"2d\")\n         var img = ctx.getImageData(0,0,mod.img.width,mod.img.height)\n         mods.output(mod,'image',img)}}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // on-screen drawing canvas\n   //\n   var canvas = document.createElement('canvas')\n      canvas.width = mods.ui.canvas\n      canvas.height = mods.ui.canvas\n      canvas.style.backgroundColor = 'rgb(255,255,255)'\n      div.appendChild(canvas)\n      mod.canvas = canvas\n   div.appendChild(document.createElement('br'))\n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   //\n   // view button\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         win.document.body.appendChild(document.createTextNode('green:interior, blue:exterior, red:boundary'))\n         win.document.body.appendChild(document.createElement('br'))\n         var canvas = document.createElement('canvas')\n            canvas.width = mod.img.width\n            canvas.height = mod.img.height\n            win.document.body.appendChild(canvas)\n         var ctx = canvas.getContext(\"2d\")\n            ctx.drawImage(mod.img,0,0)\n         })\n      div.appendChild(btn)\n   }\n//\n// local functions\n//\n// edge detect\n//\nfunction edge_detect() {\n   var blob = new Blob(['('+worker.toString()+'())'])\n   var url = window.URL.createObjectURL(blob)\n   var webworker = new Worker(url)\n   webworker.addEventListener('message',function(evt) {\n      window.URL.revokeObjectURL(url)\n      var h = mod.img.height\n      var w = mod.img.width\n      var buf = new Uint8ClampedArray(evt.data.buffer)\n      var imgdata = new ImageData(buf,w,h)\n      var ctx = mod.img.getContext(\"2d\")\n      ctx.putImageData(imgdata,0,0)\n      if (w > h) {\n         var x0 = 0\n         var y0 = mod.canvas.height*.5*(1-h/w)\n         var wd = mod.canvas.width\n         var hd = mod.canvas.width*h/w\n         }\n      else {\n         var x0 = mod.canvas.width*.5*(1-w/h)\n         var y0 = 0\n         var wd = mod.canvas.height*w/h\n         var hd = mod.canvas.height\n         }\n      var ctx = mod.canvas.getContext(\"2d\")\n      ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n      ctx.drawImage(mod.img,x0,y0,wd,hd)\n      webworker.terminate()\n      outputs.image.event()\n      })\n   var ctx = mod.canvas.getContext(\"2d\")\n   ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n   webworker.postMessage({worker:worker.toString(),\n      height:mod.input.height,width:mod.input.width,\n      buffer:mod.input.data.buffer},\n      [mod.input.data.buffer])\n   }\nfunction worker() {\n   self.addEventListener('message',function(evt) {\n      var h = evt.data.height\n      var w = evt.data.width\n      var input = new Uint8ClampedArray(evt.data.buffer)\n      var output = new Uint8ClampedArray(h*w*4)\n      var i00,i0m,i0p,im0,ip0,imm,imp,ipm,ipp,row,col\n      //\n      // find edges - interior\n      //\n      for (row = 1; row < (h-1); ++row) {\n         for (col = 1; col < (w-1); ++col) {\n            i00 = (input[(h-1-row)*w*4+col*4+0] \n                      +input[(h-1-row)*w*4+col*4+1] \n                      +input[(h-1-row)*w*4+col*4+2])\n            i0p = (input[(h-1-row)*w*4+(col+1)*4+0] \n                      +input[(h-1-row)*w*4+(col+1)*4+1] \n                      +input[(h-1-row)*w*4+(col+1)*4+2])\n            ip0 = (input[(h-2-row)*w*4+col*4+0] \n                      +input[(h-2-row)*w*4+col*4+1] \n                      +input[(h-2-row)*w*4+col*4+2])\n            ipp = (input[(h-2-row)*w*4+(col+1)*4+0] \n                      +input[(h-2-row)*w*4+(col+1)*4+1] \n                      +input[(h-2-row)*w*4+(col+1)*4+2])\n            i0m = (input[(h-1-row)*w*4+(col-1)*4+0] \n                      +input[(h-1-row)*w*4+(col-1)*4+1] \n                      +input[(h-1-row)*w*4+(col-1)*4+2])\n            im0 = (input[(h-row)*w*4+col*4+0] \n                      +input[(h-row)*w*4+col*4+1] \n                      +input[(h-row)*w*4+col*4+2])\n            imm = (input[(h-row)*w*4+(col-1)*4+0] \n                      +input[(h-row)*w*4+(col-1)*4+1] \n                      +input[(h-row)*w*4+(col-1)*4+2])\n            imp = (input[(h-row)*w*4+(col+1)*4+0] \n                      +input[(h-row)*w*4+(col+1)*4+1] \n                      +input[(h-row)*w*4+(col+1)*4+2])\n            ipm = (input[(h-2-row)*w*4+(col-1)*4+0] \n                      +input[(h-2-row)*w*4+(col-1)*4+1] \n                      +input[(h-2-row)*w*4+(col-1)*4+2])\n            if ((i00 != i0p) || (i00 != ip0) || (i00 != ipp) \n               || (i00 != i0m) || (i00 != im0) || (i00 != imm)\n               || (i00 != imp) || (i00 != ipm)) {\n               output[(h-1-row)*w*4+col*4+0] = 255\n               output[(h-1-row)*w*4+col*4+1] = 0\n               output[(h-1-row)*w*4+col*4+2] = 0\n               output[(h-1-row)*w*4+col*4+3] = 255\n               }\n            else if (i00 == 0) {\n               output[(h-1-row)*w*4+col*4+0] = 0\n               output[(h-1-row)*w*4+col*4+1] = 0\n               output[(h-1-row)*w*4+col*4+2] = 255\n               output[(h-1-row)*w*4+col*4+3] = 255\n               }\n            else {\n               output[(h-1-row)*w*4+col*4+0] = 0\n               output[(h-1-row)*w*4+col*4+1] = 255\n               output[(h-1-row)*w*4+col*4+2] = 0\n               output[(h-1-row)*w*4+col*4+3] = 255\n               }\n            }\n         }\n      //\n      // left and right edges\n      //\n      for (row = 1; row < (h-1); ++row) {\n         col = w-1\n         i00 = (input[(h-1-row)*w*4+col*4+0] \n                   +input[(h-1-row)*w*4+col*4+1] \n                   +input[(h-1-row)*w*4+col*4+2])\n         i0m = (input[(h-1-row)*w*4+(col-1)*4+0] \n                   +input[(h-1-row)*w*4+(col-1)*4+1] \n                   +input[(h-1-row)*w*4+(col-1)*4+2])\n         imm = (input[(h-row)*w*4+(col-1)*4+0] \n                   +input[(h-row)*w*4+(col-1)*4+1] \n                   +input[(h-row)*w*4+(col-1)*4+2])\n         ipm = (input[(h-2-row)*w*4+(col-1)*4+0] \n                   +input[(h-2-row)*w*4+(col-1)*4+1] \n                   +input[(h-2-row)*w*4+(col-1)*4+2])\n         im0 = (input[(h-row)*w*4+col*4+0] \n                   +input[(h-row)*w*4+col*4+1] \n                   +input[(h-row)*w*4+col*4+2])\n         ip0 = (input[(h-2-row)*w*4+col*4+0] \n                   +input[(h-2-row)*w*4+col*4+1] \n                   +input[(h-2-row)*w*4+col*4+2])\n        if ((i00 != i0m) || (i00 != ip0) || (i00 != ipm) \n           || (i00 != im0) || (i00 != imm)) {\n           output[(h-1-row)*w*4+col*4+0] = 255\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else if (i00 == 0) {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 255\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 255\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n         col = 0\n         i00 = (input[(h-1-row)*w*4+col*4+0] \n                   +input[(h-1-row)*w*4+col*4+1] \n                   +input[(h-1-row)*w*4+col*4+2])\n         i0p = (input[(h-1-row)*w*4+(col+1)*4+0] \n                   +input[(h-1-row)*w*4+(col+1)*4+1] \n                   +input[(h-1-row)*w*4+(col+1)*4+2])\n         imp = (input[(h-row)*w*4+(col+1)*4+0] \n                   +input[(h-row)*w*4+(col+1)*4+1] \n                   +input[(h-row)*w*4+(col+1)*4+2])\n         ipp = (input[(h-2-row)*w*4+(col+1)*4+0] \n                   +input[(h-2-row)*w*4+(col+1)*4+1] \n                   +input[(h-2-row)*w*4+(col+1)*4+2])\n         im0 = (input[(h-row)*w*4+col*4+0] \n                   +input[(h-row)*w*4+col*4+1] \n                   +input[(h-row)*w*4+col*4+2])\n         ip0 = (input[(h-2-row)*w*4+col*4+0] \n                   +input[(h-2-row)*w*4+col*4+1] \n                   +input[(h-2-row)*w*4+col*4+2])\n        if ((i00 != i0p) || (i00 != ip0) || (i00 != ipp) \n           || (i00 != im0) || (i00 != imp)) {\n           output[(h-1-row)*w*4+col*4+0] = 255\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else if (i00 == 0) {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 255\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 255\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n         }\n      //\n      // top and bottom edges\n      //\n      for (col = 1; col < (w-1); ++col) {\n         row = h-1\n         i00 = (input[(h-1-row)*w*4+col*4+0] \n                   +input[(h-1-row)*w*4+col*4+1] \n                   +input[(h-1-row)*w*4+col*4+2])\n         i0m = (input[(h-1-row)*w*4+(col-1)*4+0] \n                   +input[(h-1-row)*w*4+(col-1)*4+1] \n                   +input[(h-1-row)*w*4+(col-1)*4+2])\n         i0p = (input[(h-1-row)*w*4+(col+1)*4+0] \n                   +input[(h-1-row)*w*4+(col+1)*4+1] \n                   +input[(h-1-row)*w*4+(col+1)*4+2])\n         imm = (input[(h-row)*w*4+(col-1)*4+0] \n                   +input[(h-row)*w*4+(col-1)*4+1] \n                   +input[(h-row)*w*4+(col-1)*4+2])\n         im0 = (input[(h-row)*w*4+col*4+0] \n                   +input[(h-row)*w*4+col*4+1] \n                   +input[(h-row)*w*4+col*4+2])\n         imp = (input[(h-row)*w*4+(col+1)*4+0] \n                   +input[(h-row)*w*4+(col+1)*4+1] \n                   +input[(h-row)*w*4+(col+1)*4+2])\n        if ((i00 != i0m) || (i00 != i0p) || (i00 != imm) \n           || (i00 != im0) || (i00 != imp)) {\n           output[(h-1-row)*w*4+col*4+0] = 255\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else if (i00 == 0) {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 255\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 255\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n         row = 0\n         i00 = (input[(h-1-row)*w*4+col*4+0] \n                   +input[(h-1-row)*w*4+col*4+1] \n                   +input[(h-1-row)*w*4+col*4+2])\n         i0m = (input[(h-1-row)*w*4+(col-1)*4+0] \n                   +input[(h-1-row)*w*4+(col-1)*4+1] \n                   +input[(h-1-row)*w*4+(col-1)*4+2])\n         i0p = (input[(h-1-row)*w*4+(col+1)*4+0] \n                   +input[(h-1-row)*w*4+(col+1)*4+1] \n                   +input[(h-1-row)*w*4+(col+1)*4+2])\n         ipm = (input[(h-2-row)*w*4+(col-1)*4+0] \n                   +input[(h-2-row)*w*4+(col-1)*4+1] \n                   +input[(h-2-row)*w*4+(col-1)*4+2])\n         ip0 = (input[(h-2-row)*w*4+col*4+0] \n                   +input[(h-2-row)*w*4+col*4+1] \n                   +input[(h-2-row)*w*4+col*4+2])\n         ipp = (input[(h-2-row)*w*4+(col+1)*4+0] \n                   +input[(h-2-row)*w*4+(col+1)*4+1] \n                   +input[(h-2-row)*w*4+(col+1)*4+2])\n        if ((i00 != i0m) || (i00 != i0p) || (i00 != ipm) \n           || (i00 != ip0) || (i00 != ipp)) {\n           output[(h-1-row)*w*4+col*4+0] = 255\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else if (i00 == 0) {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 0\n           output[(h-1-row)*w*4+col*4+2] = 255\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n        else {\n           output[(h-1-row)*w*4+col*4+0] = 0\n           output[(h-1-row)*w*4+col*4+1] = 255\n           output[(h-1-row)*w*4+col*4+2] = 0\n           output[(h-1-row)*w*4+col*4+3] = 255\n           }\n         }\n      //\n      // corners\n      //\n      row = 0\n      col = 0\n      i00 = (input[(h-1-row)*w*4+col*4+0] \n                +input[(h-1-row)*w*4+col*4+1] \n                +input[(h-1-row)*w*4+col*4+2])\n      i0p = (input[(h-1-row)*w*4+(col+1)*4+0] \n                +input[(h-1-row)*w*4+(col+1)*4+1] \n                +input[(h-1-row)*w*4+(col+1)*4+2])\n      ip0 = (input[(h-2-row)*w*4+col*4+0] \n                +input[(h-2-row)*w*4+col*4+1] \n                +input[(h-2-row)*w*4+col*4+2])\n      ipp = (input[(h-2-row)*w*4+(col+1)*4+0] \n                +input[(h-2-row)*w*4+(col+1)*4+1] \n                +input[(h-2-row)*w*4+(col+1)*4+2])\n      if ((i00 != i0p) || (i00 != ip0) || (i00 != ipp)) {\n         output[(h-1-row)*w*4+col*4+0] = 255\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else if (i00 == 0) {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 255\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 255\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      row = 0\n      col = w-1\n      i00 = (input[(h-1-row)*w*4+col*4+0] \n                +input[(h-1-row)*w*4+col*4+1] \n                +input[(h-1-row)*w*4+col*4+2])\n      i0m = (input[(h-1-row)*w*4+(col-1)*4+0] \n                +input[(h-1-row)*w*4+(col-1)*4+1] \n                +input[(h-1-row)*w*4+(col-1)*4+2])\n      ip0 = (input[(h-2-row)*w*4+col*4+0] \n                +input[(h-2-row)*w*4+col*4+1] \n                +input[(h-2-row)*w*4+col*4+2])\n      ipm = (input[(h-2-row)*w*4+(col-1)*4+0] \n                +input[(h-2-row)*w*4+(col-1)*4+1] \n                +input[(h-2-row)*w*4+(col-1)*4+2])\n      if ((i00 != i0m) || (i00 != ip0) || (i00 != ipm)) {\n         output[(h-1-row)*w*4+col*4+0] = 255\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else if (i00 == 0) {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 255\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 255\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      row = h-1\n      col = 0\n      i00 = (input[(h-1-row)*w*4+col*4+0] \n                +input[(h-1-row)*w*4+col*4+1] \n                +input[(h-1-row)*w*4+col*4+2])\n      i0p = (input[(h-1-row)*w*4+(col+1)*4+0] \n                +input[(h-1-row)*w*4+(col+1)*4+1] \n                +input[(h-1-row)*w*4+(col+1)*4+2])\n      im0 = (input[(h-row)*w*4+col*4+0] \n                +input[(h-row)*w*4+col*4+1] \n                +input[(h-row)*w*4+col*4+2])\n      imp = (input[(h-row)*w*4+(col+1)*4+0] \n                +input[(h-row)*w*4+(col+1)*4+1] \n                +input[(h-row)*w*4+(col+1)*4+2])\n      if ((i00 != i0p) || (i00 != im0) || (i00 != imp)) {\n         output[(h-1-row)*w*4+col*4+0] = 255\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else if (i00 == 0) {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 255\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 255\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      row = h-1\n      col = w-1\n      i00 = (input[(h-1-row)*w*4+col*4+0] \n                +input[(h-1-row)*w*4+col*4+1] \n                +input[(h-1-row)*w*4+col*4+2])\n      i0m = (input[(h-1-row)*w*4+(col-1)*4+0] \n                +input[(h-1-row)*w*4+(col-1)*4+1] \n                +input[(h-1-row)*w*4+(col-1)*4+2])\n      im0 = (input[(h-row)*w*4+col*4+0] \n                +input[(h-row)*w*4+col*4+1] \n                +input[(h-row)*w*4+col*4+2])\n      imm = (input[(h-row)*w*4+(col-1)*4+0] \n                +input[(h-row)*w*4+(col-1)*4+1] \n                +input[(h-row)*w*4+(col-1)*4+2])\n      if ((i00 != i0m) || (i00 != im0) || (i00 != imm)) {\n         output[(h-1-row)*w*4+col*4+0] = 255\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else if (i00 == 0) {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 0\n         output[(h-1-row)*w*4+col*4+2] = 255\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      else {\n         output[(h-1-row)*w*4+col*4+0] = 0\n         output[(h-1-row)*w*4+col*4+1] = 255\n         output[(h-1-row)*w*4+col*4+2] = 0\n         output[(h-1-row)*w*4+col*4+3] = 255\n         }\n      self.postMessage({buffer:output.buffer},[output.buffer])\n      })\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"689.7402227997571","left":"3295.0641961905876","filename":"undefined","inputs":{},"outputs":{}},"0.8903773266711255":{"definition":"//\n// orient edges\n//    input is green:interior, blue:exterior, red:boundary\n//    output is red 128:north,64:south, green 128:east,64:west, blue 128:start,64:stop\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2016\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the fab modules \n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'orient edges'\n//\n// initialization\n//\nvar init = function() {\n   }\n//\n// inputs\n//\nvar inputs = {\n   image:{type:'RGBA',\n      event:function(evt){\n         mod.input = evt.detail\n         var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.width = mod.input.width\n         ctx.canvas.height = mod.input.height \n         ctx.putImageData(mod.input,0,0)\n         var ctx = mod.display.getContext(\"2d\")\n         ctx.canvas.width = mod.input.width\n         ctx.canvas.height = mod.input.height \n         orient_edges()\n         }}}\n//\n// outputs\n//\nvar outputs = {\n   image:{type:'RGBA',\n      event:function(){\n         var ctx = mod.img.getContext(\"2d\")\n         var img = ctx.getImageData(0,0,mod.img.width,mod.img.height)\n         mods.output(mod,'image',img)}}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // on-screen drawing canvas\n   //\n   var canvas = document.createElement('canvas')\n      canvas.width = mods.ui.canvas\n      canvas.height = mods.ui.canvas\n      canvas.style.backgroundColor = 'rgb(255,255,255)'\n      div.appendChild(canvas)\n      mod.canvas = canvas\n   div.appendChild(document.createElement('br'))\n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   //\n   // off-screen display canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.display = canvas\n   //\n   // view button\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         win.document.body.appendChild(document.createTextNode('red:north, dark red:south'))\n         win.document.body.appendChild(document.createElement('br'))\n         win.document.body.appendChild(document.createTextNode('green:east, dark green:west'))\n         win.document.body.appendChild(document.createElement('br'))\n         win.document.body.appendChild(document.createTextNode('blue:start, dark blue:stop'))\n         win.document.body.appendChild(document.createElement('br'))\n         var canvas = document.createElement('canvas')\n            canvas.width = mod.img.width\n            canvas.height = mod.img.height\n            win.document.body.appendChild(canvas)\n         var ctx = canvas.getContext(\"2d\")\n            ctx.drawImage(mod.display,0,0)\n         })\n      div.appendChild(btn)\n   }\n//\n// local functions\n//\n// orient edges\n//\nfunction orient_edges() {\n   var blob = new Blob(['('+worker.toString()+'())'])\n   var url = window.URL.createObjectURL(blob)\n   var webworker = new Worker(url)\n   webworker.addEventListener('message',function(evt) {\n      window.URL.revokeObjectURL(url)\n      var h = mod.img.height\n      var w = mod.img.width\n      var buf = new Uint8ClampedArray(evt.data.buffer)\n      var imgdata = new ImageData(buf,w,h)\n      var ctx = mod.img.getContext(\"2d\")\n      ctx.putImageData(imgdata,0,0)\n      var disp = new Uint8ClampedArray(evt.data.display)\n      var dispdata = new ImageData(disp,w,h)\n      var ctx = mod.display.getContext(\"2d\")\n      ctx.putImageData(dispdata,0,0)\n      if (w > h) {\n         var x0 = 0\n         var y0 = mod.canvas.height*.5*(1-h/w)\n         var wd = mod.canvas.width\n         var hd = mod.canvas.width*h/w\n         }\n      else {\n         var x0 = mod.canvas.width*.5*(1-w/h)\n         var y0 = 0\n         var wd = mod.canvas.height*w/h\n         var hd = mod.canvas.height\n         }\n      var w = mod.canvas.width\n      var h = mod.canvas.height\n      var ctx = mod.canvas.getContext(\"2d\")\n      ctx.clearRect(0,0,w,h)\n      ctx.drawImage(mod.display,x0,y0,wd,hd)\n      webworker.terminate()\n      outputs.image.event()\n      })\n   var ctx = mod.canvas.getContext(\"2d\")\n   ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n   webworker.postMessage({\n      height:mod.input.height,width:mod.input.width,\n      buffer:mod.input.data.buffer},\n      [mod.input.data.buffer])\n   }\nfunction worker() {\n   self.addEventListener('message',function(evt) {\n      var h = evt.data.height\n      var w = evt.data.width\n      var input = new Uint8ClampedArray(evt.data.buffer)\n      var output = new Uint8ClampedArray(h*w*4)\n      var row,col\n      var boundary = 0\n      var interior = 1\n      var exterior = 2\n      var alpha = 3\n      var northsouth = 0\n      var north = 128\n      var south = 64\n      var eastwest = 1\n      var east = 128\n      var west = 64\n      var startstop = 2\n      var start = 128\n      var stop = 64\n      //\n      // orient body states\n      //\n      for (row = 1; row < (h-1); ++row) {\n         for (col = 1; col < (w-1); ++col) {\n            output[(h-1-row)*w*4+col*4+northsouth] = 0\n            output[(h-1-row)*w*4+col*4+eastwest] = 0\n            output[(h-1-row)*w*4+col*4+startstop] = 0\n            output[(h-1-row)*w*4+col*4+alpha] = 255\n            if (input[(h-1-(row))*w*4+(col)*4+boundary] != 0) {\n               if ((input[(h-1-(row+1))*w*4+(col)*4+boundary] != 0)\n                  && ((input[(h-1-(row))*w*4+(col+1)*4+interior] != 0)\n                  || (input[(h-1-(row+1))*w*4+(col+1)*4+interior] != 0)))\n                  output[(h-1-row)*w*4+col*4+northsouth] |= north\n               if ((input[(h-1-(row-1))*w*4+(col)*4+boundary] != 0)\n                  && ((input[(h-1-(row))*w*4+(col-1)*4+interior] != 0)\n                  || (input[(h-1-(row-1))*w*4+(col-1)*4+interior] != 0)))\n                  output[(h-1-row)*w*4+col*4+northsouth] |= south\n               if ((input[(h-1-(row))*w*4+(col+1)*4+boundary] != 0)\n                  && ((input[(h-1-(row-1))*w*4+(col)*4+interior] != 0)\n                  || (input[(h-1-(row-1))*w*4+(col+1)*4+interior] != 0)))\n                  output[(h-1-row)*w*4+col*4+eastwest] |= east\n               if ((input[(h-1-(row))*w*4+(col-1)*4+boundary] != 0)\n                  && ((input[(h-1-(row+1))*w*4+(col)*4+interior] != 0)\n                  || (input[(h-1-(row+1))*w*4+(col-1)*4+interior] != 0)))\n                  output[(h-1-row)*w*4+col*4+eastwest] |= west\n               }\n            }\n         }\n      //\n      // orient edge states\n      //\n      for (col = 1; col < (w-1); ++col) {\n         row = 0\n         output[(h-1-row)*w*4+col*4+northsouth] = 0\n         output[(h-1-row)*w*4+col*4+eastwest] = 0\n         output[(h-1-row)*w*4+col*4+startstop] = 0\n         output[(h-1-row)*w*4+col*4+alpha] = 255\n         if (input[(h-1-(row))*w*4+(col)*4+boundary] != 0) {\n            if ((input[(h-1-(row+1))*w*4+(col)*4+boundary] != 0)\n               && (input[(h-1-(row))*w*4+(col+1)*4+interior] != 0)) {\n               output[(h-1-row)*w*4+col*4+northsouth] |= north\n               output[(h-1-row)*w*4+col*4+startstop] |= start\n               }\n            if (input[(h-1-(row))*w*4+(col-1)*4+interior] != 0)\n               output[(h-1-row)*w*4+col*4+startstop] |= stop\n            }\n         row = h-1\n         output[(h-1-row)*w*4+col*4+northsouth] = 0\n         output[(h-1-row)*w*4+col*4+eastwest] = 0\n         output[(h-1-row)*w*4+col*4+startstop] = 0\n         output[(h-1-row)*w*4+col*4+alpha] = 255\n         if (input[(h-1-(row))*w*4+(col)*4+boundary] != 0) {\n            if (input[(h-1-(row))*w*4+(col+1)*4+interior] != 0)\n               output[(h-1-row)*w*4+col*4+startstop] |= stop\n            if ((input[(h-1-(row-1))*w*4+(col)*4+boundary] != 0)\n               && (input[(h-1-(row))*w*4+(col-1)*4+interior] != 0)) {\n               output[(h-1-row)*w*4+col*4+northsouth] |= south\n               output[(h-1-row)*w*4+col*4+startstop] |= start\n               }\n            }\n         }\n      for (row = 1; row < (h-1); ++row) {\n         col = 0\n         output[(h-1-row)*w*4+col*4+northsouth] = 0\n         output[(h-1-row)*w*4+col*4+eastwest] = 0\n         output[(h-1-row)*w*4+col*4+startstop] = 0\n         output[(h-1-row)*w*4+col*4+alpha] = 255\n         if (input[(h-1-(row))*w*4+(col)*4+boundary] != 0) {\n            if ((input[(h-1-(row))*w*4+(col+1)*4+boundary] != 0)\n               && (input[(h-1-(row-1))*w*4+(col)*4+interior] != 0)) {\n               output[(h-1-row)*w*4+col*4+eastwest] |= east\n               output[(h-1-row)*w*4+col*4+startstop] |= start\n               }\n            if (input[(h-1-(row+1))*w*4+(col)*4+interior] != 0)\n               output[(h-1-row)*w*4+col*4+startstop] |= stop\n            }\n         col = w-1\n         output[(h-1-row)*w*4+col*4+northsouth] = 0\n         output[(h-1-row)*w*4+col*4+eastwest] = 0\n         output[(h-1-row)*w*4+col*4+startstop] = 0\n         output[(h-1-row)*w*4+col*4+alpha] = 255\n         if (input[(h-1-(row))*w*4+(col)*4+boundary] != 0) {\n            if (input[(h-1-(row-1))*w*4+(col)*4+interior] != 0)\n               output[(h-1-row)*w*4+col*4+startstop] |= stop\n            if ((input[(h-1-(row))*w*4+(col-1)*4+boundary] != 0)\n               && (input[(h-1-(row+1))*w*4+(col)*4+interior] != 0)) {\n               output[(h-1-row)*w*4+col*4+eastwest] |= west\n               output[(h-1-row)*w*4+col*4+startstop] |= start\n               }\n            }\n         }\n      //\n      // orient corner states (todo)\n      //\n      row = 0\n      col = 0\n      output[(h-1-row)*w*4+col*4+northsouth] = 0\n      output[(h-1-row)*w*4+col*4+eastwest] = 0\n      output[(h-1-row)*w*4+col*4+startstop] = 0\n      output[(h-1-row)*w*4+col*4+alpha] = 255\n      row = h-1\n      col = 0\n      output[(h-1-row)*w*4+col*4+northsouth] = 0\n      output[(h-1-row)*w*4+col*4+eastwest] = 0\n      output[(h-1-row)*w*4+col*4+startstop] = 0\n      output[(h-1-row)*w*4+col*4+alpha] = 255\n      row = 0\n      col = w-1\n      output[(h-1-row)*w*4+col*4+northsouth] = 0\n      output[(h-1-row)*w*4+col*4+eastwest] = 0\n      output[(h-1-row)*w*4+col*4+startstop] = 0\n      output[(h-1-row)*w*4+col*4+alpha] = 255\n      row = h-1\n      col = w-1\n      output[(h-1-row)*w*4+col*4+northsouth] = 0\n      output[(h-1-row)*w*4+col*4+eastwest] = 0\n      output[(h-1-row)*w*4+col*4+startstop] = 0\n      output[(h-1-row)*w*4+col*4+alpha] = 255\n      //\n      // invert background for display\n      //\n      var display = new Uint8ClampedArray(h*w*4)\n      var r,g,b,i\n      for (row = 0; row < h; ++row) {\n         for (col = 0; col < w; ++col) {\n            r = output[(h-1-row)*w*4+col*4+0]\n            g = output[(h-1-row)*w*4+col*4+1]\n            b = output[(h-1-row)*w*4+col*4+2]\n            i = r+g+b\n            if (i != 0) {            \n               display[(h-1-row)*w*4+col*4+0] = output[(h-1-row)*w*4+col*4+0]\n               display[(h-1-row)*w*4+col*4+1] = output[(h-1-row)*w*4+col*4+1]\n               display[(h-1-row)*w*4+col*4+2] = output[(h-1-row)*w*4+col*4+2]\n               display[(h-1-row)*w*4+col*4+3] = output[(h-1-row)*w*4+col*4+3]\n               }\n            else {\n               display[(h-1-row)*w*4+col*4+0] = 255\n               display[(h-1-row)*w*4+col*4+1] = 255\n               display[(h-1-row)*w*4+col*4+2] = 255\n               display[(h-1-row)*w*4+col*4+3] = 255\n               }\n            }\n         }\n      //\n      // return output\n      //\n      self.postMessage({buffer:output.buffer,display:display.buffer},[output.buffer,display.buffer])\n      })\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"673.7315355670186","left":"2690.783000750821","filename":"undefined","inputs":{},"outputs":{}},"0.3135579179893032":{"definition":"//\n// distance transform \n//    assumes thresholded image, with zero intensity exterior\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2015,6\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the fab modules \n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'offset'\n//\n// initialization\n//\nvar init = function() {\n   mod.offset.value = ''\n   }\n//\n// inputs\n//\nvar inputs = {\n   distances:{type:'F32',\n      event:function(evt){\n         mod.distances = evt.detail\n         var h = mod.distances.height\n         var w = mod.distances.width\n         var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.height = mod.distances.height \n         ctx.canvas.width = mod.distances.width\n         if (mod.offset.value != '')\n            offset()\n         }},\n   offset:{type:'number',\n      event:function(evt){\n         mod.offset.value = evt.detail\n         offset()}}}\n//\n// outputs\n//\nvar outputs = {\n   image:{type:'RGBA',\n      event:function(){\n         var ctx = mod.img.getContext(\"2d\")\n         var img = ctx.getImageData(0,0,mod.img.width,mod.img.height)\n         mods.output(mod,'image',img)}}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // on-screen drawing canvas\n   //\n   var canvas = document.createElement('canvas')\n      canvas.width = mods.ui.canvas\n      canvas.height = mods.ui.canvas\n      canvas.style.backgroundColor = 'rgb(255,255,255)'\n      div.appendChild(canvas)\n      mod.canvas = canvas\n   div.appendChild(document.createElement('br'))\n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   //\n   // offset value\n   //\n   div.appendChild(document.createTextNode('offset (pixels): '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('change',function(){\n         offset()\n         })\n      div.appendChild(input)\n      mod.offset = input\n   //\n   // view button\n   //\n   div.appendChild(document.createElement('br'))\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         var canvas = document.createElement('canvas')\n            canvas.width = mod.img.width\n            canvas.height = mod.img.height\n            win.document.body.appendChild(canvas)\n         var ctx = canvas.getContext(\"2d\")\n            ctx.drawImage(mod.img,0,0)\n         })\n      div.appendChild(btn)\n   }\n//\n// local functions\n//\n// offset\n//\nfunction offset() {\n   var blob = new Blob(['('+worker.toString()+'())'])\n   var url = window.URL.createObjectURL(blob)\n   var webworker = new Worker(url)\n   webworker.addEventListener('message',function(evt) {\n      window.URL.revokeObjectURL(url)\n      var h = mod.distances.height\n      var w = mod.distances.width\n      var buf = new Uint8ClampedArray(evt.data.buffer)\n      var imgdata = new ImageData(buf,w,h)\n      var ctx = mod.img.getContext(\"2d\")\n      ctx.putImageData(imgdata,0,0)\n      if (w > h) {\n         var x0 = 0\n         var y0 = mod.canvas.height*.5*(1-h/w)\n         var wd = mod.canvas.width\n         var hd = mod.canvas.width*h/w\n         }\n      else {\n         var x0 = mod.canvas.width*.5*(1-w/h)\n         var y0 = 0\n         var wd = mod.canvas.height*w/h\n         var hd = mod.canvas.height\n         }\n      var ctx = mod.canvas.getContext(\"2d\")\n      ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n      ctx.drawImage(mod.img,x0,y0,wd,hd)\n      webworker.terminate()\n      outputs.image.event()\n      })\n   var ctx = mod.canvas.getContext(\"2d\")\n   ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n   var offset = parseFloat(mod.offset.value)\n   webworker.postMessage({\n      height:mod.distances.height,width:mod.distances.width,\n      offset:offset,buffer:mod.distances.buffer})\n   }\n//\n// offset worker\n//\nfunction worker() {\n   self.addEventListener('message',function(evt) {\n      var h = evt.data.height\n      var w = evt.data.width\n      var offset = evt.data.offset\n      var input = new Float32Array(evt.data.buffer)\n      var output = new Uint8ClampedArray(4*h*w)\n      for (var row = 0; row < h; ++row) {\n         for (var col = 0; col < w; ++col) {\n            if (input[(h-1-row)*w+col] <= offset) {\n               output[(h-1-row)*w*4+col*4+0] = 255\n               output[(h-1-row)*w*4+col*4+1] = 255\n               output[(h-1-row)*w*4+col*4+2] = 255\n               output[(h-1-row)*w*4+col*4+3] = 255\n               }\n            else {\n               output[(h-1-row)*w*4+col*4+0] = 0\n               output[(h-1-row)*w*4+col*4+1] = 0\n               output[(h-1-row)*w*4+col*4+2] = 0\n               output[(h-1-row)*w*4+col*4+3] = 255\n               }\n            }\n         }\n      self.postMessage({buffer:output.buffer},[output.buffer])\n      })\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"199.64409606063782","left":"2690.4536555055683","filename":"undefined","inputs":{},"outputs":{}},"0.08127540142793499":{"definition":"//\n// read png\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2015,6\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the fab modules \n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'read png'\n//\n// initialization\n//\nvar init = function() {\n   }\n//\n// inputs\n//\nvar inputs = {\n   }\n//\n// outputs\n//\nvar outputs = {\n   image:{type:'RGBA',\n      event:function(){\n         var ctx = mod.img.getContext(\"2d\")\n         var img = ctx.getImageData(0,0,mod.img.width,mod.img.height)\n         mods.output(mod,'image',img)}},\n   imageInfo:{type:'object',\n      event:function(){\n         var obj = {}\n         obj.name = mod.name.nodeValue\n         obj.dpi = parseFloat(mod.dpitext.value)\n         obj.width = mod.img.width\n         obj.height = mod.img.height\n         mods.output(mod,'imageInfo',obj)}}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // file input control\n   //\n   var file = document.createElement('input')\n      file.setAttribute('type','file')\n      file.setAttribute('id',div.id+'file_input')\n      file.style.position = 'absolute'\n      file.style.left = 0\n      file.style.top = 0\n      file.style.width = 0\n      file.style.height = 0\n      file.style.opacity = 0\n      file.addEventListener('change',function() {\n         png_read_handler()\n         })\n      div.appendChild(file)\n      mod.file = file\n   //\n   // on-screen drawing canvas\n   //\n   var canvas = document.createElement('canvas')\n      canvas.width = mods.ui.canvas\n      canvas.height = mods.ui.canvas\n      canvas.style.backgroundColor = 'rgb(255,255,255)'\n      div.appendChild(canvas)\n      mod.canvas = canvas\n   div.appendChild(document.createElement('br'))\n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   //\n   // file select button\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('select png file'))\n      btn.addEventListener('click',function(){\n         var file = document.getElementById(div.id+'file_input')\n         file.value = null\n         file.click()\n         })\n      div.appendChild(btn)\n   div.appendChild(document.createElement('br'))\n   //\n   // view button\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         var canvas = document.createElement('canvas')\n            canvas.width = mod.img.width\n            canvas.height = mod.img.height\n            win.document.body.appendChild(canvas)\n         var ctx = canvas.getContext(\"2d\")\n            ctx.drawImage(mod.img,0,0)\n         })\n      div.appendChild(btn)\n   div.appendChild(document.createTextNode(' '))\n   //\n   // invert button\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('invert'))\n      btn.addEventListener('click',function(){\n         invert_image()\n         })\n      div.appendChild(btn)\n   div.appendChild(document.createElement('br'))\n   //\n   // info div\n   //\n   var info = document.createElement('div')\n      info.setAttribute('id',div.id+'info')\n      info.appendChild(document.createTextNode('dpi: '))\n      var input = document.createElement('input')\n         input.type = 'text'\n         input.size = 6\n         input.addEventListener('input',function(){\n            mod.dpi = parseFloat(mod.dpitext.value)\n            mod.mmtext.nodeValue = (25.4*mod.img.width/mod.dpi).toFixed(3)\n               +' x '+(25.4*mod.img.height/mod.dpi).toFixed(3)+' mm'\n            mod.intext.nodeValue = (mod.img.width/mod.dpi).toFixed(3)\n               +' x '+(mod.img.height/mod.dpi).toFixed(3)+' in'\n            outputs.imageInfo.event()\n            })\n         info.appendChild(input)\n         mod.dpitext = input\n      info.appendChild(document.createElement('br'))\n      var text = document.createTextNode('px: ')\n         info.appendChild(text)\n         mod.pxtext = text\n      info.appendChild(document.createElement('br'))\n      var text = document.createTextNode('mm: ')\n         info.appendChild(text)\n         mod.mmtext = text\n      info.appendChild(document.createElement('br'))\n      var text = document.createTextNode('in: ')\n         info.appendChild(text)\n         mod.intext = text\n      info.appendChild(document.createElement('br'))\n      var text = document.createTextNode('')\n         info.appendChild(text)\n         mod.name = text\n      div.appendChild(info)\n   }\n//\n// local functions\n//\n// read handler\n//\nfunction png_read_handler(event) {\n   var file_reader = new FileReader()\n   file_reader.onload = png_binary_handler\n   input_file = mod.file.files[0]\n   file_name = input_file.name\n   mod.name.nodeValue = file_name\n   file_reader.readAsArrayBuffer(input_file)\n   }\n//\n// binary load handler\n//\nfunction png_binary_handler(event) {\n   //\n   // get DPI\n   //\n   // 8 header\n   // 4 len, 4 type, data, 4 crc\n   // pHYs 4 ppx, 4 ppy, 1 unit: 0 ?, 1 meter\n   // IEND\n   //\n   var units = ppx = ppy = 0\n   var buf = event.target.result\n   var view = new DataView(buf)\n   var ptr = 8\n   if (!((view.getUint8(1) == 80) && (view.getUint8(2) == 78) && (view.getUint8(3) == 71))) {\n      set_prompt(\"error: PNG header not found\")\n      return\n      }\n   while (1) {\n      var length = view.getUint32(ptr)\n      ptr += 4\n      var type = String.fromCharCode(\n         view.getUint8(ptr),view.getUint8(ptr+1),\n         view.getUint8(ptr+2),view.getUint8(ptr+3))\n      ptr += 4\n      if (type == \"pHYs\") {\n         ppx = view.getUint32(ptr)\n         ppy = view.getUint32(ptr + 4)\n         units = view.getUint8(ptr + 8)\n         }\n      if (type == \"IEND\")\n         break\n      ptr += length + 4\n      }\n   if (units == 0) {\n      set_prompt(\"no PNG units not found, assuming 72 DPI\")\n      ppx = 72*1000/25.4\n      }\n   dpi = ppx*25.4/1000\n   //\n   // read as URL for display\n   //\n   var file_reader = new FileReader()\n   file_reader.onload = png_URL_handler\n   file_reader.readAsDataURL(input_file)\n   }\n//\n// URL load handler\n//\nfunction png_URL_handler(event) {\n   var img = new Image()\n   img.setAttribute(\"src\",event.target.result)\n   img.onload = function() {\n      if (img.width > img.height) {\n         var x0 = 0\n         var y0 = mod.canvas.height*.5*(1-img.height/img.width)\n         var w = mod.canvas.width\n         var h = mod.canvas.width*img.height/img.width\n         }\n      else {\n         var x0 = mod.canvas.width*.5*(1-img.width/img.height)\n         var y0 = 0\n         var w = mod.canvas.height*img.width/img.height\n         var h = mod.canvas.height\n         }\n      var ctx = mod.canvas.getContext(\"2d\")\n         ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n         ctx.drawImage(img,x0,y0,w,h)\n      var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.width = img.width\n         ctx.canvas.height = img.height \n         ctx.drawImage(img,0,0)\n      mod.dpitext.value = dpi.toFixed(3)\n      mod.pxtext.nodeValue = img.width+' x '+img.height+' px'\n      mod.mmtext.nodeValue = (25.4*img.width/dpi).toFixed(3)\n         +' x '+(25.4*img.height/dpi).toFixed(3)+' mm'\n      mod.intext.nodeValue = (img.width/dpi).toFixed(3)\n         +' x '+(img.height/dpi).toFixed(3)+' in'\n      outputs.image.event()\n      outputs.imageInfo.event()\n      }\n   }\n//\n// invert image\n//\nfunction invert_image() {\n   var blob = new Blob(['('+worker.toString()+'())'])\n   var url = window.URL.createObjectURL(blob)\n   var webworker = new Worker(url)\n   webworker.addEventListener('message',function(evt) {\n      window.URL.revokeObjectURL(url)\n      var h = mod.img.height\n      var w = mod.img.width\n      var buf = new Uint8ClampedArray(evt.data.buffer)\n      var imgdata = new ImageData(buf,w,h)\n      var ctx = mod.img.getContext(\"2d\")\n      ctx.putImageData(imgdata,0,0)\n      if (w > h) {\n         var x0 = 0\n         var y0 = mod.canvas.height*.5*(1-h/w)\n         var wd = mod.canvas.width\n         var hd = mod.canvas.width*h/w\n         }\n      else {\n         var x0 = mod.canvas.width*.5*(1-w/h)\n         var y0 = 0\n         var wd = mod.canvas.height*w/h\n         var hd = mod.canvas.height\n         }\n      var ctx = mod.canvas.getContext(\"2d\")\n      ctx.drawImage(mod.img,x0,y0,wd,hd)\n      webworker.terminate()\n      outputs.image.event()\n      })\n   var ctx = mod.canvas.getContext(\"2d\")\n   ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n   var h = mod.img.height\n   var w = mod.img.width\n   var ctx = mod.img.getContext(\"2d\")\n   var img = ctx.getImageData(0,0,w,h)\n   webworker.postMessage({\n      height:img.height,width:img.width,buffer:img.data.buffer},\n      [img.data.buffer])\n   }\nfunction worker() {\n   self.addEventListener('message',function(evt) {\n      var h = evt.data.height\n      var w = evt.data.width\n      var buf = new Uint8ClampedArray(evt.data.buffer)\n      for (var row = 0; row < h; ++row) {\n         for (var col = 0; col < w; ++col) {\n            buf[(h-1-row)*w*4+col*4+0] \n               = 255-buf[(h-1-row)*w*4+col*4+0] \n            buf[(h-1-row)*w*4+col*4+1] \n               = 255-buf[(h-1-row)*w*4+col*4+1] \n            buf[(h-1-row)*w*4+col*4+2] \n               = 255-buf[(h-1-row)*w*4+col*4+2] \n            buf[(h-1-row)*w*4+col*4+3] = 255\n            }\n         }\n      self.postMessage({buffer:buf.buffer},[buf.buffer])\n      })\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"192.764325632324","left":"140.50076703692605","filename":"undefined","inputs":{},"outputs":{}},"0.6488303557466412":{"definition":"//\n// image threshold\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2015,6\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the fab modules \n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'image threshold'\n//\n// initialization\n//\nvar init = function() {\n   mod.threshold.value = 0.5\n   }\n//\n// inputs\n//\nvar inputs = {\n   image:{type:'RGBA',\n      event:function(evt){\n         mod.input = evt.detail\n         var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.width = mod.input.width\n         ctx.canvas.height = mod.input.height \n         ctx.putImageData(mod.input,0,0)\n         threshold_image()}}}\n//\n// outputs\n//\nvar outputs = {\n   image:{type:'RGBA',\n      event:function(){\n         var ctx = mod.img.getContext(\"2d\")\n         var img = ctx.getImageData(0,0,mod.img.width,mod.img.height)\n         mods.output(mod,'image',img)}}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // on-screen drawing canvas\n   //\n   var canvas = document.createElement('canvas')\n      canvas.width = mods.ui.canvas\n      canvas.height = mods.ui.canvas\n      canvas.style.backgroundColor = 'rgb(255,255,255)'\n      div.appendChild(canvas)\n      mod.canvas = canvas\n   div.appendChild(document.createElement('br'))\n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   //\n   // threshold value\n   //\n   div.appendChild(document.createTextNode('threshold (0-1): '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('change',function(){\n         threshold_image()\n         })\n      div.appendChild(input)\n      mod.threshold = input\n   div.appendChild(document.createElement('br'))\n   //\n   // view button\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         var canvas = document.createElement('canvas')\n            canvas.width = mod.img.width\n            canvas.height = mod.img.height\n            win.document.body.appendChild(canvas)\n         var ctx = canvas.getContext(\"2d\")\n            ctx.drawImage(mod.img,0,0)\n         })\n      div.appendChild(btn)\n   }\n//\n// local functions\n//\n// threshold image\n//\nfunction threshold_image() {\n   var blob = new Blob(['('+worker.toString()+'())'])\n   var url = window.URL.createObjectURL(blob)\n   var webworker = new Worker(url)\n   webworker.addEventListener('message',function(evt) {\n      window.URL.revokeObjectURL(url)\n      var h = mod.img.height\n      var w = mod.img.width\n      var buf = new Uint8ClampedArray(evt.data.buffer)\n      var imgdata = new ImageData(buf,w,h)\n      var ctx = mod.img.getContext(\"2d\")\n      ctx.putImageData(imgdata,0,0)\n      if (w > h) {\n         var x0 = 0\n         var y0 = mod.canvas.height*.5*(1-h/w)\n         var wd = mod.canvas.width\n         var hd = mod.canvas.width*h/w\n         }\n      else {\n         var x0 = mod.canvas.width*.5*(1-w/h)\n         var y0 = 0\n         var wd = mod.canvas.height*w/h\n         var hd = mod.canvas.height\n         }\n      var ctx = mod.canvas.getContext(\"2d\")\n      ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n      ctx.drawImage(mod.img,x0,y0,wd,hd)\n      webworker.terminate()\n      outputs.image.event()\n      })\n   var ctx = mod.canvas.getContext(\"2d\")\n   ctx.clearRect(0,0,mod.canvas.width,mod.canvas.height)\n   var t = parseFloat(mod.threshold.value)\n   var ctx = mod.img.getContext(\"2d\")\n   ctx.putImageData(mod.input,0,0)\n   var img = ctx.getImageData(0,0,mod.img.width,mod.img.height)\n   webworker.postMessage({\n      height:mod.input.height,width:mod.input.width,threshold:t,\n      buffer:img.data.buffer},\n      [img.data.buffer])\n   }\nfunction worker() {\n   self.addEventListener('message',function(evt) {\n      var h = evt.data.height\n      var w = evt.data.width\n      var t = evt.data.threshold\n      var buf = new Uint8ClampedArray(evt.data.buffer)\n      var r,g,b,a,i\n      for (var row = 0; row < h; ++row) {\n         for (var col = 0; col < w; ++col) {\n            r = buf[(h-1-row)*w*4+col*4+0] \n            g = buf[(h-1-row)*w*4+col*4+1] \n            b = buf[(h-1-row)*w*4+col*4+2] \n            a = buf[(h-1-row)*w*4+col*4+3] \n            i = (r+g+b)/(3*255)\n            if (a == 0)\n               val = 255\n            else if (i > t)\n               var val = 255\n            else\n               var val = 0\n            buf[(h-1-row)*w*4+col*4+0] = val\n            buf[(h-1-row)*w*4+col*4+1] = val\n            buf[(h-1-row)*w*4+col*4+2] = val\n            buf[(h-1-row)*w*4+col*4+3] = 255\n            }\n         }\n      self.postMessage({buffer:buf.buffer},[buf.buffer])\n      })\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"210.56594577012612","left":"708.431002405259","filename":"undefined","inputs":{},"outputs":{}},"0.2892270043957246":{"definition":"//\n// view toolpath\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2016\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// todo:\n//    erase and update new path\n//    show depth info\n//    show size\n//    calculate camera far\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'view toolpath'\n//\n// initialization\n//\nvar init = function() {\n   }\n//\n// inputs\n//\nvar inputs = {\n   toolpath:{type:'object',\n      event:function(evt){\n         mod.path = evt.detail.path\n         mod.name = evt.detail.name\n         mod.dpi = evt.detail.dpi\n         mod.width = evt.detail.width\n         mod.height = evt.detail.height\n         mod.depth = evt.detail.depth\n         show_path_info()\n         show_path()\n         outputs.toolpath.event()\n         }}}\n//\n// outputs\n//\nvar outputs = {\n   toolpath:{type:'object',\n      event:function(){\n         cmd = {}\n         cmd.path = mod.path\n         cmd.name = mod.name\n         cmd.dpi = mod.dpi\n         cmd.width = mod.width\n         cmd.height = mod.height\n         mods.output(mod,'toolpath',cmd)\n         }}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // info\n   //\n   var text = document.createTextNode('name: ')\n      div.appendChild(text)\n      mod.nametext = text\n   div.appendChild(document.createElement('br'))\n   var text = document.createTextNode('(mm)')\n      div.appendChild(text)\n      mod.mmtext = text\n   div.appendChild(document.createElement('br'))\n   var text = document.createTextNode('(in)')\n      div.appendChild(text)\n      mod.intext = text\n   //\n   // view\n   //   \n   div.appendChild(document.createElement('br'))   \n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      var span = document.createElement('span')\n         var text = document.createTextNode('view')\n            span.appendChild(text)\n         btn.appendChild(span)\n      btn.addEventListener('click',function(){\n         open_view_window()\n         })\n      div.appendChild(btn)\n   }\n//\n// local functions\n//\n// show_path_info\n//\nfunction show_path_info() {\n   mod.nametext.nodeValue = 'name: '+mod.name\n   var width = (25.4*mod.width/mod.dpi).toFixed(3)\n   var height = (25.4*mod.height/mod.dpi).toFixed(3)\n   var depth = (25.4*mod.depth/mod.dpi).toFixed(3)\n   if (mod.depth == undefined)\n      mod.mmtext.nodeValue = width+' x '+height+' (mm)'\n   else\n      mod.mmtext.nodeValue = width+' x '+height+' x '+depth+' (mm)'\n   var width = (mod.width/mod.dpi).toFixed(3)\n   var height = (mod.height/mod.dpi).toFixed(3)\n   var depth = (mod.depth/mod.dpi).toFixed(3)\n   if (mod.depth == undefined)\n      mod.intext.nodeValue = width+' x '+height+' (in)'\n   else\n      mod.intext.nodeValue = width+' x '+height+' x '+depth+' (in)'\n   mods.fit(mod.div)\n   }\n//\n// show_path\n//\nfunction show_path() {\n   var scene = mod.scene\n   var camera = mod.camera\n   var renderer = mod.renderer\n   //\n   // check if view window open\n   //\n   if (mod.win == undefined) {\n      open_view_window()\n      return\n      }\n   //\n   // check for path\n   //\n   if (mod.path == undefined)\n      return\n   //\n   // clear scene, leave camera\n   //\n   var length = scene.children.length\n   for (var c = (length-1); c > 1; --c) {\n      scene.remove(scene.children[c])\n      }\n   //\n   // fit camera\n   //\n   mod.thetaxy = 0\n   mod.thetaz = 0\n   mod.r = mod.height/2\n   mod.x0 = mod.width/2\n   mod.y0 = mod.height/2\n   camera.position.set(mod.x0,mod.y0,mod.r)\n   camera.up = new THREE.Vector3(0,1,0)\n   camera.lookAt(new THREE.Vector3(mod.x0,mod.y0,0))\n   camera.updateProjectionMatrix()\n   //\n   // draw segments\n   //\n   var arrow_size = 1+mod.width/200\n   var path = mod.path\n   for (var segment = 0; segment < path.length; ++segment) {\n      if (segment > 0)\n         add_arrow(path[segment-1][path[segment-1].length-1],path[segment][0],0xff0000,arrow_size)         \n      for (var point = 1; point < path[segment].length; ++point) {\n         add_arrow(path[segment][point-1],path[segment][point],0x0000ff,arrow_size)\n         }\n      }\n   //\n   // add axes\n   //\n   var length = mod.height/10\n   add_arrow([0,0,0],[length,0,0],0xff0000,arrow_size)\n   add_arrow([0,0,0],[0,length,0],0x00ff00,arrow_size)\n   add_arrow([0,0,0],[0,0,length],0x0000ff,arrow_size)\n   //\n   // render\n   //\n   update()\n   //\n   // add_arrow\n   //\n   function add_arrow(start,stop,color,size) {\n      var origin = new THREE.Vector3().fromArray(start)\n      if (mod.depth == undefined)\n         origin.z = 0\n      var end  = new THREE.Vector3().fromArray(stop)\n      if (mod.depth == undefined)\n         end.z = 0\n      var length = new THREE.Vector3().subVectors(end,origin).length()\n      if (length <= size) {\n         add_line(origin,end,color)\n         //length = 1.1*size\n         return\n         }\n      var direction = new THREE.Vector3().subVectors(end,origin).normalize()\n      var arrow = new THREE.ArrowHelper(direction,origin,length,color,size,size)\n      scene.add(arrow)\n      }\n   //\n   // add_line\n   //\n   function add_line(start,stop,colorhex) {\n      var geometry = new THREE.Geometry()\n      geometry.vertices.push(start,stop)\n      var material = new THREE.LineBasicMaterial({color:colorhex})\n      var line = new THREE.Line(geometry,material)\n      scene.add(line)\n      }\n   //\n   // update\n   //\n   function update() {\n\t   renderer.render(scene,camera)\n      }\n   }\n//\n// open_view_window\n//\nfunction open_view_window() {\n   //\n   // globals\n   //\n   var container,scene,camera,renderer,win,controls\n   //\n   // open the window\n   //\n   open_window()\n   //\n   // open_window\n   //\n   function open_window() {\n      //\n      // open window\n      //\n      win = window.open('')\n      mod.win = win\n      //\n      // load three.js\n      //\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.onload = init_window\n      script.src = 'js/three.js/three.min.js'\n      mod.div.appendChild(script)\n      }\n   //\n   // init_window\n   //\n   function init_window() {\n      //\n      // close button\n      //\n      var btn = document.createElement('button')\n         btn.appendChild(document.createTextNode('close'))\n         btn.style.padding = mods.ui.padding\n         btn.style.margin = 1\n         btn.addEventListener('click',function(){\n            win.close()\n            mod.win = undefined\n            })\n         win.document.body.appendChild(btn)\n      //\n      // label text\n      //\n      var text = win.document.createTextNode(' left: pan, right: rotate, scroll: zoom')\n         win.document.body.appendChild(text)\n      //\n      // GL container\n      //\n      win.document.body.appendChild(document.createElement('br'))   \n      container = win.document.createElement('div')\n      container.style.overflow = 'hidden'\n      win.document.body.appendChild(container)\n      //\n      // event handlers\n      //\n      container.addEventListener('contextmenu',context_menu)\n      container.addEventListener('mousedown',mouse_down)\n      container.addEventListener('mouseup',mouse_up)\n      container.addEventListener('mousemove',mouse_move)\n      container.addEventListener('wheel',mouse_wheel)\n      //\n      // add scene\n      //\n\t   scene = new THREE.Scene()\n\t   mod.scene = scene\n\t   var width = win.innerWidth\n\t   var height = win.innerHeight\n\t   var aspect = width/height\n\t   var near = 0.1\n\t   var far = 1000000\n\t   camera = new THREE.PerspectiveCamera(90,aspect,near,far)\n\t   mod.camera = camera\n\t   scene.add(camera)\n\t   //\n\t   // add renderer\n\t   //\n      renderer = new THREE.WebGLRenderer({antialias:true})\n      mod.renderer = renderer\n      renderer.setClearColor(0xffffff)\n\t   renderer.setSize(width,height)\n\t   container.appendChild(renderer.domElement)\n      //\n      // show the path if available\n      //\n      show_path()\n      }\n   //\n   // context_menu\n   //\n   function context_menu(evt) {\n      evt.preventDefault()\n      evt.stopPropagation()\n      return (false)\n      }\n   //\n   // mouse_down\n   //\n   function mouse_down(evt) {\n      evt.preventDefault()\n      evt.stopPropagation()\n      mod.button = evt.button\n      mod.x = evt.clientX\n      mod.y = evt.clientY\n      }\n   //\n   // mouse_up\n   //\n   function mouse_up(evt) {\n      mod.button = undefined\n      mod.x = evt.clientX\n      mod.y = evt.clientY\n      }\n   //\n   // mouse_move\n   //\n   function mouse_move(evt) {\n      evt.preventDefault()\n      evt.stopPropagation()\n      var dx = evt.clientX-mod.x\n      var dy = evt.clientY-mod.y\n      mod.x = evt.clientX\n      mod.y = evt.clientY\n      if (mod.button == 0) {\n         mod.x0 += \n            Math.sin(mod.thetaz)*mod.height*dy/win.innerHeight\n            -Math.cos(mod.thetaz)*mod.width*dx/win.innerWidth\n         mod.y0 += \n            Math.cos(mod.thetaz)*mod.height*dy/win.innerHeight\n            +Math.sin(mod.thetaz)*mod.width*dx/win.innerWidth\n         camera.position.x = mod.x0+Math.sin(mod.thetaz)*mod.r*Math.sin(mod.thetaxy)\n         camera.position.y = mod.y0+Math.cos(mod.thetaz)*mod.r*Math.sin(mod.thetaxy)\n         camera.position.z = mod.r*Math.cos(mod.thetaxy)\n         camera.position.z = mod.r*Math.cos(mod.thetaxy)\n\t      camera.up = new THREE.Vector3(Math.sin(mod.thetaz),Math.cos(mod.thetaz),0)\n\t      camera.lookAt(new THREE.Vector3(mod.x0,mod.y0,0))\n         camera.updateProjectionMatrix()\n\t      renderer.render(scene,camera)\n\t      }\n      else if (mod.button == 2) {\n         mod.thetaxy += dy/win.innerHeight\n         mod.thetaz += dx/win.innerWidth\n         camera.position.x = mod.x0+Math.sin(mod.thetaz)*mod.r*Math.sin(mod.thetaxy)\n         camera.position.y = mod.y0+Math.cos(mod.thetaz)*mod.r*Math.sin(mod.thetaxy)\n         camera.position.z = mod.r*Math.cos(mod.thetaxy)\n\t      camera.up = new THREE.Vector3(Math.sin(mod.thetaz),Math.cos(mod.thetaz),0)\n\t      camera.lookAt(new THREE.Vector3(mod.x0,mod.y0,0))\n         camera.updateProjectionMatrix()\n\t      renderer.render(scene,camera)\n\t      }\n      }\n   //\n   // mouse_wheel\n   //\n   function mouse_wheel(evt) {\n      evt.preventDefault()\n      evt.stopPropagation()\n      var dy = evt.deltaY/win.innerHeight\n      mod.r += mod.height*dy\n      camera.position.x = mod.x0+Math.sin(mod.thetaz)*mod.r*Math.sin(mod.thetaxy)\n      camera.position.y = mod.y0+Math.cos(mod.thetaz)*mod.r*Math.sin(mod.thetaxy)\n      camera.position.z = mod.r*Math.cos(mod.thetaxy)\n\t   camera.lookAt(new THREE.Vector3(mod.x0,mod.y0,0))\n      camera.updateProjectionMatrix()\n\t   renderer.render(scene,camera)\n      }\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"950.9389261216435","left":"1347.360095913402","filename":"undefined","inputs":{},"outputs":{}},"0.9557599338778935":{"definition":"//\n// mill raster 2D\n//\n// Neil Gershenfeld\n// (c) Massachusetts Institute of Technology 2016\n//\n// This work may be reproduced, modified, distributed, performed, and\n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is\n// provided as is; no warranty is provided, and users accept all\n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'mill raster 2D'\n//\n// initialization\n//\nvar init = function() {\n   mod.dia_in.value = 0.0156\n   mod.dia_mm.value = 25.4*parseFloat(mod.dia_in.value)\n   mod.cut_in.value = 0.004\n   mod.cut_mm.value = 25.4*parseFloat(mod.cut_in.value)\n   mod.max_in.value = 0.004\n   mod.max_mm.value = 25.4*parseFloat(mod.max_in.value)\n   mod.number.value = 4\n   mod.stepover.value = 0.5\n   mod.merge.value = 1\n   mod.sort.checked = true\n   }\n//\n// inputs\n//\nvar inputs = {\n   imageInfo:{type:'object',\n      event:function(evt){\n         mod.name = evt.detail.name\n         mod.dpi = evt.detail.dpi\n         mod.width = evt.detail.width\n         mod.height = evt.detail.height\n         var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.width = mod.width\n         ctx.canvas.height = mod.height\n         }},\n   path:{type:'array',\n      event:function(evt){\n         if (mod.label.nodeValue == 'calculating') {\n            draw_path(evt.detail)\n            accumulate_path(evt.detail)\n            mod.offsetCount += 1\n            if ((mod.offsetCount != parseInt(mod.number.value)) && (evt.detail.length > 0)) {\n               mod.offset += parseFloat(mod.stepover.value)\n               outputs.offset.event()\n               }\n            else {\n               mod.label.nodeValue = 'calculate'\n               mod.labelspan.style.fontWeight = 'normal'\n               merge_path()\n               clear_path()\n               draw_path(mod.path)\n               draw_connections()\n               add_depth()\n               outputs.toolpath.event()\n               }\n            }\n         }\n      },\n   settings:{type:'object',\n      event:function(evt){\n         set_values(evt.detail)\n         }\n      }\n   }\n//\n// outputs\n//\nvar outputs = {\n   diameter:{type:'number',\n      event:function(){\n         mods.output(mod,'diameter',Math.ceil(mod.dpi*mod.dia_in.value))\n         }\n      },\n   offset:{type:'number',\n      event:function(){\n         var pixels = mod.offset*parseFloat(mod.dia_in.value)*mod.dpi\n         mods.output(mod,'offset',pixels)\n         }\n      },\n   toolpath:{type:'object',\n      event:function(){\n         cmd = {}\n         cmd.path = mod.path\n         cmd.name = mod.name\n         cmd.dpi = mod.dpi\n         cmd.width = mod.width\n         cmd.height = mod.height\n         cmd.depth = mod.depth\n         mods.output(mod,'toolpath',cmd)\n         }\n      }\n   }\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // tool diameter\n   //\n   div.appendChild(document.createTextNode('tool diameter'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('mm: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('input',function(){\n         mod.dia_in.value = parseFloat(mod.dia_mm.value)/25.4\n         })\n      div.appendChild(input)\n      mod.dia_mm = input\n   div.appendChild(document.createTextNode(' in: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('input',function(){\n         mod.dia_mm.value = parseFloat(mod.dia_in.value)*25.4\n         })\n      div.appendChild(input)\n      mod.dia_in = input\n   div.appendChild(document.createElement('br'))\n   //\n   // cut depth\n   //\n   div.appendChild(document.createTextNode('cut depth'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('mm: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('input',function(){\n         mod.cut_in.value = parseFloat(mod.cut_mm.value)/25.4\n         })\n      div.appendChild(input)\n      mod.cut_mm = input\n   div.appendChild(document.createTextNode(' in: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('input',function(){\n         mod.cut_mm.value = parseFloat(mod.cut_in.value)*25.4\n         })\n      div.appendChild(input)\n      mod.cut_in = input\n   div.appendChild(document.createElement('br'))\n   //\n   // max depth\n   //\n   div.appendChild(document.createTextNode('max depth'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('mm: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('input',function(){\n         mod.max_in.value = parseFloat(mod.max_mm.value)/25.4\n         })\n      div.appendChild(input)\n      mod.max_mm = input\n   div.appendChild(document.createTextNode(' in: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('input',function(){\n         mod.max_mm.value = parseFloat(mod.max_in.value)*25.4\n         })\n      div.appendChild(input)\n      mod.max_in = input\n   div.appendChild(document.createElement('br'))\n   //\n   // offset number\n   //\n   div.appendChild(document.createTextNode('offset number: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.number = input\n   div.appendChild(document.createTextNode(' (0 = fill)'))\n   div.appendChild(document.createElement('br'))\n   //\n   // offset stepover\n   //\n   div.appendChild(document.createTextNode('offset stepover: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.stepover = input\n   div.appendChild(document.createTextNode(' (1 = diameter)'))\n   div.appendChild(document.createElement('br'))\n   //\n   // direction\n   //\n   div.appendChild(document.createTextNode('direction: '))\n   div.appendChild(document.createTextNode('climb'))\n   var input = document.createElement('input')\n      input.type = 'radio'\n      input.name = mod.div.id+'direction'\n      input.id = mod.div.id+'climb'\n      input.checked = true\n      div.appendChild(input)\n      mod.climb = input\n   div.appendChild(document.createTextNode(' conventional'))\n   var input = document.createElement('input')\n      input.type = 'radio'\n      input.name = mod.div.id+'direction'\n      input.id = mod.div.id+'conventional'\n      div.appendChild(input)\n      mod.conventional = input\n   div.appendChild(document.createElement('br'))\n   //\n   // path merge\n   //\n   div.appendChild(document.createTextNode('path merge: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.merge = input\n   div.appendChild(document.createTextNode(' (1 = diameter)'))\n   div.appendChild(document.createElement('br'))\n   //\n   // path order\n   //\n   div.appendChild(document.createTextNode('path order: '))\n   div.appendChild(document.createTextNode('forward'))\n   var input = document.createElement('input')\n      input.type = 'radio'\n      input.name = mod.div.id+'order'\n      input.id = mod.div.id+'forward'\n      input.checked = true\n      div.appendChild(input)\n      mod.forward = input\n   div.appendChild(document.createTextNode(' reverse'))\n   var input = document.createElement('input')\n      input.type = 'radio'\n      input.name = mod.div.id+'order'\n      input.id = mod.div.id+'reverse'\n      div.appendChild(input)\n      mod.reverse = input\n   div.appendChild(document.createElement('br'))\n   //\n   // sort distance\n   //\n   div.appendChild(document.createTextNode('sort distance: '))\n   var input = document.createElement('input')\n      input.type = 'checkbox'\n      input.id = mod.div.id+'sort'\n      div.appendChild(input)\n      mod.sort = input\n   div.appendChild(document.createElement('br'))\n   //\n   // calculate\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      var span = document.createElement('span')\n         var text = document.createTextNode('calculate')\n            mod.label = text\n            span.appendChild(text)\n         mod.labelspan = span\n         btn.appendChild(span)\n      btn.addEventListener('click',function(){\n         mod.label.nodeValue = 'calculating'\n         mod.labelspan.style.fontWeight = 'bold'\n         mod.offset = 0.5\n         mod.offsetCount = 0\n         mod.path = []\n         clear_path()\n         outputs.diameter.event()\n         outputs.offset.event()\n         })\n      div.appendChild(btn)\n   div.appendChild(document.createTextNode(' '))\n   //\n   // view\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         var svg = document.getElementById(mod.div.id+'svg')\n         var clone = svg.cloneNode(true)\n         clone.setAttribute('width',mod.img.width)\n         clone.setAttribute('height',mod.img.height)\n         win.document.body.appendChild(clone)\n         })\n      div.appendChild(btn)\n   div.appendChild(document.createElement('br'))\n   //\n   // on-screen SVG\n   //\n   var svgNS = \"http://www.w3.org/2000/svg\"\n   var svg = document.createElementNS(svgNS,\"svg\")\n   svg.setAttribute('id',mod.div.id+'svg')\n   svg.setAttributeNS(\"http://www.w3.org/2000/xmlns/\",\n      \"xmlns:xlink\",\"http://www.w3.org/1999/xlink\")\n   svg.setAttribute('width',mods.ui.canvas)\n   svg.setAttribute('height',mods.ui.canvas)\n   svg.style.backgroundColor = 'rgb(255,255,255)'\n   var g = document.createElementNS(svgNS,'g')\n   g.setAttribute('id',mod.div.id+'g')\n   svg.appendChild(g)\n   div.appendChild(svg)\n   div.appendChild(document.createElement('br'))\n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   }\n//\n// local functions\n//\n// set_values\n//\nfunction set_values(settings) {\n   for (var s in settings) {\n      switch(s) {\n         case 'tool diameter (in)':\n            mod.dia_in.value = settings[s]\n            mod.dia_mm.value = parseFloat(mod.dia_in.value)*25.4\n            break\n         case 'cut depth (in)':\n            mod.cut_in.value = settings[s]\n            mod.cut_mm.value = parseFloat(mod.cut_in.value)*25.4\n            break\n         case 'max depth (in)':\n            mod.max_in.value = settings[s]\n            mod.max_mm.value = parseFloat(mod.max_in.value)*25.4\n            break\n         case 'offset number':\n            mod.number.value = settings[s]\n            break\n         }\n      }\n   }\n//\n// clear_path\n//\nfunction clear_path() {\n   var svg = document.getElementById(mod.div.id+'svg')\n   svg.setAttribute('viewBox',\"0 0 \"+(mod.img.width-1)+\" \"+(mod.img.height-1))\n   var g = document.getElementById(mod.div.id+'g')\n   svg.removeChild(g)\n   var g = document.createElementNS('http://www.w3.org/2000/svg','g')\n   g.setAttribute('id',mod.div.id+'g')\n   svg.appendChild(g)\n   }\n//\n// accumulate_path\n//    todo: replace inefficient insertion sort\n//    todo: move sort out of main thread\n//\nfunction accumulate_path(path) {\n   var forward = mod.forward.checked\n   var conventional = mod.conventional.checked\n   var sort = mod.sort.checked\n   for (var segnew = 0; segnew < path.length; ++segnew) {\n      if (conventional)\n         path[segnew].reverse()\n      if (mod.path.length == 0)\n         mod.path.splice(0,0,path[segnew])\n      else if (sort) {\n         var xnew = path[segnew][0][0]\n         var ynew = path[segnew][0][1]\n         var dmin = Number.MAX_VALUE\n         var segmin = -1\n         for (var segold = 0; segold < mod.path.length; ++segold) {\n            var xold = mod.path[segold][0][0]\n            var yold = mod.path[segold][0][1]\n            var dx = xnew-xold\n            var dy = ynew-yold\n            var d = Math.sqrt(dx*dx+dy*dy)\n            if (d < dmin) {\n               dmin = d\n               segmin = segold\n               }\n            }\n         if (forward)\n            mod.path.splice(segmin+1,0,path[segnew])\n         else\n            mod.path.splice(segmin,0,path[segnew])\n         }\n      else {\n         if (forward)\n            mod.path.splice(mod.path.length,0,path[segnew])\n         else\n            mod.path.splice(0,0,path[segnew])\n         }\n      }\n   }\n//\n// merge_path\n//\nfunction merge_path() {\n   var dmerge = mod.dpi*parseFloat(mod.merge.value)*parseFloat(mod.dia_in.value)\n   var seg = 0\n   while (seg < (mod.path.length-1)) {\n      var xold = mod.path[seg][mod.path[seg].length-1][0]\n      var yold = mod.path[seg][mod.path[seg].length-1][1]\n      var xnew = mod.path[seg+1][0][0]\n      var ynew = mod.path[seg+1][0][1]\n      var dx = xnew-xold\n      var dy = ynew-yold\n      var d = Math.sqrt(dx*dx+dy*dy)\n      if (d < dmerge)\n         mod.path.splice(seg,2,mod.path[seg].concat(mod.path[seg+1]))\n      else\n         seg += 1\n      }\n   }\n//\n// add_depth\n//\nfunction add_depth() {\n   var cut = parseFloat(mod.cut_in.value)\n   var max = parseFloat(mod.max_in.value)\n   var newpath = []\n   for (var seg = 0; seg < mod.path.length; ++seg) {\n      var depth = cut\n      if ((mod.path[seg][0][0] == mod.path[seg][mod.path[seg].length-1][0])\n         && (mod.path[seg][0][0] == mod.path[seg][mod.path[seg].length-1][0])) {\n         var newseg = []\n         while (depth <= max) {\n            var idepth = -Math.round(mod.dpi*depth)\n            for (var pt = 0; pt < mod.path[seg].length; ++pt) {\n               var point = mod.path[seg][pt].concat(idepth)\n               newseg.splice(newseg.length,0,point)\n               }\n            if (depth == max)\n               break\n            depth += cut\n            if (depth > max)\n               depth = max\n            }\n         newpath.splice(newpath.length,0,newseg)\n         }\n      else {\n         var newseg = []\n         while (depth <= max) {\n            var idepth = -Math.round(mod.dpi*depth)\n            for (var pt = 0; pt < mod.path[seg].length; ++pt) {\n               var point = mod.path[seg][pt].concat(idepth)\n               newseg.splice(newseg.length,0,point)\n               }\n            newpath.splice(newpath.length,0,newseg)\n            newseg = []\n            if (depth == max)\n               break\n            depth += cut\n            if (depth > max)\n               depth = max\n            }\n         }\n      }\n   mod.path = newpath\n   mod.depth = Math.round(parseFloat(mod.max_in.value)*mod.dpi)\n   }\n//\n// draw_path\n//\nfunction draw_path(path) {\n   var g = document.getElementById(mod.div.id+'g')\n   var h = mod.img.height\n   var w = mod.img.width\n   var xend = null\n   var yend = null\n   //\n   // loop over segments\n   //\n   for (var segment = 0; segment < path.length; ++segment) {\n      if (path[segment].length > 1) {\n         //\n         // loop over points\n         //\n         for (var point = 1; point < path[segment].length; ++point) {\n            var line = document.createElementNS('http://www.w3.org/2000/svg','line')\n            line.setAttribute('stroke','black')\n            line.setAttribute('stroke-width',1)\n            line.setAttribute('stroke-linecap','round')\n            var x1 = path[segment][point-1][0]\n            var y1 = h-path[segment][point-1][1]-1\n            var x2 = path[segment][point][0]\n            var y2 = h-path[segment][point][1]-1\n            xend = x2\n            yend = y2\n            line.setAttribute('x1',x1)\n            line.setAttribute('y1',y1)\n            line.setAttribute('x2',x2)\n            line.setAttribute('y2',y2)\n            var dx = x2-x1\n            var dy = y2-y1\n            var d = Math.sqrt(dx*dx+dy*dy)\n            if (d > 0) {\n               nx = 6*dx/d\n               ny = 6*dy/d\n               var tx = 3*dy/d\n               var ty = -3*dx/d\n               g.appendChild(line)\n               triangle = document.createElementNS('http://www.w3.org/2000/svg','polygon')\n               triangle.setAttribute('points',x2+','+y2+' '+(x2-nx+tx)+','+(y2-ny+ty)\n                  +' '+(x2-nx-tx)+','+(y2-ny-ty))\n               triangle.setAttribute('fill','black')\n               g.appendChild(triangle)\n               }\n            }\n         }\n      }\n   }\n//\n// draw_connections\n//\nfunction draw_connections() {\n   var g = document.getElementById(mod.div.id+'g')\n   var h = mod.img.height\n   var w = mod.img.width\n   //\n   // loop over segments\n   //\n   for (var segment = 1; segment < mod.path.length; ++segment) {\n      //\n      // draw connection from previous segment\n      //\n      var line = document.createElementNS('http://www.w3.org/2000/svg','line')\n      line.setAttribute('stroke','red')\n      line.setAttribute('stroke-width',1)\n      line.setAttribute('stroke-linecap','round')\n      var x1 = mod.path[segment-1][mod.path[segment-1].length-1][0]\n      var y1 = h-mod.path[segment-1][mod.path[segment-1].length-1][1]-1\n      var x2 = mod.path[segment][0][0]\n      var y2 = h-mod.path[segment][0][1]-1\n      line.setAttribute('x1',x1)\n      line.setAttribute('y1',y1)\n      line.setAttribute('x2',x2)\n      line.setAttribute('y2',y2)\n      var dx = x2-x1\n      var dy = y2-y1\n      var d = Math.sqrt(dx*dx+dy*dy)\n      if (d > 0) {\n         nx = 6*dx/d\n         ny = 6*dy/d\n         var tx = 3*dy/d\n         var ty = -3*dx/d\n         g.appendChild(line)\n         triangle = document.createElementNS('http://www.w3.org/2000/svg','polygon')\n         triangle.setAttribute('points',x2+','+y2+' '+(x2-nx+tx)+','+(y2-ny+ty)\n            +' '+(x2-nx-tx)+','+(y2-ny-ty))\n         triangle.setAttribute('fill','red')\n         g.appendChild(triangle)\n         }\n      }\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n\n","top":"285.15319670215206","left":"1367.9034870533305","filename":"undefined","inputs":{},"outputs":{}},"0.10309904694903338":{"definition":"//\n// vectorize\n//    input is red 128:north,64:south, green 128:east,64:west, blue 128:start,64:stop\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2016\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'vectorize'\n//\n// initialization\n//\nvar init = function() {\n   mod.error.value = 1\n   mod.sort.checked = true\n   }\n//\n// inputs\n//\nvar inputs = {\n   image:{type:'RGBA',\n      event:function(evt){\n         mod.input = evt.detail\n         var ctx = mod.img.getContext(\"2d\")\n         ctx.canvas.width = mod.input.width\n         ctx.canvas.height = mod.input.height \n         ctx.putImageData(mod.input,0,0)\n         vectorize()\n         }}}\n//\n// outputs\n//\nvar outputs = {\n   path:{type:'array',\n      event:function(){\n         mods.output(mod,'path',mod.path)\n         }}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // on-screen SVG\n   //\n   var svgNS = \"http://www.w3.org/2000/svg\"\n   var svg = document.createElementNS(svgNS,\"svg\")\n   svg.setAttribute('id',mod.div.id+'svg')\n   svg.setAttributeNS(\"http://www.w3.org/2000/xmlns/\",\n      \"xmlns:xlink\",\"http://www.w3.org/1999/xlink\")\n   svg.setAttribute('width',mods.ui.canvas)\n   svg.setAttribute('height',mods.ui.canvas)\n   svg.style.backgroundColor = 'rgb(255,255,255)'\n   var g = document.createElementNS(svgNS,'g')\n   g.setAttribute('id',mod.div.id+'g')\n   svg.appendChild(g)\n   div.appendChild(svg)\n   div.appendChild(document.createElement('br'))   \n   //\n   // off-screen image canvas\n   //\n   var canvas = document.createElement('canvas')\n      mod.img = canvas\n   //\n   // error value\n   //\n   div.appendChild(document.createTextNode('vector fit (pixels): '))\n   //div.appendChild(document.createElement('br'))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      input.addEventListener('change',function(){\n         vectorize()\n         })\n      div.appendChild(input)\n      mod.error = input\n   div.appendChild(document.createElement('br'))\n   //\n   // sort\n   //\n   div.appendChild(document.createTextNode('sort distance: '))\n   var input = document.createElement('input')\n      input.type = 'checkbox'\n      input.id = mod.div.id+'sort'\n      div.appendChild(input)\n      mod.sort = input\n   div.appendChild(document.createElement('br'))\n   //\n   // view button\n   //\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      btn.appendChild(document.createTextNode('view'))\n      btn.addEventListener('click',function(){\n         var win = window.open('')\n         var btn = document.createElement('button')\n            btn.appendChild(document.createTextNode('close'))\n            btn.style.padding = mods.ui.padding\n            btn.style.margin = 1\n            btn.addEventListener('click',function(){\n               win.close()\n               })\n            win.document.body.appendChild(btn)\n         win.document.body.appendChild(document.createElement('br'))\n         var svg = document.getElementById(mod.div.id+'svg')\n         var clone = svg.cloneNode(true)\n         clone.setAttribute('width',mod.img.width)\n         clone.setAttribute('height',mod.img.height)\n         win.document.body.appendChild(clone)\n         })\n      div.appendChild(btn)\n   }\n//\n// local functions\n//\n// vectorize\n//\nfunction vectorize() {\n   //\n   // draw path\n   //\n   function draw_path(path) {\n      window.URL.revokeObjectURL(url)\n      var svg = document.getElementById(mod.div.id+'svg')\n      svg.setAttribute('viewBox',\"0 0 \"+(mod.img.width-1)+\" \"+(mod.img.height-1))\n      var g = document.getElementById(mod.div.id+'g')\n      svg.removeChild(g)\n      var g = document.createElementNS('http://www.w3.org/2000/svg','g')\n      g.setAttribute('id',mod.div.id+'g')\n      var h = mod.img.height\n      var w = mod.img.width\n      var xend = null\n      var yend = null\n      //\n      // loop over segments\n      //\n      for (var segment in path) {\n         if (path[segment].length > 1) {\n            if (xend != null) {\n               //\n               // draw connection from previous segment\n               //\n               var line = document.createElementNS('http://www.w3.org/2000/svg','line')\n               line.setAttribute('stroke','red')\n               line.setAttribute('stroke-width',1)\n               line.setAttribute('stroke-linecap','round')\n               var x1 = xend\n               var y1 = yend\n               var x2 = path[segment][0][0]\n               var y2 = h-path[segment][0][1]-1\n               line.setAttribute('x1',x1)\n               line.setAttribute('y1',y1)\n               line.setAttribute('x2',x2)\n               line.setAttribute('y2',y2)\n               var dx = x2-x1\n               var dy = y2-y1\n               var d = Math.sqrt(dx*dx+dy*dy)\n               if (d > 0) {\n                  nx = 6*dx/d\n                  ny = 6*dy/d\n                  var tx = 3*dy/d\n                  var ty = -3*dx/d\n                  g.appendChild(line)\n                  triangle = document.createElementNS('http://www.w3.org/2000/svg','polygon')\n                  triangle.setAttribute('points',x2+','+y2+' '+(x2-nx+tx)+','+(y2-ny+ty)\n                     +' '+(x2-nx-tx)+','+(y2-ny-ty))\n                  triangle.setAttribute('fill','red')\n                  g.appendChild(triangle)\n                  }\n               }\n            //\n            // loop over points\n            //\n            for (var point = 1; point < path[segment].length; ++point) {\n               var line = document.createElementNS('http://www.w3.org/2000/svg','line')\n               line.setAttribute('stroke','black')\n               line.setAttribute('stroke-width',1)\n               line.setAttribute('stroke-linecap','round')\n               var x1 = path[segment][point-1][0]\n               var y1 = h-path[segment][point-1][1]-1\n               var x2 = path[segment][point][0]\n               var y2 = h-path[segment][point][1]-1\n               xend = x2\n               yend = y2\n               line.setAttribute('x1',x1)\n               line.setAttribute('y1',y1)\n               line.setAttribute('x2',x2)\n               line.setAttribute('y2',y2)\n               var dx = x2-x1\n               var dy = y2-y1\n               var d = Math.sqrt(dx*dx+dy*dy)\n               if (d > 0) {\n                  nx = 6*dx/d\n                  ny = 6*dy/d\n                  var tx = 3*dy/d\n                  var ty = -3*dx/d\n                  g.appendChild(line)\n                  triangle = document.createElementNS('http://www.w3.org/2000/svg','polygon')\n                  triangle.setAttribute('points',x2+','+y2+' '+(x2-nx+tx)+','+(y2-ny+ty)\n                     +' '+(x2-nx-tx)+','+(y2-ny-ty))\n                  triangle.setAttribute('fill','black')\n                  g.appendChild(triangle)\n                  }\n               }\n            }\n         }\n      svg.appendChild(g)\n      }\n   //\n   // set up worker\n   //\n   var blob = new Blob(['('+worker.toString()+'())'])\n   var url = window.URL.createObjectURL(blob)\n   var webworker = new Worker(url)\n   webworker.addEventListener('message',function(evt) {\n      window.URL.revokeObjectURL(url)\n      webworker.terminate()\n      mod.path = evt.data.path\n      draw_path(mod.path)\n      outputs.path.event()\n      })\n   //\n   // call worker\n   //\n   webworker.postMessage({\n      height:mod.input.height,width:mod.input.width,sort:mod.sort.checked,\n      error:parseFloat(mod.error.value),\n      buffer:mod.input.data.buffer})\n   }\n//\n// vectorize worker\n//\nfunction worker() {\n   self.addEventListener('message',function(evt) {\n      var h = evt.data.height\n      var w = evt.data.width\n      var sort = evt.data.sort\n      var input = new Uint8ClampedArray(evt.data.buffer)\n      var northsouth = 0\n      var north = 128\n      var south = 64\n      var eastwest = 1\n      var east = 128\n      var west = 64\n      var startstop = 2\n      var start = 128\n      var stop = 64\n      var path = []\n      //\n      // edge follower\n      //\n      function follow_edges(row,col) {\n         if ((input[(h-1-row)*w*4+col*4+northsouth] != 0)\n            || (input[(h-1-row)*w*4+col*4+eastwest] != 0)) {\n            path[path.length] = [[col,row]]\n            while (1) {\n               if (input[(h-1-row)*w*4+col*4+northsouth] & north) {\n                  input[(h-1-row)*w*4+col*4+northsouth] =\n                     input[(h-1-row)*w*4+col*4+northsouth] & ~north\n                  row += 1\n                  path[path.length-1][path[path.length-1].length] = [col,row]\n                  }\n               else if (input[(h-1-row)*w*4+col*4+northsouth] & south) {\n                  input[(h-1-row)*w*4+col*4+northsouth] =\n                     input[(h-1-row)*w*4+col*4+northsouth] & ~south\n                  row -= 1\n                  path[path.length-1][path[path.length-1].length] = [col,row]\n                  }\n               else if (input[(h-1-row)*w*4+col*4+eastwest] & east) {\n                  input[(h-1-row)*w*4+col*4+eastwest] =\n                     input[(h-1-row)*w*4+col*4+eastwest] & ~east\n                  col += 1\n                  path[path.length-1][path[path.length-1].length] = [col,row]\n                  }\n               else if (input[(h-1-row)*w*4+col*4+eastwest] & west) {\n                  input[(h-1-row)*w*4+col*4+eastwest] =\n                     input[(h-1-row)*w*4+col*4+eastwest] & ~west\n                  col -= 1\n                  path[path.length-1][path[path.length-1].length] = [col,row]\n                  }\n               else\n                  break\n               }\n            }\n         }\n      //\n      // follow boundary starts\n      //\n      for (var row = 1; row < (h-1); ++row) {\n         col = 0\n         follow_edges(row,col)\n         col = w-1\n         follow_edges(row,col)\n         }\n      for (var col = 1; col < (w-1); ++col) {\n         row = 0\n         follow_edges(row,col)\n         row = h-1      \n         follow_edges(row,col)\n         }\n      //\n      // follow interior paths\n      //\n      for (var row = 1; row < (h-1); ++row) {\n         for (var col = 1; col < (w-1); ++col) {\n            follow_edges(row,col)\n            }\n         }\n      //\n      // vectorize path\n      //\n      var error = evt.data.error\n      var vecpath = []\n      for (var seg = 0; seg < path.length; ++seg) {\n         var x0 = path[seg][0][0]\n         var y0 = path[seg][0][1]\n         vecpath[vecpath.length] = [[x0,y0]]\n         var xsum = x0\n         var ysum = y0\n         var sum = 1\n         for (var pt = 1; pt < path[seg].length; ++pt) {\n            var xold = x\n            var yold = y\n            var x = path[seg][pt][0]\n            var y = path[seg][pt][1]\n            if (sum == 1) {\n               xsum += x\n               ysum += y\n               sum += 1\n               }\n            else {\n               var xmean = xsum/sum\n               var ymean = ysum/sum\n               var dx = xmean-x0\n               var dy = ymean-y0\n               var d = Math.sqrt(dx*dx+dy*dy)\n               var nx = dy/d\n               var ny = -dx/d\n               var l = Math.abs(nx*(x-x0)+ny*(y-y0))\n               if (l < error) {\n                  xsum += x\n                  ysum += y\n                  sum += 1\n                  }\n               else {\n                  vecpath[vecpath.length-1][vecpath[vecpath.length-1].length] = [xold,yold]\n                  x0 = xold\n                  y0 = yold\n                  xsum = xold\n                  ysum = yold\n                  sum = 1\n                  }\n               }\n            if (pt == (path[seg].length-1)) {\n               vecpath[vecpath.length-1][vecpath[vecpath.length-1].length] = [x,y]\n               }\n            }\n         }\n      //\n      // sort path\n      //\n      if ((vecpath.length > 1) && (sort == true)) {\n         var dmin = w*w+h*h\n         segmin = null\n         for (var seg = 0; seg < vecpath.length; ++seg) {\n            var x = vecpath[seg][0][0]\n            var y = vecpath[seg][0][0]\n            var d = x*x+y*y\n            if (d < dmin) {\n               dmin = d\n               segmin = seg\n               }\n            }\n         if (segmin != null) {\n            var sortpath = [vecpath[segmin]]\n            vecpath.splice(segmin,1)\n            }\n         while (vecpath.length > 0) {\n            var dmin = w*w+h*h\n            var x0 = sortpath[sortpath.length-1][sortpath[sortpath.length-1].length-1][0]\n            var y0 = sortpath[sortpath.length-1][sortpath[sortpath.length-1].length-1][1]\n            segmin = null\n            for (var seg = 0; seg < vecpath.length; ++seg) {\n               var x = vecpath[seg][0][0]\n               var y = vecpath[seg][0][1]\n               var d = (x-x0)*(x-x0)+(y-y0)*(y-y0)\n               if (d < dmin) {\n                  dmin = d\n                  segmin = seg\n                  }\n               }\n            if (segmin != null) {\n               sortpath[sortpath.length] = vecpath[segmin]\n               vecpath.splice(segmin,1)\n               }\n            }\n         }\n      else if (((vecpath.length > 1) && (sort == false)) || (vecpath.length == 1))\n         sortpath = vecpath\n      else\n         sortpath = []\n      //\n      // return path\n      //\n      self.postMessage({path:sortpath})\n      })\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"650.8967007268786","left":"2102.20567221245","filename":"undefined","inputs":{},"outputs":{}},"0.3462137274004594":{"definition":"//\n// Roland SRM-20 milling machine\n//\n// Neil Gershenfeld\n// (c) Massachusetts Institute of Technology 2016\n//\n// This work may be reproduced, modified, distributed, performed, and\n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is\n// provided as is; no warranty is provided, and users accept all\n// liability.\n//\n// closure\n//\n/*\nG-codes:\nG00X10.0\nG90 (absolute positioning)\nG21 (mm units)\n#.0 numbers\nG00 (positioning rapid move)\nG01 (linear motion)\nM03 (start spindle)\nM05 (stop spindle)\nF (feed rate mm/min, 6-1800)\n203.2 (X) x 152.4 (Y) x 60.5 (Z) mm         \n*/\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'Roland SRM-20 milling machine'\n//\n// initialization\n//\nvar init = function() {\n   mod.units = 100.0\n   mod.speed.value = 4\n   mod.ox.value = 0\n   mod.oy.value = 0\n   mod.oz.value = 0\n   mod.jz.value = 2\n   mod.hx.value = 0\n   mod.hy.value = 0\n   mod.hz.value = 10\n   }\n//\n// inputs\n//\nvar inputs = {\n   toolpath:{type:'',\n      event:function(evt){\n         mod.name = evt.detail.name\n         mod.path = evt.detail.path\n         mod.dpi = evt.detail.dpi\n         mod.width = evt.detail.width\n         mod.height = evt.detail.height\n         make_path()\n         }}}\n//\n// outputs\n//\nvar outputs = {\n   file:{type:'',\n      event:function(obj){\n         mods.output(mod,'file',obj)\n         }}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // speed\n   //\n   div.appendChild(document.createTextNode('speed: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.speed = input\n   div.appendChild(document.createTextNode(' (mm/s)'))\n   div.appendChild(document.createElement('br'))\n   //\n   // origin\n   //\n   div.appendChild(document.createTextNode('origin:'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('x: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.ox = input\n   div.appendChild(document.createTextNode(' (mm)'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode(' y: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.oy = input\n   div.appendChild(document.createTextNode(' (mm)'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('z: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.oz = input\n   div.appendChild(document.createTextNode(' (mm)'))\n   div.appendChild(document.createElement('br'))\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      var span = document.createElement('span')\n         var text = document.createTextNode('move to origin')\n            span.appendChild(text)\n         btn.appendChild(span)\n      btn.addEventListener('click',function(){\n         var x0 = mod.units*parseFloat(mod.ox.value);\n         var y0 = mod.units*parseFloat(mod.oy.value);\n         var z0 = mod.units*parseFloat(mod.oz.value);\n         var zjog = z0+mod.units*parseFloat(mod.jz.value);\n         //\n         // G-code version\n         //\n         /*\n         str = '%\\n' // data start\n         str += 'G90\\n' // absolute units\n         str += 'G21\\n' // mm units\n         str += 'G00Z30.0\\n' // move z\n         str += 'M02\\n' // end of program\n         */\n         //\n         // RML version\n         //\n         var str = \"PA;PA;VS10;!VZ10;!PZ0,\"+zjog+\";PU\"+x0+\",\"+y0+\";Z\"+x0+\",\"+y0+\",\"+z0+\";!MC0;\"+\"\\u0004\"\n         //\n         // send command\n         //\n         var obj = {}\n         obj.type = 'command'\n         obj.name = mod.name+'.rml'\n         obj.contents = str\n         outputs.file.event(obj)\n         })\n      div.appendChild(btn)\n   div.appendChild(document.createElement('br'))\n   //\n   // jog\n   //\n   div.appendChild(document.createTextNode('jog height:'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('z: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.jz = input\n   div.appendChild(document.createTextNode(' (mm)'))\n   div.appendChild(document.createElement('br'))\n   //\n   // home\n   //\n   div.appendChild(document.createTextNode('home:'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('x: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.hx = input\n   div.appendChild(document.createTextNode(' (mm)'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode(' y: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.hy = input\n   div.appendChild(document.createTextNode(' (mm)'))\n   div.appendChild(document.createElement('br'))\n   div.appendChild(document.createTextNode('z: '))\n   var input = document.createElement('input')\n      input.type = 'text'\n      input.size = 6\n      div.appendChild(input)\n      mod.hz = input\n   div.appendChild(document.createTextNode(' (mm)'))\n   div.appendChild(document.createElement('br'))\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      var span = document.createElement('span')\n         var text = document.createTextNode('move to home')\n            span.appendChild(text)\n         btn.appendChild(span)\n      btn.addEventListener('click',function(){\n         var xhome = mod.units*parseFloat(mod.hx.value);\n         var yhome = mod.units*parseFloat(mod.hy.value);\n         var zhome = mod.units*parseFloat(mod.hz.value);\n         //\n         // G-code version\n         //\n         /*\n         str = '%\\n' // data start\n         str += 'G90\\n' // absolute units\n         str += 'G21\\n' // mm units\n         str += 'G00Z50.0\\n' // move z\n         str += 'M02\\n' // end of program\n         */\n         //\n         // RML version\n         //\n         var str = \"PA;PA;!PZ0,\"+zhome+\";PU\"+xhome+\",\"+yhome+\";!MC0;\"+\"\\u0004\"\n         //\n         // send command\n         //\n         var obj = {}\n         obj.type = 'command'\n         obj.name = mod.name+'.rml'\n         obj.contents = str\n         outputs.file.event(obj)\n         })\n      div.appendChild(btn)\n   div.appendChild(document.createElement('br'))\n   }\n//\n// local functions\n//\nfunction make_path() {\n   var dx = 25.4*mod.width/mod.dpi\n   var nx = mod.width\n   var speed = parseFloat(mod.speed.value)\n   var jog = parseFloat(mod.oz.value)+parseFloat(mod.jz.value)\n   var ijog = Math.floor(mod.units*jog)\n   var scale = mod.units*dx/(nx-1)\n   var x0 = parseFloat(mod.ox.value)\n   var y0 = parseFloat(mod.oy.value)\n   var z0 = parseFloat(mod.oz.value)\n   var xoffset = mod.units*x0\n   var yoffset = mod.units*y0\n   var zoffset = mod.units*z0\n   var str = \"PA;PA;\" // plot absolute\n   str += \"VS\"+speed+\";!VZ\"+speed+\";\"\n   str += \"!PZ\"+0+\",\"+ijog+\";\" // set jog\n   str += \"!MC1;\\n\" // turn motor on\n   //\n   // follow segments\n   //\n   for (var seg = 0; seg < mod.path.length; ++seg) {\n      //\n      // move up to starting point\n      //\n      x = xoffset+scale*mod.path[seg][0][0]\n      y = yoffset+scale*mod.path[seg][0][1]\n      str += \"PU\"+x.toFixed(0)+\",\"+y.toFixed(0)+\";\\n\"\n      //\n      // move down\n      //\n      z = zoffset+scale*mod.path[seg][0][2]\n      str += \"Z\"+x.toFixed(0)+\",\"+y.toFixed(0)+\",\"+z.toFixed(0)+\";\\n\"\n      for (var pt = 1; pt < mod.path[seg].length; ++pt) {\n         //\n         // move to next point\n         //\n         x = xoffset+scale*mod.path[seg][pt][0]\n         y = yoffset+scale*mod.path[seg][pt][1]\n         z = zoffset+scale*mod.path[seg][pt][2]\n         str += \"Z\"+x.toFixed(0)+\",\"+y.toFixed(0)+\",\"+z.toFixed(0)+\";\\n\"\n         }\n      //\n      // move up\n      //\n      str += \"PU\"+x.toFixed(0)+\",\"+y.toFixed(0)+\";\\n\"\n      }\n   //\n   // turn off motor and move back\n   //\n   var xhome = mod.units*parseFloat(mod.hx.value)\n   var yhome = mod.units*parseFloat(mod.hy.value)\n   var zhome = mod.units*parseFloat(mod.hz.value)\n   str += \"PA;PA;!PZ0,\"+zhome+\";PU\"+xhome+\",\"+yhome+\";!MC0;\"\n   //\n   // output string\n   //\n   var obj = {}\n   obj.type = 'file'\n   obj.name = mod.name+'.rml'\n   obj.contents = str\n   outputs.file.event(obj)\n   }\n//\n// return values\n//\nreturn ({\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"1432.672000861046","left":"630.6084971761834","filename":"undefined","inputs":{},"outputs":{}},"0.3125355827058147":{"definition":"//\n// on-off module\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2020\n// Modified by Francisco Sanchez Arroyo 27-March-2022\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function() {\n    //\n    // module globals\n    //\n    var mod = {}\n    //\n    // name\n    //\n    var name = 'on/off'\n    //\n    // initialization\n    //\n    var init = function() {}\n    //\n    // inputs\n    //\n    var inputs = {\n        in: {\n            type: '',\n            event: function(evt) {\n                outputs.out.event(evt.detail)\n            }\n        }\n    }\n    //\n    // outputs\n    //\n    var outputs = {\n        out: {\n            type: '',\n            event: function(obj) {\n               checkSwitch(obj)\n            }\n        }\n    }\n    //\n    // interface\n    //\n    var interface = function(div) {\n        mod.div = div\n        var label = document.createElement('label')\n        label.className = 'switch'\n        var input = document.createElement('input')\n        input.type = 'checkbox'\n        input.checked = false\n        label.appendChild(input)\n        mod.switch = input\n        var span = document.createElement('span')\n        span.className = 'slider round'\n        label.appendChild(span)\n        div.appendChild(label)\n    }\n    //\n    // local functions\n    //\n\n    // switch\n    function checkSwitch(obj) {\n    if (mod.switch.checked) {\n       mods.output(mod, 'out', obj)\n    }\n    }\n\n\n    //\n    // return values\n    //\n    return ({\n        mod: mod,\n        name: name,\n        init: init,\n        inputs: inputs,\n        outputs: outputs,\n        interface: interface\n    })\n}())\n","top":"1433.5302170896962","left":"1031.075170995943","filename":"modules/module/create","inputs":{},"outputs":{}},"0.7956498224603841":{"definition":"//\n// save file\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2016\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'save file'\n//\n// initialization\n//\nvar init = function() {\n   }\n//\n// inputs\n//\nvar inputs = {\n   file:{type:'object',\n      event:function(evt){\n         mod.name = evt.detail.name\n         mod.contents = evt.detail.contents\n         save_file()\n         }}}\n//\n// outputs\n//\nvar outputs = {}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // info\n   //\n   var text = document.createTextNode('name:')\n      div.appendChild(text)\n      mod.nametext = text\n   div.appendChild(document.createElement('br'))\n   var text = document.createTextNode('size:')\n      div.appendChild(text)\n      mod.sizetext = text\n   div.appendChild(document.createElement('br'))\n   }\n//\n// local functions\n//\nfunction save_file() {\n   var a = document.createElement('a')\n   a.setAttribute('href','data:text/plain;charset=utf-8,'+ \n      encodeURIComponent(mod.contents))\n   a.setAttribute('download',mod.name)\n   a.style.display = 'none'\n   document.body.appendChild(a)\n   a.click()\n   document.body.removeChild(a)\n   mod.nametext.nodeValue = 'name: '+mod.name\n   mods.fit(mod.div)\n   mod.sizetext.nodeValue = 'size: '+mod.contents.length\n   mods.fit(mod.div)\n   }\n//\n// return values\n//\nreturn ({\n   mod:mod,\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"1437.7859597729944","left":"1377.3460008736329","filename":"modules/file/save","inputs":{},"outputs":{}},"0.992472539363189":{"definition":"//\n// set object\n//\n// Neil Gershenfeld\n// (c) Massachusetts Institute of Technology 2018\n//\n// This work may be reproduced, modified, distributed, performed, and\n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is\n// provided as is; no warranty is provided, and users accept all\n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'set PCB defaults'\n//\n// initialization\n//\nvar init = function() {\n   //\n   add_output('mill traces (1/64)')\n   add_variable('tool diameter (in)','var00')\n   mod.var00.value = '0.0156'\n   add_variable('cut depth (in)','var01')\n   mod.var01.value = '0.004'\n   add_variable('max depth (in)','var02')\n   mod.var02.value = '0.004'\n   add_variable('offset number','var03')\n   mod.var03.value = '1'\n   //\n   add_output('mill outline (1/32)')\n   add_variable('tool diameter (in)','var10')\n   mod.var10.value = '0.0312'\n   add_variable('cut depth (in)','var11')\n   mod.var11.value = '0.022'\n   add_variable('max depth (in)','var12')\n   mod.var12.value = '0.065'\n   add_variable('offset number','var13')\n   mod.var13.value = '1'\n   //\n   add_output('remove copper (1/32)')\n   add_variable('tool diameter (in)','var15')\n   mod.var15.value = '0.0312'\n   add_variable('cut depth (in)','var16')\n   mod.var16.value = '0.004'\n   add_variable('max depth (in)','var17')\n   mod.var17.value = '0.004'\n   add_variable('offset number','var18')\n   mod.var18.value = '1'\n   //\n   add_output('remove copper (1/16)')\n   add_variable('tool diameter (in)','var20')\n   mod.var20.value = '0.0624'\n   add_variable('cut depth (in)','var21')\n   mod.var21.value = '0.004'\n   add_variable('max depth (in)','var22')\n   mod.var22.value = '0.004'\n   add_variable('offset number','var23')\n   mod.var23.value = '1'\n   //\n   add_output('remove copper (1/8)')\n   add_variable('tool diameter (in)','var30')\n   mod.var30.value = '0.1248'\n   add_variable('cut depth (in)','var31')\n   mod.var31.value = '0.004'\n   add_variable('max depth (in)','var32')\n   mod.var32.value = '0.004'\n   add_variable('offset number','var33')\n   mod.var33.value = '5'\n   //\n   }\n//\n// inputs\n//\nvar inputs = {}\n//\n// outputs\n//\nvar outputs = {\n   settings:{type:'',\n      event:function(vars){\n         mods.output(mod,'settings',vars)\n         }\n      }\n   }\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   }\n//\n// local functions\n//\nfunction add_output(label) {\n   if (mod.settings == undefined) {\n      mod.settings = {}\n      }\n   var btn = document.createElement('button')\n      btn.style.padding = mods.ui.padding\n      btn.style.margin = 1\n      var span = document.createElement('span')\n      var text = document.createTextNode(label)\n         span.appendChild(text)\n      btn.appendChild(span)\n      var f = function(label) {\n         btn.addEventListener('click',function() {\n            for (var s in mod.settings)\n               mod.settings[s].span.style.fontWeight = 'normal'\n            mod.settings[label].span.style.fontWeight = 'bold'\n            var vars = {}\n            for (var v in mod.settings[label].variables)\n               vars[v] = mod.settings[label].variables[v].value\n            outputs.settings.event(vars)\n            })\n         }(label)\n      mod.settings[label] = {span:span,variables:{}}\n      mod.div.appendChild(btn)\n      mod.setting = label\n   mod.div.appendChild(document.createElement('br'))\n   }\nfunction add_variable(label,variable) {\n   var text = document.createTextNode(label)\n      mod.div.appendChild(text)\n   mod.div.appendChild(document.createTextNode(': '))\n   input = document.createElement('input')\n      input.type = 'text'\n      input.size = 10\n      mod[variable] = input\n      mod.div.appendChild(input)\n   mod.settings[mod.setting].variables[label] = input \n   mod.div.appendChild(document.createElement('br'))\n   }\n//\n// return values\n//\nreturn ({\n   mod:mod,\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"646.4708802786513","left":"710.7395468834948","filename":"undefined","inputs":{},"outputs":{}},"0.8733435255225428":{"definition":"//\n// image size\n//\n// Neil Gershenfeld \n// (c) Massachusetts Institute of Technology 2015,6\n// \n// This work may be reproduced, modified, distributed, performed, and \n// displayed for any purpose, but must acknowledge the mods\n// project. Copyright is retained and must be preserved. The work is \n// provided as is; no warranty is provided, and users accept all \n// liability.\n//\n// closure\n//\n(function(){\n//\n// module globals\n//\nvar mod = {}\n//\n// name\n//\nvar name = 'image size'\n//\n// initialization\n//\nvar init = function() {\n   mod.dpitext.value = '1000'\n   }\n//\n// inputs\n//\nvar inputs = {\n   image:{type:'RGBA',\n      event:function(evt){\n         mod.input = evt.detail\n         mod.pxtext.nodeValue = mod.input.width+' x '+mod.input.height+' px'\n         mod.dpi = parseFloat(mod.dpitext.value)\n         mod.mmtext.nodeValue = (25.4*mod.input.width/mod.dpi).toFixed(3)\n            +' x '+(25.4*mod.input.height/mod.dpi).toFixed(3)+' mm'\n         mod.intext.nodeValue = (mod.input.width/mod.dpi).toFixed(3)\n            +' x '+(mod.input.height/mod.dpi).toFixed(3)+' in'\n         mods.fit(mod.div)\n         outputs.image.event()\n         outputs.imageInfo.event()\n         }}}\n//\n// outputs\n//\nvar outputs = {\n   image:{type:'RGBA',\n      event:function(){\n         mods.output(mod,'image',mod.input)}},\n   imageInfo:{type:'object',\n      event:function(){\n         var obj = {}\n         obj.name = \"image\"\n         obj.dpi = parseFloat(mod.dpitext.value)\n         obj.width = mod.input.width\n         obj.height = mod.input.height\n         mods.output(mod,'imageInfo',obj)}}}\n//\n// interface\n//\nvar interface = function(div){\n   mod.div = div\n   //\n   // info div\n   //\n   var info = document.createElement('div')\n      info.setAttribute('id',div.id+'info')\n      info.appendChild(document.createTextNode('dpi: '))\n      var input = document.createElement('input')\n         input.type = 'text'\n         input.size = 6\n         input.addEventListener('input',function(){\n            mod.dpi = parseFloat(mod.dpitext.value)\n            mod.mmtext.nodeValue = (25.4*mod.input.width/mod.dpi).toFixed(3)\n               +' x '+(25.4*mod.input.height/mod.dpi).toFixed(3)+' mm'\n            mod.intext.nodeValue = (mod.input.width/mod.dpi).toFixed(3)\n               +' x '+(mod.input.height/mod.dpi).toFixed(3)+' in'\n            mods.fit(mod.div)\n            outputs.imageInfo.event()\n            })\n         info.appendChild(input)\n         mod.dpitext = input\n      info.appendChild(document.createElement('br'))\n      var text = document.createTextNode('px')\n         info.appendChild(text)\n         mod.pxtext = text\n      info.appendChild(document.createElement('br'))\n      var text = document.createTextNode('mm')\n         info.appendChild(text)\n         mod.mmtext = text\n      info.appendChild(document.createElement('br'))\n      var text = document.createTextNode('in')\n         info.appendChild(text)\n         mod.intext = text\n      div.appendChild(info)\n   }\n//\n// local functions\n//\n;\n//\n// return values\n//\nreturn ({\n   mod:mod,\n   name:name,\n   init:init,\n   inputs:inputs,\n   outputs:outputs,\n   interface:interface\n   })\n}())\n","top":"42.00403199039502","left":"1006.4606353611589","filename":"modules/image/size","inputs":{},"outputs":{}}},"links":["{\"source\":\"{\\\"id\\\":\\\"0.07944144280928633\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"image\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.8903773266711255\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"image\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.47383876715576023\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"distances\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.3135579179893032\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"distances\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.3135579179893032\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"image\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.07944144280928633\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"image\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.08127540142793499\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"image\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.6488303557466412\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"image\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.6488303557466412\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"image\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.47383876715576023\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"image\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.9557599338778935\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"offset\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.3135579179893032\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"offset\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.9557599338778935\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"toolpath\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.2892270043957246\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"toolpath\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.8903773266711255\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"image\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.10309904694903338\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"image\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.10309904694903338\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"path\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.9557599338778935\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"path\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.9557599338778935\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"toolpath\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.3462137274004594\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"toolpath\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.3462137274004594\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"file\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.3125355827058147\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"in\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.3125355827058147\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"out\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.7956498224603841\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"file\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.992472539363189\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"settings\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.9557599338778935\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"settings\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.6488303557466412\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"image\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.8733435255225428\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"image\\\"}\"}","{\"source\":\"{\\\"id\\\":\\\"0.8733435255225428\\\",\\\"type\\\":\\\"outputs\\\",\\\"name\\\":\\\"imageInfo\\\"}\",\"dest\":\"{\\\"id\\\":\\\"0.9557599338778935\\\",\\\"type\\\":\\\"inputs\\\",\\\"name\\\":\\\"imageInfo\\\"}\"}"]}))
window.mods_prog_load(prog)
</script>
</body>
</html>
